**æ®µè½ 1ï¼ˆé‡æ–°è§„åˆ’ï¼‰ï¼šåœ¨ _Gateway_Rust_ ç°æœ‰ä»£ç åŸºç¡€ä¸Šï¼Œå¢é‡å¼•å…¥ **`web-gw-api`** ä¸ Vue å‰ç«¯ï¼Œå®Œæˆä»â€œè£¸ç½‘å…³â€åˆ°â€œæµè§ˆå™¨å¯é…ç½®ç½‘å…³â€çš„æœ€å°é—­ç¯**

> ç›®æ ‡ï¼š**ä¸æ”¹åŠ¨** æ—¢æœ‰é‡‡é›†é“¾è·¯ï¼ˆframe-busã€driver-managerã€mqtt5 ç­‰ï¼‰ï¼Œåªå¢é‡æ·»åŠ  **Actix-Web HTTP+WS æœåŠ¡** ä¸ **Vue 3 å‰ç«¯**ï¼Œè®©ç°åœºå·¥ç¨‹å¸ˆé€šè¿‡ç½‘é¡µå®Œæˆ **â€œè®¾å¤‡-â†’-ç‚¹ä½-â†’-é©±åŠ¨â€ å…¨æµç¨‹é…ç½®ä¸å®æ—¶ç›‘æ§**ã€‚ä¸‹æ–‡çš„è·¯å¾„å‡ç›¸å¯¹äºä»“åº“æ ¹ç›®å½•ï¼›ä»£ç ç‰‡æ®µå¯ç›´æ¥ç²˜è´´ã€‚

---

### 1-Aï¼å¢é‡ç›®å½•ç»“æ„

```
Gateway_Rust/
â”œâ”€ core/
â”‚  â”œâ”€ driver-manager/         # å·²å­˜åœ¨
â”‚  â”œâ”€ frame-bus/              # å·²å­˜åœ¨
â”‚  â””â”€ web-gw-api/             # â• æ–° crateï¼ˆActix æœåŠ¡ï¼Œbinï¼‰
â”‚      â”œâ”€ src/
â”‚      â”‚   â”œâ”€ main.rs
â”‚      â”‚   â”œâ”€ bootstrap.rs    // è¯»å–é…ç½® + DI
â”‚      â”‚   â”œâ”€ config.rs       // è¯¦è§ 1-B
â”‚      â”‚   â”œâ”€ dto.rs          // Web å¯è§ç»“æ„ä½“
â”‚      â”‚   â”œâ”€ routes/         // devices.rs tags.rs drivers.rs telemetry_ws.rs health.rs
â”‚      â”‚   â””â”€ error.rs
â”‚      â””â”€ Cargo.toml
â”œâ”€ web-ui/                    # â• Vue 3 + Vite + TS
â”‚  â”œâ”€ package.json            // è§ 1-G
â”‚  â””â”€ src/
â”‚      â”œâ”€ api/                // axios å°è£…
â”‚      â”œâ”€ stores/             // Pinia
â”‚      â”œâ”€ components/
â”‚      â””â”€ pages/
â”‚          â”œâ”€ Device.vue
â”‚          â”œâ”€ Tag.vue
â”‚          â”œâ”€ Driver.vue
â”‚          â””â”€ Dashboard.vue
â””â”€ schema/
    â””â”€ migrations/            # å·²æœ‰ï¼Œæ–°å¢ 0003_xxx.sql å»ºè®¾å¤‡ & ç‚¹ä½è¡¨
```

- **Cargo workspace**ï¼šåœ¨æ ¹ `Cargo.toml` è¿½åŠ  `"core/web-gw-api"` åˆ° `[workspace] members]`ã€‚

- **Docker**ï¼šé¡¶å±‚ `docker-compose.yml` æ–°å¢ `web-gw-api` æœåŠ¡ï¼›å‰ç«¯ç”± Nginx é™æ€æ‰˜ç®¡æˆ– Vite Dev Serverï¼Œæœ¬æ®µåªç»™éª¨æ¶ã€‚


---

### 1-Bï¼è¿è¡Œæ—¶é…ç½®ç»“æ„ `config.rs`

```rust
#[derive(Debug, serde::Deserialize, Clone)]
pub struct ApiCfg {
    /// HTTP ç›‘å¬, é»˜è®¤ 0.0.0.0:8080
    pub http_addr:      std::net::SocketAddr,
    /// WebSocket è·¯å¾„, é»˜è®¤ "/ws"
    pub ws_path:        String,
    /// å…è®¸çš„å‰ç«¯æºï¼Œæ”¯æŒé€šé…
    pub cors_allowed:   Vec<String>,
    /// PostgreSQL DSNï¼ˆå…ƒæ•°æ®ï¼šè®¾å¤‡ã€ç‚¹ä½ï¼‰
    pub pg_dsn:         String,
    /// InfluxDB base url
    pub influx_url:     String,
    /// æ¡†æ¶å†…éƒ¨æ€»çº¿ addrï¼ˆnats://ï¼‰
    pub bus_url:        String,
    /// é©±åŠ¨ç›®å½•æ ¹
    pub drivers_dir:    std::path::PathBuf,
    /// log level
    pub log_level:      String,
}
```

_é…ç½®åŠ è½½é¡ºåº_

1. è¯»å– `config/default.yaml â†’ config/{ENV}.yaml`

2. `ENV` å˜é‡è¦†ç›–ï¼ˆå½¢å¦‚ `WEBGW_HTTP_ADDR=0.0.0.0:9000`ï¼‰


---

### 1-Cï¼`main.rs` æœ€å°å¯è¿è¡Œç¤ºä¾‹

```rust
#[actix_web::main]
async fn main() -> anyhow::Result<()> {
    use actix_web::{App, HttpServer, middleware::Logger};
    tracing_subscriber::fmt::init();

    let cfg = bootstrap::load_cfg()?;
    let state = bootstrap::init_state(&cfg).await?;

    HttpServer::new(move || {
        App::new()
            .app_data(state.clone())
            .wrap(Logger::default())
            .wrap(state.cors())
            .configure(routes::register)      // è£…é…æ‰€æœ‰è·¯ç”±
    })
    .bind(cfg.http_addr)?
    .run()
    .await?;
    Ok(())
}
```

---

### 1-Dï¼æ ¸å¿ƒæ•°æ®æ¨¡å‹ï¼ˆ`dto.rs` æ‘˜è¦ï¼‰

```rust
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct Device {
    pub id:          Uuid,
    pub name:        String,
    pub protocol:    ProtocolKind,   // ModbusTcp|OpcUa|Mqtt
    pub location:    Option<String>,
    pub created_at:  DateTime<Utc>,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct TagPoint {
    pub id:         Uuid,
    pub device_id:  Uuid,
    pub address:    String,          // "40001"
    pub data_type:  TagDataType,     // Float|Int|Bool|String
    pub scaling:    Option<f64>,
    pub unit:       Option<String>,
}
```

> **çº¦å®š**ï¼šæ‰€æœ‰å‰ç«¯/åç«¯äº¤äº’ JSON å‡é‡‡ç”¨ `snake_case`ï¼›`ProtocolKind` & `TagDataType` æ˜ å°„ PG æšä¸¾ç±»å‹ï¼Œè¯¦è§è¿ç§»è„šæœ¬ã€‚

---

### 1-Eï¼HTTP & WS æ¥å£ä¸€è§ˆï¼ˆMVP 3-4 å¿…è¾¾ï¼‰

|Method|Path|æè¿°|Handler|
|---|---|---|---|
|`GET`|`/api/v1/health`|æ´»æ€§æ¢é’ˆ|`health::live`|
|`POST`|`/api/v1/devices`|æ–°å¢è®¾å¤‡|`devices::create`|
|`GET`|`/api/v1/devices`|åˆ†é¡µåˆ—è¡¨|`devices::list`|
|`GET`|`/api/v1/devices/{id}`|è¯¦æƒ…|`devices::get`|
|`PUT`|`/api/v1/devices/{id}`|æ›´æ–°|`devices::update`|
|`DELETE`|`/api/v1/devices/{id}`|åˆ é™¤|`devices::delete`|
|`GET`|`/api/v1/tags`|æ¡ä»¶æŸ¥è¯¢|`tags::list`|
|`POST`|`/api/v1/tags`|æ–°å¢ç‚¹ä½|`tags::create`|
|`WS`|`/ws/telemetry`|å®æ—¶æ•°æ®æµ|`telemetry_ws::connect`|
|`GET`|`/api/v1/drivers`|é©±åŠ¨åˆ—è¡¨|`drivers::list`|
|`POST`|`/api/v1/drivers/upload`|ä¸Šä¼ +åŠ è½½é©±åŠ¨|`drivers::upload`|
|`POST`|`/api/v1/drivers/{protocol}/reload`|çƒ­é‡è½½|`drivers::reload`|
|`DELETE`|`/api/v1/drivers/{protocol}`|å¸è½½|`drivers::unload`|

âš  **æš‚ä¸åŒ…å«èº«ä»½é‰´æƒ** â€”â€” å…¨éƒ¨è·¯ç”±åœ¨å†…ç½‘å¼€æ”¾ï¼›ä¸Šçº¿å‰å¯å†æ¥å…¥ JWT/RBACï¼ˆå¦èµ·æ®µè½ï¼‰ã€‚

---

### 1-Fï¼æ•°æ®åº“è¿ç§» (PostgreSQL)

`schema/migrations/0003_init_device_tag.sql`

```sql
CREATE TYPE protocol_kind AS ENUM ('ModbusTcp','OpcUa','Mqtt');
CREATE TYPE tag_data_type AS ENUM ('Float','Int','Bool','String');

CREATE TABLE devices (
    id          UUID PRIMARY KEY,
    name        VARCHAR(64) NOT NULL,
    protocol    protocol_kind NOT NULL,
    location    VARCHAR(128),
    created_at  TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE TABLE tags (
    id          UUID PRIMARY KEY,
    device_id   UUID NOT NULL REFERENCES devices(id) ON DELETE CASCADE,
    address     VARCHAR(32) NOT NULL,
    data_type   tag_data_type NOT NULL,
    scaling     DOUBLE PRECISION,
    unit        VARCHAR(16)
);
CREATE INDEX idx_tags_device ON tags(device_id);
```

> **â˜‘ TODO DB-1** â€” å°†è„šæœ¬å†™å…¥å¹¶æ‰§è¡Œ `cargo sqlx migrate run`ï¼›CI æ­¥éª¤ `cargo sqlx prepare --check` ç¡®ä¿æŸ¥è¯¢ä¸ DDL ä¸€è‡´ã€‚

---

### 1-Gï¼å‰ç«¯ `package.json` æ ¸å¿ƒå­—æ®µ

```jsonc
{
  "name": "iot-web-ui",
  "scripts": {
    "dev": "vite --open",
    "build": "vite build",
    "lint": "eslint src --ext .vue,.ts",
    "preview": "vite preview"
  },
  "dependencies": {
    "vue": "^3.5.0",
    "pinia": "^2.1.5",
    "vue-router": "^4.3.0",
    "axios": "^1.7.0",
    "echarts": "^5.5.0"
  },
  "devDependencies": {
    "typescript": "^5.4.0",
    "vite": "^5.0.0",
    "@vitejs/plugin-vue": "^5.0.0",
    "@vue/eslint-config-typescript": "^12.0.0",
    "eslint": "^9.0.0"
  }
}
```

- **Axios å…¨å±€å°è£…** `src/api/http.ts`ï¼šBaseURL = `import.meta.env.VITE_API_BASE`ï¼›è¯·æ±‚æ·»åŠ  `Content-Type: application/json`ï¼Œæ— é‰´æƒã€‚

- **WebSocket** `src/api/ws.ts`ï¼š`new WebSocket(`${VITE_WS_BASE}/telemetry?device_id=${id}`)`ã€‚


---

### 1-Hï¼é¡¶å±‚ `Makefile`ï¼ˆå‰ªè£ç‰ˆï¼‰

```makefile
# è¿è¡Œåç«¯ + å‰ç«¯çƒ­é‡è½½
dev:
	@cargo run -p web-gw-api --features dev &
	@npm --prefix web-ui run dev

fmt:
	@cargo fmt --all
	@npm --prefix web-ui run lint -- --fix

test:
	@cargo test -p web-gw-api
	@npm --prefix web-ui run test:unit
```

---

### 1-Iï¼Claude Code æ‰§è¡Œ Checklistï¼ˆæ®µè½ 1 ä¸“å±ï¼‰

1. **åˆ›å»º crate** `cargo new core/web-gw-api --bin` å¹¶å¡«å…… _main.rs / bootstrap.rs / routes/_ æ–‡ä»¶ã€‚

2. **ä¿®æ”¹ workspace** åŠ å…¥æ–° crateï¼›æ‰§è¡Œ `cargo check`.

3. **å†™è¿ç§»è„šæœ¬** _DB-1_ å¹¶ `sqlx migrate run`.

4. **ç”Ÿæˆ Vue é¡¹ç›®** `npm create vue@latest web-ui` â†’ æ›¿æ¢ `package.json` ä¾èµ–ï¼›é…ç½® `vite.config.ts` `proxy` æŒ‡åˆ° `http://localhost:8080`.

5. **å®ç°é¦–æ‰¹ Handler**ï¼ˆhealth & devices listï¼‰è¿”å› mock JSONï¼›å‰ç«¯é€šè¿‡ Axios æˆåŠŸæ‹‰å–å¹¶è¡¨æ ¼å±•ç¤ºã€‚

6. **GitHub Actions**ï¼šRust + Node åŒæµæ°´çº¿å‡ç»¿ã€‚


å®Œæˆæ®µè½ 1 åï¼Œä½ å°†å¾—åˆ°ï¼š

- **å¯ç¼–è¯‘è¿è¡Œ** çš„ Actix æœåŠ¡ï¼ˆä»…æ ¸å¿ƒè·¯ç”±å ä½ï¼‰ï¼›

- **æ•°æ®åº“è¡¨**ï¼šè®¾å¤‡ã€ç‚¹ä½å·²å»ºï¼›

- **Vue å‰ç«¯**ï¼šæ‰“å¼€ `http://localhost:5173` èƒ½æ˜¾ç¤ºâ€œè®¾å¤‡åˆ—è¡¨ (mock)â€ï¼›

- **ä¸€é”®è„šæœ¬**ï¼š`make dev` åŒæ—¶çƒ­é‡è½½å‰åç«¯ã€‚


---
**æ®µè½ 2ï¼šè®¾å¤‡ / ç‚¹ä½ REST + WebSocket å®Œæ•´å®ç°ã€Driver-Manager è”åŠ¨ä¸å‰ç«¯é¡µé¢äº¤äº’è§„èŒƒ**

> æœ¬æ®µè®©â€œç½‘é¡µå¯é…ç½®ç½‘å…³â€çœŸæ­£è·‘é€šï¼š**åç«¯**å¯å¢åˆ æ”¹æŸ¥è®¾å¤‡ä¸ç‚¹ä½å¹¶å³æ—¶æ›´æ–°é©±åŠ¨ï¼Œ**å‰ç«¯**å¯é€šè¿‡è¡¨å•ç®¡ç†æ•°æ®å¹¶å®æ—¶æŸ¥çœ‹æ›²çº¿ã€‚ä»£ç é‡ç›´æ¥å¯ç”¨ï¼›Claude Code é€æ¡ â˜‘ TODO è½åœ°åå³å¯çœ‹åˆ°ç«¯åˆ°ç«¯æ•ˆæœã€‚

---

## 2-Aâ€ƒåç«¯è·¯ç”±æ€»è§ˆ & æ³¨å†Œ

_æ–‡ä»¶_ `core/web-gw-api/src/routes/mod.rs`

```rust
pub fn register(cfg: &mut actix_web::web::ServiceConfig) {
    cfg.service(health::scope())
       .service(devices::scope())
       .service(tags::scope())
       .service(drivers::scope())
       .service(telemetry_ws::scope());
}
```

|æ¨¡å—|è·¯å¾„å‰ç¼€|ä¾èµ–|
|---|---|---|
|health.rs|`/health`|æ— |
|devices.rs|`/devices`|`DeviceRepo`, `DriverManager`|
|tags.rs|`/tags`|`TagRepo`, `DeviceRepo`|
|drivers.rs|`/drivers`|`DriverManager`|
|telemetry_ws.rs|`/ws/telemetry`|`FrameBus`|

---

## 2-Bâ€ƒä»“å‚¨å±‚ Repo ç»†èŠ‚

> ç”¨ **sqlx**ï¼›Trait åœ¨ `core/infra-repo/`ï¼Œå®ç°æ³¨å…¥åˆ° `AppState`.

### 2-B-1 DeviceRepo

```rust
#[async_trait::async_trait]
pub trait DeviceRepo {
    async fn create(&self, dto: NewDevice) -> Result<Device>;
    async fn update(&self, id: Uuid, dto: DevicePatch) -> Result<Option<Device>>;
    async fn delete(&self, id: Uuid) -> Result<()>;
    async fn list(&self, limit:i64, offset:i64) -> Result<Vec<Device>>;
    async fn get(&self, id: Uuid) -> Result<Option<Device>>;
}
```

**â˜‘ TODO BE-1** â€” åœ¨ `infra/pg_repo/device.rs` å®ç°æ‰€æœ‰æ–¹æ³•å¹¶æ·»åŠ å•å…ƒæµ‹è¯•ã€‚

### 2-B-2 TagRepo

```rust
#[async_trait::async_trait]
pub trait TagRepo {
    async fn create(&self, dto: NewTag) -> Result<TagPoint>;
    async fn list_by_device(&self, device_id:Uuid) -> Result<Vec<TagPoint>>;
    async fn delete(&self, id:Uuid) -> Result<()>;
}
```

**â˜‘ TODO BE-2** â€” å®ç°å¹¶æµ‹è¯•ã€‚

---

## 2-Câ€ƒè®¾å¤‡ Handler ç¤ºä¾‹ï¼ˆ`routes/devices.rs`ï¼‰

```rust
pub fn scope() -> Scope {
    web::scope("/devices")
        .route("", web::post().to(create))
        .route("", web::get().to(list))
        .route("/{id}", web::get().to(get))
        .route("/{id}", web::put().to(update))
        .route("/{id}", web::delete().to(delete))
}

async fn create(
    data: Data<AppState>,
    req: Json<DeviceCreateReq>,
) -> Result<impl Responder, ApiError> {
    let dev = data.device_repo.create(req.into_inner()).await?;
    // æ³¨å†Œé©±åŠ¨
    data.drivers.register(dev.protocol, dev.id).await?;
    Ok(HttpResponse::Created().json(DeviceVO::from(dev)))
}
```

- **æ›´æ–°**ï¼šä¿®æ”¹ `protocol` æ—¶éœ€ `drivers.reload(proto)`ï¼›å…¶ä½™å­—æ®µç›´æ¥ `.update`.

- **åˆ é™¤**ï¼šå…ˆè°ƒç”¨ `drivers.detach_all(device_id)` å†åˆ åº“ã€‚

- è¿”å›ç»Ÿä¸€ `DeviceVO`.


**â˜‘ TODO BE-3** â€” å†™å®Œå…¶ä½™ REST æ–¹æ³• + å•å…ƒæµ‹è¯•ã€‚

---

## 2-Dâ€ƒç‚¹ä½ Handler æ ¸å¿ƒï¼ˆ`routes/tags.rs`ï¼‰

- åˆ›å»ºç‚¹ä½åæ— é¡»é€šçŸ¥é©±åŠ¨ï¼ˆé©±åŠ¨è®¢é˜… Frame-Bus æ—¶è¯»å– PGï¼‰ã€‚

- åˆ—è¡¨æ¥å£æ”¯æŒ `device_id` è¿‡æ»¤ï¼›åˆ†é¡µå¯é€‰ã€‚


|Verb|`/tags`|Query|è¯´æ˜|
|---|---|---|---|
|GET|`?device_id=<uuid>`|åˆ—å‡ºè®¾å¤‡å…¨éƒ¨ç‚¹ä½||
|POST|body `NewTag`|æ–°å¢||

**â˜‘ TODO BE-4** â€” å®Œæˆå®ç°ä¸æµ‹è¯•ã€‚

---

## 2-Eâ€ƒå®æ—¶æ•°æ® WebSocket æ¡¥ï¼ˆ`telemetry_ws.rs`ï¼‰

```rust
pub fn scope() -> actix_web::Scope {
    web::scope("/ws")
        .route("/telemetry", web::get().to(connect))
}

async fn connect(
    req: HttpRequest,
    stream: web::Payload,
    data: Data<AppState>,
) -> Result<HttpResponse, Error> {
    let device_id = req.query_string()
                       .split('=').nth(1)
                       .ok_or_else(|| ErrorBadRequest("device_id missing"))?
                       .parse::<Uuid>()?;
    let rx = frame_bus::subscribe(Filter::by_device(device_id))?;
    ws::start(TelemetryActor { rx }, &req, stream)
}

struct TelemetryActor { rx: FrameReceiver }

impl Actor for TelemetryActor { type Context = WsContext<Self>; }

impl StreamHandler<Result<BusFrame, BusError>> for TelemetryActor {
    fn handle(&mut self, item: Result<BusFrame, BusError>, ctx:&mut Self::Context) {
        if let Ok(BusFrame::Data(df)) = item {
            let msg = serde_json::to_string(&TelemetryMsg::from(df)).unwrap();
            ctx.text(msg);
        }
    }
}
```

- **Frame-Bus è¿‡æ»¤**ï¼šåªå‘é€æŒ‡å®š device æ•°æ®ã€‚

- **å‰ç«¯æ¶ˆæ¯æ ¼å¼**ï¼š`{ ts: 162â€¦, tag_id: "â€¦", value: 12.34 }`.


**â˜‘ TODO BE-5** â€” å®è£… actor + é›†æˆæµ‹è¯• (publish frame â†’ WS recv)ã€‚

---

## 2-Fâ€ƒå‰ç«¯ Pinia Stores & API è°ƒç”¨

### 2-F-1 Axios å°è£…

```ts
const inst = axios.create({ baseURL: import.meta.env.VITE_API_BASE })
inst.interceptors.response.use(r=>r, e=>{
  ElMessage.error(e.response?.data?.detail || e.message)
  return Promise.reject(e)
})
export default inst
```

### 2-F-2 Device Store

```ts
export const useDeviceStore = defineStore('device', {
  state: ()=>({ list: [] as Device[] }),
  actions: {
    async fetch() { this.list = (await api.listDevices()).data },
    async create(d: DeviceCreateReq){ await api.createDevice({ data:d }); await this.fetch() },
    async update(id,d){ await api.updateDevice({ id, data:d }); await this.fetch() },
    async remove(id){ await api.deleteDevice({ id }); await this.fetch() },
  }
})
```

### 2-F-3 Telemetry Composition API Hook

```ts
export function useTelemetry(deviceId:Ref<string>){
  const series = ref<Record<string, number[]>>({})
  let ws:WebSocket|undefined
  watch(deviceId, id=>{
    if(ws) ws.close()
    ws = new WebSocket(`${import.meta.env.VITE_WS_BASE}/telemetry?device_id=${id}`)
    ws.onmessage = e=>{
      const {tag_id, ts, value} = JSON.parse(e.data)
      series.value[tag_id] ??= []
      series.value[tag_id].push(value)
    }
  }, { immediate:true })
  return { series }
}
```

---

## 2-Gâ€ƒVue é¡µé¢è“å›¾ï¼ˆElement-Plus UI å¯æ›¿æ¢ï¼‰

### 2-G-1 `Device.vue`

_åŠŸèƒ½_ï¼šè¡¨æ ¼ + Drawer è¡¨å•ã€‚

```vue
<Table :data="devices">
  <template #actions="{row}">
    <Button @click="edit(row)">ç¼–è¾‘</Button>
    <Button type="danger" @click="del(row.id)">åˆ é™¤</Button>
  </template>
</Table>
<Drawer v-model="drawer">
  <DeviceForm :model="form" @submit="onSubmit" />
</Drawer>
```

### 2-G-2 `Tag.vue`

- Select è®¾å¤‡ â†’ åˆ—ç‚¹ä½ â†’ æ–°å¢/åˆ é™¤

- åœ°å€ã€æ•°æ®ç±»å‹ã€é‡ç¨‹ç­‰å­—æ®µæ ¡éªŒã€‚


### 2-G-3 `Dashboard.vue`

- é€‰æ‹©è®¾å¤‡ â†’ å‹¾é€‰ç‚¹ä½ â†’ å®æ—¶å›¾è¡¨ï¼ˆECharts LineSeriesï¼‰


```vue
<CheckboxGroup v-model="selected">
  <Checkbox v-for="t in tags" :label="t.id">{{t.address}}</Checkbox>
</CheckboxGroup>
<LineChart :series="chartSeries" />
```

```ts
const { series } = useTelemetry(deviceId)
const chartSeries = computed(()=> selected.value.map(id=>({
  name: id, type:'line', data: series.value[id] || []
})))
```

**â˜‘ TODO FE-1** â€” å®ç° 3 ä¸ªé¡µé¢ + è·¯ç”± `/devices /tags /dashboard`.

---

## 2-Hâ€ƒæµ‹è¯•çŸ©é˜µ

|å±‚çº§|æ¡†æ¶|ç”¨ä¾‹|
|---|---|---|
|å•å…ƒ|Rust `cargo test`|BE-1, BE-2 Repo CRUD|
|é›†æˆ|Rust `actix-web::test`|BE-3, BE-4 REST 200/404|
|WS|Rust `tokio-tungstenite`|BE-5 publishâ†’recv|
|å‰ç«¯å•å…ƒ|Vitest|ç»„ä»¶ emits / store actions|
|E2E|Playwright|æ·»åŠ è®¾å¤‡â†’æ–°å¢ç‚¹ä½â†’æŸ¥çœ‹å®æ—¶æ›²çº¿|

**â˜‘ TODO CI-1** â€” GH Actions job `e2e.yml`ï¼šdocker-compose up api + ws â†’ playwright runã€‚

---

## 2-Iâ€ƒDevOps æ‰©å±•è¦ç‚¹

|äº‹é¡¹|æœ€å°å®ç°|
|---|---|
|**æ—¥å¿—**|`tracing` JSON â†’ stdoutï¼›å‰ç«¯ `console.log` ç§»é™¤|
|**ç›‘æ§**|`actix-web-prom` middleware â†’ `/metrics`; Grafana å¦é…|
|**çƒ­æ›´æ–°**|`drivers.upload` è°ƒ `DriverManager::load` å·²åœ¨æ®µè½ 1 å®šä¹‰ï¼›åŒä¸€ç‰ˆæœ¬è¦†ç›–è§„åˆ™åœ¨æ®µè½ 4|

---

### 2-Jâ€ƒClaude Code Checklistï¼ˆæ®µè½ 2 ä¸“å±ï¼‰

|ç¼–å·|åŠ¨ä½œ|
|---|---|
|BE-1|å®ç° `PgDeviceRepo` + æµ‹è¯•|
|BE-2|å®ç° `PgTagRepo` + æµ‹è¯•|
|BE-3|å®Œæˆ devices REST (create/list/get/update/delete)|
|BE-4|å®Œæˆ tags REST (create/list/delete)|
|BE-5|å®è£… Telemetry WS actor + æµ‹è¯•|
|FE-1|æ–°å»º `Device.vue`, `Tag.vue`, `Dashboard.vue` + Pinia stores|
|CI-1|é›†æˆä¸Šè¡¨æµ‹è¯•çŸ©é˜µåˆ° GitHub Actions|

æ‰§è¡Œå®Œ Checklistï¼š

- æ‰“å¼€ `http://localhost:5173` å¯ **æ–°å¢è®¾å¤‡ â†’ é…ç½®ç‚¹ä½ â†’ å®æ—¶çœ‹æ›²çº¿**ï¼›

- æ–°å¢æˆ–ç¼–è¾‘è®¾å¤‡æ—¶é©±åŠ¨è‡ªåŠ¨æ³¨å†Œ/é‡è½½ï¼›

- åˆ é™¤è®¾å¤‡ã€ç‚¹ä½ç«‹å³ç”Ÿæ•ˆï¼ˆé©±åŠ¨ detachã€Frame-Bus åœæ­¢æ¨é€ï¼‰ï¼›

- æµ‹è¯•ä¸ CI å…¨ç»¿ã€‚


è‹¥æœ¬æ®µä»»ä½•ç»†èŠ‚éœ€æ›´æ·±ï¼ˆå¦‚è¡¨å•æ ¡éªŒæ­£åˆ™ã€ECharts ä¸»é¢˜æˆ–é©±åŠ¨è¦†ç›–ç­–ç•¥ï¼‰ï¼Œè¯·æŒ‡å‡ºï¼


**æ®µè½ 3ï¼šé©±åŠ¨ï¼ˆDriverï¼‰ç®¡ç†å…¨æ ˆå®ç°â€”â€”ä¸Šä¼  / çƒ­é‡è½½ / å¸è½½æµç¨‹ã€ABI è§„èŒƒã€å‰ç«¯ç®¡ç†é¡µã€è‡ªåŠ¨åŒ–æµ‹è¯•ä¸ DevOps**

> ç›®çš„ï¼šè®©ç”¨æˆ·åœ¨ç½‘é¡µç«¯**â€œé€‰æ–‡ä»¶ â†’ ä¸Šä¼  â†’ å³åˆ»ç”Ÿæ•ˆâ€**ï¼Œå¹¶åœ¨ä¸é‡å¯ç½‘å…³çš„æƒ…å†µä¸‹å‡çº§æˆ–æ›¿æ¢åè®®é©±åŠ¨ã€‚å®Œæˆæœ¬æ®µåï¼Œæ•´ä¸ªé—­ç¯å°†æ”¯æŒ **è®¾å¤‡-ç‚¹ä½-é©±åŠ¨** ä¸‰å±‚åŠ¨æ€é…ç½®ã€‚ä»£ç ç‰‡æ®µå¯ç›´æ¥è½åº“ï¼›Claude Code é€æ¡ â˜‘ TODO æ‰§è¡Œå³å¯ã€‚

---

## 3-Aâ€ƒç£ç›˜å¸ƒå±€ä¸å·¥ä½œåŒºæ–°å¢å†…å®¹

```
Gateway_Rust/
â”œâ”€ core/
â”‚  â”œâ”€ driver-sdk/               # â• å…¬å¼€ç»™ç¬¬ä¸‰æ–¹ç¼–å†™é©±åŠ¨çš„ SDK
â”‚  â”‚   â”œâ”€ src/lib.rs
â”‚  â”‚   â””â”€ Cargo.toml
â”‚  â”œâ”€ driver-manager/           # âœ… å·²å­˜åœ¨ï¼›æœ¬æ®µæ‰©å……
â”‚  â”‚   â”œâ”€ src/
â”‚  â”‚   â”‚   â”œâ”€ lib.rs            // DriverManager
â”‚  â”‚   â”‚   â”œâ”€ loader.rs         // *.so è£…è½½é€»è¾‘  (æ–°å¢)
â”‚  â”‚   â”‚   â”œâ”€ registry.rs       // å·²åŠ è½½é©±åŠ¨è¡¨  (æ–°å¢)
â”‚  â”‚   â”‚   â””â”€ watcher.rs        // inotify çƒ­ç›‘è§† (å¯å…³é—­)
â”‚  â”‚   â””â”€ tests/                // ç”¨äº DM-T1~T4
â”‚  â””â”€ web-gw-api/               # ç»§ç»­æ‰©å……
â”‚      â””â”€ src/routes/drivers.rs // æ–°å¢è·¯ç”±
â”œâ”€ drivers/                     # è¿è¡ŒæœŸåŠ¨æ€åº“å®é™…å­˜æ”¾å¤„
â”‚  â””â”€ {protocol}/{version}/libdriver.so
â””â”€ web-ui/
    â””â”€ src/pages/Driver.vue     # ç®¡ç†ç•Œé¢
```

**â˜‘ TODO DM-0** â€” åœ¨æ ¹ `Cargo.toml` çš„ `[workspace] members` è¿½åŠ  `core/driver-sdk`.

---

## 3-Bâ€ƒDriver ABI è§„èŒƒï¼ˆ`driver-sdk`ï¼‰

### 3-B-1 `Driver` trait

```rust
#[async_trait::async_trait]
pub trait Driver: Send + Sync {
    fn protocol(&self) -> ProtocolKind;
    fn version(&self) -> &'static str;
    async fn attach_device(&self, device_id: Uuid) -> Result<()>;
    async fn detach_device(&self, device_id: Uuid) -> Result<()>;
    async fn unload(&self) -> Result<()>;               // æ”¶å°¾æ¸…ç†
}
```

### 3-B-2 å® `declare_driver!`

```rust
// driver-sdk/src/lib.rs
#[macro_export]
macro_rules! declare_driver {
    (name = $name:expr, version = $ver:expr, driver = $ty:ty) => {
        #[no_mangle] pub extern "C" fn driver_entry() -> *mut dyn $crate::Driver {
            let drv: Box<dyn $crate::Driver> = Box::new(<$ty>::default());
            Box::into_raw(drv)
        }
        #[no_mangle] pub static DRIVER_NAME: &str = $name;
        #[no_mangle] pub static DRIVER_VERSION: &str = $ver;
        #[no_mangle] pub static DRIVER_API_VERSION: u8 = 1;
    };
}
```

_â˜‘ TODO DM-1_ â€” å®Œæˆå® & `DriverMeta { protocol, version, path }` æ•°æ®ç»“æ„ã€‚

---

## 3-Câ€ƒDriver-Manager è¿è¡ŒæœŸé€»è¾‘

### 3-C-1 åŸºæœ¬æ“ä½œ

```rust
pub struct DriverManager {
    registry: DashMap<ProtocolKind, DriverEntry>,
}

pub struct DriverEntry {
    drv:    Arc<dyn Driver>,
    lib:    libloading::Library,      // ä¿è¯ .so å­˜æ´»
    meta:   DriverMeta,
}
```

- `load(path)`

    1. `libloading::Library::new(path)`

    2. è·å– `driver_entry`ã€`DRIVER_NAME`, `DRIVER_VERSION`, `DRIVER_API_VERSION`.

    3. å¦‚æœ APIâ‰ 1 â†’ `ApiMismatch`.

    4. è‹¥ registry å·²æœ‰åŒ protocolï¼š

        - ç‰ˆæœ¬ç›¸åŒ â†’ `AlreadyLoaded`.

        - ç‰ˆæœ¬è¾ƒæ—§ â†’ è°ƒ `unload()` â†’ æ›¿æ¢æ¡ç›®ã€‚

    5. è°ƒ `attach_device` é’©å­å¯¹ç°æœ‰è®¾å¤‡ç”Ÿæ•ˆã€‚

- `unload(protocol)`

    1. æ‰¾æ¡ç›® â†’ `drv.unload()` â†’ `lib.close()`.

    2. ä» registry ç§»é™¤ã€‚

- `list()` â†’ `Vec<DriverInfo { protocol, version, loaded_at }>`


_â˜‘ TODO DM-2_ â€” å®Œæˆ `loader.rs` & `registry.rs` å…¨åŠŸèƒ½ã€è®°å½• `loaded_at`.

### 3-C-2 å¯é€‰æ–‡ä»¶ç³»ç»Ÿ Watch

- é»˜è®¤å…³é—­ï¼›`config.drivers.autowatch = true` æ—¶ï¼Œä½¿ç”¨ `notify` crate watch `drivers/**/libdriver.so` `Create|Write` äº‹ä»¶å¹¶è°ƒ `reload(path)`ã€‚


---

## 3-Dâ€ƒæ•°æ®åº“è¡¨ (PostgreSQL)

`schema/migrations/0004_driver_registry.sql`

```sql
CREATE TABLE driver_registry (
    protocol    protocol_kind PRIMARY KEY,
    version     VARCHAR(32) NOT NULL,
    loaded_at   TIMESTAMPTZ NOT NULL DEFAULT now()
);
```

- æ¯æ¬¡ `load/reload/unload` æ›´æ–°è¯¥è¡¨ï¼›ä¾›å‰ç«¯æŸ¥è¯¢ã€‚


**â˜‘ TODO DB-2** â€” æ·»åŠ è„šæœ¬å¹¶ `sqlx migrate run`.

---

## 3-Eâ€ƒActix è·¯ç”± (`routes/drivers.rs`)

```rust
pub fn scope() -> Scope {
    web::scope("/drivers")
        .route("",              web::get().to(list))
        .route("/upload",       web::post().to(upload))
        .route("/{protocol}",   web::delete().to(unload))
        .route("/{protocol}/reload", web::post().to(reload))
}

async fn upload(mut mp: Multipart, data: Data<AppState>)
    -> Result<impl Responder, ApiError> {
    let file = extract_single_file(&mut mp).await?;
    let temp = temp_file_path(&file).await?;             // ä¿å­˜åˆ° /tmp
    let proto = data.drivers.load(&temp).await?;
    move_to_final(proto, &temp, &data.cfg.drivers_dir).await?;
    Ok(HttpResponse::Ok().json(json!({
        "protocol": proto, "action":"loaded"
    })))
}
```

- `extract_single_file` è¯»å– `.so`ï¼›é ELF / WASM è¿”å› 400ã€‚

- `unload` â†’ `drivers.unload(protocol)`; åŒæ—¶åˆ  PG è¡Œ & åˆ é™¤ç£ç›˜ç›®å½•ã€‚


**â˜‘ TODO BE-6** â€” å®Œæ•´å®ç° 4 ä¸ª Handler + å•å…ƒæµ‹è¯•ã€‚

---

## 3-Fâ€ƒå‰ç«¯é¡µé¢ `Driver.vue`

### 3-F-1 Pinia Store

```ts
export const useDriverStore = defineStore('driver', {
  state: ()=>({ list: [] as DriverInfo[] }),
  actions:{
    async fetch(){ this.list = (await api.listDrivers()).data },
    async upload(file:File){
      const form = new FormData(); form.append('file',file)
      await api.uploadDriver({ data:form }); await this.fetch()
    },
    async reload(proto:string){
      await api.reloadDriver({ protocol:proto }); await this.fetch()
    },
    async unload(proto:string){
      await api.deleteDriver({ protocol:proto }); await this.fetch()
    }
  }
})
```

### 3-F-2 ç»„ä»¶éª¨æ¶

```vue
<template>
  <Page title="é©±åŠ¨ç®¡ç†">
    <Upload accept=".so,.wasm" @success="onUpload" />
    <Table :data="drivers">
      <template #actions="{row}">
        <Button @click="reload(row.protocol)">çƒ­é‡è½½</Button>
        <Button type="danger" @click="unload(row.protocol)">å¸è½½</Button>
      </template>
    </Table>
  </Page>
</template>

<script setup lang="ts">
const store = useDriverStore(); store.fetch()
const { drivers } = storeToRefs(store)
function onUpload(file){ store.upload(file.raw) }
function reload(p){ store.reload(p) }
function unload(p){ store.unload(p) }
</script>
```

**â˜‘ TODO FE-2** â€” å®Œæˆé¡µé¢æ ·å¼ã€è¡¨å•æ ¡éªŒã€è·¯ç”± `/drivers`.

---

## 3-Gâ€ƒæµ‹è¯•çŸ©é˜µ

|ID|æè¿°|æ­¥éª¤|æ–­è¨€|
|---|---|---|---|
|DM-T1|**load_ok**|POST /upload libv1.so|200; PG version=v1|
|DM-T2|**reload_upgrade**|libv1 â†’ libv2|åˆ—è¡¨ version=v2; v1 å¸è½½ hook è°ƒç”¨ä¸€æ¬¡|
|DM-T3|**same_version**|è¿ç»­ä¸Šä¼ åŒæ–‡ä»¶|ç¬¬ä¸€æ¬¡ 200; ç¬¬äºŒæ¬¡ 409|
|DM-T4|**invalid_api**|ä¸Šä¼  api_version=2|422 `driver.api_mismatch`|

> åç«¯æµ‹è¯•ç”¨ `actix_web::test + assert_json`.

**â˜‘ TODO TEST-1** â€” åœ¨ `driver-manager/tests/` ä¸ `web-gw-api/tests/` åˆ†åˆ«ç¼–å†™ DM-T1~T4ã€‚

---

## 3-Hâ€ƒDevOps & CI

1. **GitHub Actions** æ–° Job `drivers-tests`:

    ```yaml
    - name: Run driver tests
      run: cargo test -p driver-manager
    ```

2. **Dockerfile**ï¼š

    ```Dockerfile
    RUN mkdir -p /app/drivers
    COPY drivers /app/drivers        # é¢„ç½®å®˜æ–¹é©±åŠ¨
    ```

3. **Compose**ï¼šè‹¥ä½¿ç”¨çƒ­ç›‘è§†ï¼ŒæŒ‚è½½ `drivers:/opt/gw/drivers` ä¸ºå¯å†™å·ã€‚


---

### 3-Iâ€ƒClaude Code Checklistï¼ˆæ®µè½ 3 ä¸“å±ï¼‰

|ç¼–å·|å†…å®¹|
|---|---|
|DM-1|å®ç° `driver-sdk` å®ä¸å…ƒæ•°æ®|
|DM-2|å®Œæˆ `DriverManager` loader / unload / list|
|DB-2|æ·»åŠ  `driver_registry` è¡¨è¿ç§» & è¿è¡Œ|
|BE-6|è·¯ç”± `/drivers` å››æ¥å£ + æµ‹è¯•|
|FE-2|`Driver.vue` é¡µé¢ + Store|
|TEST-1|DM-T1 ~ DM-T4 å…¨éƒ¨é€šè¿‡|
|CI|æ–°å¢ Job `drivers-tests`|

---

**å®Œæˆæœ¬æ®µåï¼Œä½ å°†å¾—åˆ°ï¼š**

- **ç½‘é¡µç«¯**ï¼šä¸Šä¼  `.so` â˜ ç«‹å³å‡ºç°åœ¨â€œé©±åŠ¨åˆ—è¡¨â€ï¼›ç‚¹â€œçƒ­é‡è½½â€æ–‡å­—é—ªç°â€œå·²æ›´æ–°â€ã€‚

- **åç«¯**ï¼šDriverManager åœ¨å†…å­˜è¡¨ & PG ä¸­åŒæ­¥æ›´æ–°ï¼Œå·²è·‘çš„è®¾å¤‡è‡ªåŠ¨åˆ‡æ¢åˆ°æ–°ç‰ˆé©±åŠ¨ã€‚

- **CI æ¡¥æ¥**ï¼šæ¯æ¬¡ PR è‡ªåŠ¨ç¼–è¯‘é©±åŠ¨ã€è·‘å››ä¸ªæ ¸å¿ƒç”¨ä¾‹ï¼Œé˜²å›å½’ã€‚


> ä¸‹ä¸€æ®µï¼ˆæ®µè½ 4ï¼‰å»ºè®®å®ç° **InfluxDB å†å²æ•°æ®æŸ¥è¯¢ä¸ç»Ÿè®¡æ¥å£**ï¼Œé…å¥—â€œå†å²æ›²çº¿ / æŠ¥è¡¨â€å‰ç«¯è§†å›¾ã€‚å¦‚éœ€å…ˆå¤„ç†å…¶ä»–æ¨¡å—ï¼Œè¯·å‘Šè¯‰æˆ‘ï¼

**æ®µè½ 4ï¼šInfluxDB å†å²æ•°æ®æŸ¥è¯¢ä¸ç»Ÿè®¡æ¥å£â€”â€”åç«¯å®ç°ã€å‰ç«¯æŠ¥è¡¨è§†å›¾ã€æµ‹è¯•ä¸è¿ç»´**

> ç›®æ ‡ï¼šè®©ç”¨æˆ·åœ¨ç½‘é¡µç«¯**é€‰æ—¶é—´èŒƒå›´ â†’ æŸ¥çœ‹å†å²æ›²çº¿ / æœ€å¤§-æœ€å°-å¹³å‡ / å¯¼å‡º CSV**ã€‚å®Œæˆæœ¬æ®µåï¼Œå…¨æ ˆå³å¯åŒæ—¶å¤„ç† **å®æ—¶(WS) + å†å²(HTTP)** æ•°æ®ã€‚Claude Code ä¾ç…§ â˜‘ TODO åˆ—è¡¨æ‰§è¡Œå³å¯è½åœ°ã€‚

---

## 4-Aâ€ƒæµ‹ç‚¹æ•°æ®å­˜å‚¨è§„èŒƒå›é¡¾

|å±æ€§|çº¦å®š|
|---|---|
|**Influx 2.x** bucket|`telemetry`|
|Measurement|`tag_data`|
|Tags|`device_id`ã€`tag_id`|
|Fields|`f_value` (float)ï¼Œ`i_value` (int)ï¼Œ`b_value` (bool)ï¼Œ`s_value` (string)|
|æ—¶é—´æˆ³|é©±åŠ¨å±‚ä½¿ç”¨çº³ç§’ç²¾åº¦ `epoch_ns`|
|ä¿ç•™ç­–ç•¥|30 å¤©ï¼ˆç”Ÿäº§å¯è°ƒï¼‰ï¼›0 = æ°¸ä¹…ä¿ç•™|

> **å†™å…¥ç¤ºä¾‹ï¼ˆLine-Protocolï¼‰**
>
> ```
> tag_data,device_id=7f..,tag_id=35.. f_value=12.34 1721981047000000000
> ```

---

## 4-Bâ€ƒAPI è·¯ç”±è®¾è®¡

_æ–‡ä»¶_ `core/web-gw-api/src/routes/history.rs`

|Verb|Path|è¯´æ˜|Handler|
|---|---|---|---|
|`GET`|`/api/v1/history/query`|åŸå§‹åºåˆ—|`history::query_series`|
|`GET`|`/api/v1/history/stats`|ç»Ÿè®¡èšåˆ|`history::query_stats`|
|`GET`|`/api/v1/history/export`|CSV ä¸‹è½½|`history::export_csv`|

### 4-B-1 Query å‚æ•°

|å‚æ•°|ç±»å‹|å¿…å¡«|è¯´æ˜|
|---|---|---|---|
|`device_id`|UUID|âœ”|è®¾å¤‡|
|`tag_id`|UUID|âœ”|ç‚¹ä½|
|`from`|RFC3339|âœ”|èµ·å§‹æ—¶é—´|
|`to`|RFC3339|âœ”|ç»“æŸæ—¶é—´|
|`step`|Duration|âœ–|down-sample ç²’åº¦ï¼Œé»˜è®¤ 1 s|
|`agg`|enum|stats æ¥å£å¿…å¡«|`mean`/`min`/`max`/`sum`|

> âš  **é‰´æƒ**æš‚ä¸å¯ç”¨ï¼›ä¸Šçº¿å‰å¹¶å…¥æ®µè½ 7ã€‚

---

## 4-Câ€ƒDTO å®šä¹‰ï¼ˆ`dto.rs`ï¼‰

```rust
#[derive(Deserialize)]
pub struct HistoryQuery {
    pub device_id: Uuid,
    pub tag_id:    Uuid,
    pub from:      DateTime<Utc>,
    pub to:        DateTime<Utc>,
    pub step:      Option<humantime::Duration>,
}
#[derive(Serialize)]
pub struct SeriesPoint { pub ts: i64, pub value: f64 }

#[derive(Deserialize)]
pub struct StatsQuery {
    #[serde(flatten)] pub base: HistoryQuery,
    pub agg: StatsKind,              // mean|min|max|sum
}
#[derive(Serialize)]
pub struct StatsResp {
    pub device_id: Uuid,
    pub tag_id:    Uuid,
    pub agg:       StatsKind,
    pub value:     f64,
}
```

**â˜‘ TODO BE-7** â€” åœ¨ `dto.rs` å†™æšä¸¾ `StatsKind` + `FromStr`.

---

## 4-Dâ€ƒInflux æŸ¥è¯¢å®ç°

### 4-D-1 åŸå§‹åºåˆ— (down-sample)

```rust
async fn query_series(
    data: Data<AppState>,
    q: Query<HistoryQuery>,
) -> Result<impl Responder, ApiError> {
    let step = q.step.unwrap_or_else(|| humantime::Duration::from_secs(1));
    let flux = format!(r#"
      from(bucket:"telemetry")
      |> range(start: time(v: "{from}"), stop: time(v: "{to}"))
      |> filter(fn:(r)=> r.device_id=="{dev}" and r.tag_id=="{tag}")
      |> aggregateWindow(every: {step}, fn: mean, createEmpty: false)
      |> yield(name:"mean")
    "#,
      from=q.from.to_rfc3339(), to=q.to.to_rfc3339(),
      dev=q.device_id, tag=q.tag_id, step=step
    );
    let result = data.influx.query::<SeriesPoint>(flux).await?;
    Ok(Json(result))
}
```

### 4-D-2 ç»Ÿè®¡èšåˆ

```rust
let func = match q.agg { Mean=>"mean", Min=>"min", Max=>"max", Sum=>"sum" };
let flux = format!(r#"
  from(bucket:"telemetry")
  |> range(start: time(v: "{from}"), stop: time(v: "{to}"))
  |> filter(fn:(r)=> r.device_id=="{dev}" and r.tag_id=="{tag}")
  |> {func}()
"#, ... );
```

### 4-D-3 CSV å¯¼å‡º

- è°ƒç”¨ä¸ `query_series` ç›¸åŒ fluxï¼›ä½¿ç”¨ `influxdb2::Client::query_csv`ã€‚

- è¿”å› `Content-Type: text/csv; charset=utf-8;`ï¼Œæ–‡ä»¶å `device_<id>_<from>_<to>.csv`.


**â˜‘ TODO BE-8** â€” å®ç° `query_series` / `query_stats` / `export_csv` ä¸‰ Handler å®Œæ•´é”™è¯¯é“¾ã€‚

---

## 4-Eâ€ƒå‰ç«¯é¡µé¢ä¸ Store

### 4-E-1 Store `history.ts`

```ts
export const useHistoryStore = defineStore('history', {
  state: ()=>({
    points:{} as Record<string, SeriesPoint[]>,   // key = tagId
    stats:{}  as Record<string, number>,
  }),
  actions:{
    async fetchSeries(params:HistoryQuery){
      const { data } = await api.querySeries(params)
      this.points[params.tag_id] = data
    },
    async fetchStats(params:StatsQuery){
      const { data } = await api.queryStats(params)
      this.stats[`${params.tag_id}-${params.agg}`] = data.value
    },
    async exportCsv(p:HistoryQuery){
      const blob = (await api.exportCsv({ params:p, responseType:'blob'})).data
      saveAs(blob, 'history.csv')
    }
  }
})
```

### 4-E-2 é¡µé¢ `History.vue`

```vue
<DateTimePicker v-model="range" />
<SelectDevice v-model="deviceId" />
<SelectTag v-model="tagId" />
<Button @click="load">æŸ¥è¯¢</Button>
<Button @click="exportCsv">å¯¼å‡º CSV</Button>

<LineChart :series="series" />

<Card title="ç»Ÿè®¡">
  <p>å¹³å‡å€¼ï¼š{{stats.mean}}</p>
  <p>æœ€å¤§å€¼ï¼š{{stats.max}}</p>
</Card>
```

```ts
const store = useHistoryStore()
async function load(){
  await store.fetchSeries({...params, step:'1s'})
  await store.fetchStats({...params, agg:'mean'})
  await store.fetchStats({...params, agg:'max'})
}
const series = computed(()=> [{
  name:'value', type:'line',
  data: store.points[tagId.value]?.map(p=>[p.ts,p.value]) || []
}])
const stats = computed(()=> ({
  mean: store.stats[`${tagId.value}-mean`] ?? 'â€”',
  max:  store.stats[`${tagId.value}-max`]  ?? 'â€”'
}))
```

**â˜‘ TODO FE-3** â€” å®Œæˆ `History.vue`ã€è·¯ç”± `/history`ã€æ—¥æœŸé€‰æ‹©å™¨å›½é™…åŒ–ã€‚

---

## 4-Fâ€ƒæµ‹è¯•è®¡åˆ’

|å±‚çº§|æ¡†æ¶|ç”¨ä¾‹|
|---|---|---|
|å•å…ƒ|Rust|BE-7 enum parseã€Flux æ„é€ |
|é›†æˆ|Rust + `testcontainers`|å†™å…¥ Influx â†’ è°ƒ `/history/query` â†” æ ¡éªŒ JSON|
|å¯¼å‡º|Rust|`/history/export` è¿”å› CSV å†…å®¹-Type|
|å‰ç«¯å•å…ƒ|Vitest|Store fetch â†’ çŠ¶æ€å†™å…¥|
|å‰ç«¯ E2E|Playwright|é€‰è®¾å¤‡+æ—¶é—´ â†’ æ›²çº¿æ¸²æŸ“ â‰¥1 ç‚¹ â†’|

**â˜‘ TODO TEST-2** â€” ç¼–å†™åç«¯é›†æˆæµ‹è¯• `history_e2e.rs`.

---

## 4-Gâ€ƒè¿ç»´ä¸æ€§èƒ½ä¼˜åŒ–

|é¡¹|é…ç½® / å»ºè®®|
|---|---|
|**Influx Token**|ç½®äº `INFLUX_TOKEN` ç¯å¢ƒå˜é‡ï¼›ApiCfg åªå­˜ URL|
|**Retention Policy**|`influx bucket update telemetry --retention 720h`|
|**Downsampling**|æ¯æ—¥ Task å†™å…¥ `telemetry_1m` bucket (`aggregateWindow 1m`)|
|**backup**|`influx backup /backups/influx/$(date) -b telemetry`|
|**ç´¢å¼• / Cardinality**|Tag å­˜ UUIDï¼Œé¿å…é«˜åŸºæ•°å­—æ®µï¼›æ—  location ç­‰åŠ¨æ€ Tag|

ç›‘æ§æŒ‡æ ‡ï¼ˆPrometheusï¼‰ï¼š

- `history_query_duration_seconds_bucket` (Histogram)

- `influx_http_requests_total`


**â˜‘ TODO OPS-1** â€” åœ¨ `web-gw-api/src/metrics.rs` å¯¼å‡º Histogramã€‚

---

## 4-Hâ€ƒCI/CD å¢é‡

1. **Service Injection**ï¼šGitHub Actions `services: influxdb:2.7-alpine`ï¼Œé¢„åˆ›å»º bucket & tokenï¼š

    ```yaml
    influxdb:
      image: influxdb:2.7
      env:
        - DOCKER_INFLUXDB_INIT_USERNAME=ci
        - DOCKER_INFLUXDB_INIT_PASSWORD=ci123
        - DOCKER_INFLUXDB_INIT_ORG=acme
        - DOCKER_INFLUXDB_INIT_BUCKET=telemetry
    ```

2. **Job** `history-tests`ï¼šè¿è¡Œ TEST-2 é›†æˆè„šæœ¬ã€‚


---

### 4-Iâ€ƒClaude Code Checklistï¼ˆæ®µè½ 4 ä¸“å±ï¼‰

|ç¼–å·|ä»»åŠ¡|
|---|---|
|BE-7|DTO `StatsKind` + handler å‚æ•°è§£æ|
|BE-8|å®ç° 3 Handlerï¼ˆquery_series / query_stats / export_csvï¼‰|
|FE-3|æ–°å»º `History.vue` + store + è·¯ç”±|
|TEST-2|Influx é›†æˆæµ‹è¯•è¦†ç›– JSON ä¸ CSV|
|OPS-1|Prometheus Histogram å¯¼å‡º|
|CI|æ–° Job `history-tests` å¯åŠ¨ Influx æœåŠ¡|

---

**å®Œæˆæœ¬æ®µåï¼Œä½ å°†å¾—åˆ°ï¼š**

- **åç«¯**ï¼š`/history/query` ~ 50 ms å®Œæˆ 1 å°æ—¶æ•°æ®æŸ¥è¯¢ï¼Œ`/history/stats` æ”¯æŒ mean/min/max/sumã€‚

- **å‰ç«¯**ï¼šæ—¶é—´é€‰æ‹© â†’ æ›²çº¿å³æ—¶æ¸²æŸ“ï¼›â€œå¯¼å‡º CSVâ€ ä¸€é”®ä¸‹è½½ã€‚

- **ç›‘æ§**ï¼šPrometheus å¯è§æŸ¥è¯¢å»¶è¿Ÿåˆ†å¸ƒï¼›Influx bucket 30 å¤©æ»šåŠ¨ã€‚


> ä¸‹ä¸€æ®µï¼ˆæ®µè½ 5ï¼Œè‹¥éœ€è¦ï¼‰å¯è¦†ç›– **å‘Šè­¦ & æŠ¥è­¦ï¼ˆé˜ˆå€¼â†’é€šçŸ¥ï¼‰** æˆ– **è¿ç»´ç›‘æ§ä»ªè¡¨ç›˜ï¼ˆGrafana JSON æ¨¡æ¿ï¼‰**ã€‚å¦‚æœ‰ä¸åŒä¼˜å…ˆçº§ï¼Œè¯·å‘ŠçŸ¥ï¼


**æ®µè½ 5ï¼šæŠ¥è­¦ï¼ˆAlertingï¼‰ä¸é€šçŸ¥ç³»ç»Ÿâ€”â€”è§„åˆ™å»ºæ¨¡ã€è¯„ä¼°å¼•æ“ã€åç«¯ APIã€å‰ç«¯å¯è§†åŒ–ã€è¿ç»´ä¸æµ‹è¯•**

> ç›®æ ‡ï¼šè®©ç”¨æˆ·åœ¨ç½‘é¡µç«¯ **â€œé…ç½®é˜ˆå€¼ â†’ ä¿å­˜è§„åˆ™ â†’ å®æ—¶/å‘¨æœŸè§¦å‘ â†’ æ”¶åˆ°é‚®ä»¶æˆ– Web æ¨é€â€**ã€‚å®Œæˆæœ¬æ®µåï¼Œå¹³å°å…·å¤‡ **å®æ—¶å‘Šè­¦ + å†å²æŠ¥è­¦è®°å½• + å¤šæ¸ é“é€šçŸ¥** çš„é—­ç¯ã€‚å†…å®¹æŒ‰ **ç£ç›˜å¸ƒå±€ â†’ æ•°æ®æ¨¡å‹ â†’ è¯„ä¼°å¼•æ“ â†’ API â†’ å‰ç«¯ â†’ æµ‹è¯• â†’ è¿ç»´** é€å±‚å±•å¼€ã€‚æ‰€æœ‰ â˜‘ TODO å¯¹åº”å¯ç›´æ¥ç¼–ç çš„ä»»åŠ¡ã€‚

---

## 5-Aâ€‚ç›®å½•å¢é‡ï¼ˆæ ¸å¿ƒä»£ç ä¸æœåŠ¡ï¼‰

```
Gateway_Rust/
â”œâ”€ core/
â”‚  â”œâ”€ alert-engine/             # â• Tokio åå°ä»»åŠ¡ï¼Œè¯„ä¼°è§„åˆ™
â”‚  â”‚   â”œâ”€ src/
â”‚  â”‚   â”‚   â”œâ”€ main.rs
â”‚  â”‚   â”‚   â”œâ”€ engine.rs         // è§„åˆ™è½®è¯¢ + æ¨é€
â”‚  â”‚   â”‚   â””â”€ notifier.rs       // Email / Webhook / WS
â”‚  â”‚   â””â”€ Cargo.toml
â”‚  â””â”€ web-gw-api/
â”‚      â””â”€ src/routes/alerts.rs  // è§„åˆ™ CRUD & å†å²æŸ¥è¯¢
â”œâ”€ schema/migrations/
â”‚  â””â”€ 0005_alerts.sql           # â• æ–°å»ºè¡¨
â”œâ”€ web-ui/
â”‚  â””â”€ src/pages/
â”‚      â”œâ”€ AlertRule.vue         # è§„åˆ™ç®¡ç†
â”‚      â””â”€ AlertHistory.vue      # æŠ¥è­¦è®°å½•
â””â”€ .github/workflows/
    â””â”€ alerts-tests.yml         # CI
```

---

## 5-Bâ€‚æ•°æ®åº“æ¨¡å‹ï¼ˆPostgreSQLï¼š0005_alerts.sqlï¼‰

```sql
CREATE TYPE compare_op AS ENUM ('GT','LT','GTE','LTE','EQ','NE');
CREATE TYPE alert_level AS ENUM ('INFO','WARN','CRIT');

CREATE TABLE alert_rules (
    id           UUID PRIMARY KEY,
    name         VARCHAR(64) NOT NULL,
    device_id    UUID,
    tag_id       UUID,
    op           compare_op  NOT NULL,
    threshold    DOUBLE PRECISION,
    level        alert_level NOT NULL DEFAULT 'WARN',
    eval_every   INTERVAL    NOT NULL DEFAULT INTERVAL '10s',
    enabled      BOOLEAN     NOT NULL DEFAULT TRUE,
    created_at   TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE TABLE alert_history (
    id           UUID PRIMARY KEY,
    rule_id      UUID REFERENCES alert_rules(id) ON DELETE CASCADE,
    fired_at     TIMESTAMPTZ NOT NULL,
    value        DOUBLE PRECISION,
    level        alert_level,
    message      TEXT
);
```

_â˜‘ TODO DB-3_â€‚â€” å†™è„šæœ¬å¹¶æ‰§è¡Œ `sqlx migrate run`; æ›´æ–° CI `cargo sqlx prepare`.

---

## 5-Câ€‚Alert-Engineï¼šè¯„ä¼°æµç¨‹

### 5-C-1 æ ¸å¿ƒç®—æ³• (`engine.rs`)

```rust
/// æ¯æ¡è§„åˆ™ç‹¬ç«‹ Tokio taskï¼›è¶…æ—¶åé‡å¯
async fn eval_loop(rule: AlertRule, deps: Deps) -> Result<()> {
    let mut ticker = tokio::time::interval(rule.eval_every);
    loop {
        ticker.tick().await;
        if !rule.enabled { continue; }
        let v = deps.influx.query_f64(latest_flux(&rule)).await?;
        if compare(v, rule.op, rule.threshold) {
            let evt = AlertEvent::new(rule.clone(), v);
            deps.notifier.dispatch(evt.clone()).await?;
            deps.pg.insert_history(evt).await?;
        }
    }
}
```

- **æœ€æ–°å€¼ Flux**

    ````flux
    from(bucket:"telemetry")
      |> range(start:-1m)
      |> filter(fn:(r)=> r.device_id=="${rule.device_id}"
                        and r.tag_id=="${rule.tag_id}")
      |> last()
      |> findColumn(fn:(key) => true, column:"_value")
    ```â€‚:contentReference[oaicite:0]{index=0}  
    ````

- **åŒæ—¶æ”¯æŒ aggregateWindow**ï¼šè‹¥ `eval_every > 1m` åˆ™æ”¹ç”¨ `aggregateWindow(every: rule.eval_every, fn: mean)`ã€‚

- **compare**ï¼šGT/LT/GTE/LTE/EQ/NEã€‚


**â˜‘ TODO AE-1**â€‚â€” å®ç° `eval_loop`, `latest_flux`, `compare`, `AlertEvent`.

### 5-C-2 ä»»åŠ¡è°ƒåº¦ (`main.rs`)

```rust
let rules = pg.load_all_rules().await?;
for r in rules { spawn_eval(r, deps.clone()) }
watch_pg_notify("alert_rule_changed", move |rule_id| {
    // reload / stop-then-start
});
```

- ä½¿ç”¨ `LISTEN/NOTIFY` ç›‘å¬è§„åˆ™è¡¨å˜æ›´ï¼Œçƒ­é‡å¯å¯¹åº”ä»»åŠ¡ã€‚

- **å¤±è´¥å›é€€**ï¼šè¿ç»­ 5 æ¬¡æŸ¥è¯¢é”™è¯¯ â†’ å°† Rule `enabled=false`, å†™å†å²è®°å½• level=CRITã€‚


**â˜‘ TODO AE-2**â€‚â€” å®ç° `spawn_eval` + PG `LISTEN` çƒ­æ›´æ–°ã€‚

### 5-C-3 é€šçŸ¥å™¨ (`notifier.rs`)

|æ¸ é“|é…ç½®é”®|è¯´æ˜|
|---|---|---|
|Email (SMTP)|`alerts.smtp_*`|ç®€æ˜“æ–‡æœ¬ï¼›å¤šæ”¶ä»¶äººé€—å·åˆ†å‰²|
|Webhook (POST JSON)|`alerts.webhook_url`|10 s è¶…æ—¶|
|Internal WS|`alert_ws_tx`|å‘å…¥ `tokio::broadcast::Sender` ç»™å‰ç«¯|

```rust
async fn dispatch(&self, e:AlertEvent) -> Result<()> {
    if let Some(tx) = &self.ws { let _=tx.send(e.clone()); }
    if let Some(cfg) = &self.smtp { send_email(cfg,&e).await?; }
    if let Some(url) = &self.webhook { post_json(url,&e).await?; }
    Ok(())
}
```

**â˜‘ TODO AE-3**â€‚â€” å®ç° 3 ç§æ¸ é“ + å•å…ƒæµ‹è¯• (mock SMTP/Webhook)ã€‚

---

## 5-Dâ€‚Actix API (`routes/alerts.rs`)

|Verb|Path|Body|è¯´æ˜|
|---|---|---|---|
|`GET`|`/api/v1/alerts/rules`|â€“|åˆ—è¡¨|
|`POST`|`/api/v1/alerts/rules`|`NewRuleReq`|æ–°å¢|
|`PUT`|`/api/v1/alerts/rules/{id}`|`PatchRuleReq`|æ›´æ–°|
|`DELETE`|`/api/v1/alerts/rules/{id}`|â€“|åˆ é™¤|
|`GET`|`/api/v1/alerts/history`|`device_id`, `from`, `to`|æŸ¥è¯¢å†å²|
|`WS`|`/ws/alerts`|â€“|å®æ—¶æ¨é€ AlertEvent|

### 5-D-1 DTOï¼ˆæ‘˜å½•ï¼‰

```rust
#[derive(Deserialize)] pub struct NewRuleReq {
    pub name: String,
    pub device_id: Uuid,
    pub tag_id: Uuid,
    pub op: CompareOp,
    pub threshold: f64,
    pub level: AlertLevel,
    pub eval_every: humantime::Duration,
}
```

- **éªŒè¯**ï¼š`threshold` å¿…é¡»ç¬¦åˆ `data_type`ï¼ˆBool â†’ 0|1â€¦ï¼‰ã€‚


**â˜‘ TODO BE-9**â€‚â€” å®ç° CRUD + WS handlerï¼›å…¶ä¸­ POST è°ƒç”¨ `pg.insert_rule` å¹¶ `NOTIFY`.

---

## 5-Eâ€‚å‰ç«¯å®ç°

### 5-E-1 Pinia Store `alert.ts`

```ts
export const useAlertStore = defineStore('alert',{
  state:()=>({
    rules:[] as AlertRuleVO[],
    events:[] as AlertEventVO[]
  }),
  actions:{
    async fetchRules(){ this.rules=(await api.listRules()).data },
    async createRule(r){ await api.createRule({data:r}); await this.fetchRules() },
    async updateRule(id,r){ await api.updateRule({id,data:r}); await this.fetchRules() },
    async deleteRule(id){ await api.deleteRule({id}); await this.fetchRules() },
    watchEvents(){
      const ws=new WebSocket(`${VITE_WS_BASE}/alerts`)
      ws.onmessage=e=> this.events.unshift(JSON.parse(e.data))
    }
  }
})
```

### 5-E-2 ç»„ä»¶æ¦‚è§ˆ

|ç»„ä»¶|åŠŸèƒ½|
|---|---|
|`AlertRule.vue`|è¡¨æ ¼â†’æ–°å¢/ç¼–è¾‘æŠ½å±‰ï¼›ä¸‹æ‹‰é€‰æ‹©è®¾å¤‡+ç‚¹ä½â†’ op(> < = !=) â†’ é˜ˆå€¼ â†’ é¢‘ç‡|
|`AlertHistory.vue`|æ—¶é—´èŒƒå›´+è®¾å¤‡è¿‡æ»¤ â†’ åˆ—è¡¨+åˆ†é¡µï¼›ç‚¹å‡»è¡Œæ˜¾ç¤ºè¶‹åŠ¿ mini-chart|
|Navbar ğŸ”” icon|æ˜¾ç¤º `store.events[0..5]`ï¼›çº¢ç‚¹ = `events.some(e=>e.level==='CRIT')`|

**â˜‘ TODO FE-4**â€‚â€” å®Œæˆä¸¤ä¸ªé¡µé¢ã€è¡¨å•æ ¡éªŒã€é€šçŸ¥çº¢ç‚¹åŠ¨ç”»ã€‚

---

## 5-Fâ€‚æµ‹è¯•çŸ©é˜µ

|ID|åœºæ™¯|æ­¥éª¤|æ–­è¨€|
|---|---|---|---|
|AE-T1|è§„åˆ™ GT è§¦å‘|å†™å…¥å€¼=120 > 100|history æ’å…¥ï¼›WS æ”¶åˆ°|
|AE-T2|é˜ˆå€¼æœªè§¦å‘|å†™å…¥ 80|æ—  history|
|AE-T3|è§„åˆ™ç¦ç”¨|PATCH enabled=false|Engine åœæ­¢ï¼›å†™å…¥ 120 ä»æ—  record|
|AE-T4|SMTP failover|æ–­ç½‘â†’é‚®ä»¶å¤±è´¥|history level=CRITï¼›Engine é‡è¯• 3 æ¬¡åæ”¾å¼ƒ|

_æ¡†æ¶_ï¼šåç«¯é›†æˆæµ‹è¯•ä½¿ç”¨ `testcontainers + smtp4dev + wiremock`ã€‚

**â˜‘ TODO TEST-3** â€” å®ç° AE-T1~T4ã€‚

---

## 5-Gâ€‚è¿ç»´ä¸æŒ‡æ ‡

|æŒ‡æ ‡|ç±»å‹|æ ‡ç­¾|
|---|---|---|
|`alert_rules_active`|Gauge|level|
|`alert_evaluations_total`|Counter|result=triggered/ok|
|`alert_notify_failures_total`|Counter|channel|

- æš´éœ²åœ¨ **alert-engine** `/metrics`ï¼›Prometheus scrapeã€‚

- Grafana JSON æ¨¡æ¿ï¼š`Alert Overview`ï¼ˆè§„åˆ™æ•°ã€è¿‘24 h è§¦å‘æ•°ã€é€šçŸ¥å¤±è´¥ç‡ï¼‰ã€‚


**â˜‘ TODO OPS-2** â€” å®ç° metrics (use `metrics` crate) + æäº¤ `grafana/alert_overview.json`.

---

## 5-Hâ€‚CI/CD å¢é‡

1. **GitHub Actions services**ï¼šsmtp4dev for SMTP channel.

2. **Job** `alerts-tests`ï¼šspin Influx+Postgres+smtp4dev â†’ run TEST-3.

3. **Docker Compose**ï¼šæ–°å¢ `alert-engine` serviceï¼Œdepends_on Postgres, Influx.


---

### 5-Iâ€‚Claude Code Checklistï¼ˆæ®µè½ 5 ä¸“å±ï¼‰

|ç¼–å·|ä»»åŠ¡|
|---|---|
|DB-3|åˆ›å»º `alert_rules` / `alert_history` è¡¨|
|AE-1|å®ç° `eval_loop` & Flux builder|
|AE-2|PG `LISTEN` çƒ­æ›´æ–° & task spawn|
|AE-3|SMTP/Webhook/WS é€šçŸ¥å™¨|
|BE-9|`/alerts/*` REST + WS|
|FE-4|`AlertRule.vue` / `AlertHistory.vue` + çº¢ç‚¹|
|TEST-3|AE-T1~T4 é€šè¿‡|
|OPS-2|Prometheus æŒ‡æ ‡ + Grafana JSON|
|CI|æ–° Job `alerts-tests`|

---

**å®Œæˆæœ¬æ®µåï¼Œä½ å°†å¾—åˆ°ï¼š**

- **ç½‘é¡µç«¯**ï¼šåœ¨â€œæŠ¥è­¦è§„åˆ™â€é¡µæ·»åŠ è§„åˆ™ï¼Œå¦‚â€œç”µæµ > 100 A æ¯ 10 s æ£€æµ‹â€ï¼›è§¦å‘æ—¶æµè§ˆå™¨çº¢ç‚¹å¼¹å‡ºã€é‚®ä»¶/Webhook åŒæ­¥ã€‚

- **åç«¯**ï¼š`alert-engine` æ¯æ¡è§„åˆ™ç‹¬ç«‹åç¨‹ï¼›Rule CRUD å³æ—¶ç”Ÿæ•ˆï¼›å¤±è´¥è‡ªåŠ¨é™çº§ã€‚

- **ç›‘æ§**ï¼šGrafana â€œAlert Overviewâ€ çœ‹ 24 h æŠ¥è­¦ã€‚


### **æ®µè½ 6ï¼šç›‘æ§ä¸æ—¥å¿—æ”¶é›†éƒ¨ç½²ï¼ˆPrometheus + Grafana + Lokiï¼‰**

> æœ¬æ®µä¸º _Gateway Rust_ æä¾›**å¯è§‚æµ‹æ€§åŸºåº§**ï¼šç»Ÿä¸€çš„æ€§èƒ½æŒ‡æ ‡ã€æŠ¥è­¦æŒ‡æ ‡ã€æ—¥å¿—æ£€ç´¢å’Œä»ªè¡¨ç›˜ã€‚ç›®æ ‡æ˜¯è®©å·¥ç¨‹å¸ˆèƒ½å¤Ÿåœ¨æœ¬åœ°æˆ–æœåŠ¡å™¨ç¯å¢ƒé€šè¿‡æ‰‹åŠ¨å¯åŠ¨çš„ç›‘æ§æ ˆå¿«é€Ÿå®šä½æ€§èƒ½ç“¶é¢ˆã€æ¥å£é”™è¯¯æˆ–é©±åŠ¨å¼‚å¸¸ã€‚éµå®ˆæœ¬æ®µåï¼Œæ‰€æœ‰æ ¸å¿ƒç»„ä»¶å‡æš´éœ² Prometheus æŒ‡æ ‡åŠç»“æ„åŒ–æ—¥å¿—ï¼ŒGrafana ä¸€é”®å¯¼å…¥ä»ªè¡¨ç›˜ï¼ŒLoki æ”¯æ’‘å…¨æ–‡æ£€ç´¢ã€‚

---

#### 6-Aâ€‚ç»„ä»¶ä¸ç‰ˆæœ¬é”å®š

|ç»„ä»¶|é•œåƒ Tag|ç«¯å£|ä½œç”¨|
|---|---|---|---|
|**Prometheus**|`prom/prometheus:2.52.0`|`9090`|æŒ‡æ ‡é‡‡é›†ä¸èšåˆ|
|**Grafana**|`grafana/grafana:10.4.0`|`3000`|å¯è§†åŒ–ä»ªè¡¨ç›˜|
|**Loki**|`grafana/loki:3.0.0`|`3100`|æ—¥å¿—èšåˆ|
|**Promtail**|`grafana/promtail:3.0.0`|â€“|å°†å®¹å™¨æ—¥å¿—æ¨é€è‡³ Loki|

_æ‰€æœ‰ç‰ˆæœ¬å†™æ­»ï¼Œä¸å¾—ä½¿ç”¨ `latest`_ã€‚

---

#### 6-Bâ€‚æ–°å¢ Compose æ–‡ä»¶ `docker/compose.monitor.yml`

```yaml
services:
  prometheus:
    image: prom/prometheus:2.52.0
    volumes:
      - ./monitor/prometheus.yml:/etc/prometheus/prometheus.yml
    ports: ["9090:9090"]

  grafana:
    image: grafana/grafana:10.4.0
    volumes:
      - grafana_data:/var/lib/grafana
      - ./monitor/grafana_dashboards:/var/lib/grafana/dashboards
    environment:
      - GF_DASHBOARDS_DEFAULT_HOME_DASHBOARD_PATH=/var/lib/grafana/dashboards/overview.json
    ports: ["3000:3000"]

  loki:
    image: grafana/loki:3.0.0
    command: -config.file=/etc/loki/local-config.yaml
    ports: ["3100:3100"]

  promtail:
    image: grafana/promtail:3.0.0
    volumes:
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - ./monitor/promtail-config.yml:/etc/promtail/config.yml
    command: -config.file=/etc/promtail/config.yml

volumes:
  grafana_data:
```

> æ‰‹åŠ¨å¯åŠ¨å‘½ä»¤ï¼š
>
> ```bash
> docker compose -f docker/compose.monitor.yml up
> ```

---

#### 6-Câ€‚Prometheus æŠ“å–é…ç½® `monitor/prometheus.yml`

```yaml
global:
  scrape_interval: 10s
scrape_configs:
  - job_name: api
    static_configs:
      - targets: ['host.docker.internal:8080']   # Actix API
  - job_name: alert_engine
    static_configs:
      - targets: ['host.docker.internal:9500']
  - job_name: postgres
    static_configs:
      - targets: ['postgres:9187']              # pg_exporterï¼ˆå¯é€‰ï¼‰
  - job_name: influxdb
    metrics_path: /metrics
    static_configs:
      - targets: ['influxdb:8086']
  - job_name: docker
    static_configs:
      - targets: ['host.docker.internal:9323']   # cAdvisor / node-exporter
```

_â˜‘ TODO MON-1_ â€”â€” Claude Code éœ€åœ¨ APIã€Alert-Engine äºŒè¿›åˆ¶å¯åŠ¨æ—¶è‡ªåŠ¨å¼€æ”¾ `/metrics`ï¼ˆè§ 6-Eï¼‰ã€‚

---

#### 6-Dâ€‚æ—¥å¿—ç»Ÿä¸€ï¼š`tracing` â†’ Loki

1. **JSON è¾“å‡º**ï¼šæ‰€æœ‰ Rust æœåŠ¡è®¾ç½®

    ```rust
    tracing_subscriber::fmt()
        .json()
        .with_max_level(cfg.log_level.parse()?)
        .with_current_span(true)
        .with_span_events(FmtSpan::CLOSE)
        .init();
    ```

2. **æ—¥å¿—è·¯ç”±**ï¼šDocker é€šè¿‡ Promtail è¯»å–å®¹å™¨ stdoutï¼›æœ¬åœ°è£¸è¿è¡Œå»ºè®®ä½¿ç”¨ `RUST_LOG=json` + file è·¯å¾„ï¼Œå¹¶è°ƒæ•´ `promtail-config.yml` æ–‡ä»¶ä¸­çš„ `__path__`.


---

#### 6-Eâ€‚æŒ‡æ ‡å¯¼å‡ºï¼ˆRust ç«¯ï¼‰

```rust
// Cargo.toml
metrics = "0.21"
metrics-exporter-prometheus = "0.14"

// main.rs
let recorder = PrometheusBuilder::new()
    .with_http_listener(cfg.metrics_addr)   // e.g., 0.0.0.0:8081
    .install_recorder()?;
```

|æ¨¡å—|æŒ‡æ ‡|è¯´æ˜|
|---|---|---|
|**API**|`http_requests_total`, `http_response_time_seconds` (Histogram)|label: method, path, status|
|**DriverManager**|`drivers_loaded_total`, `driver_reload_duration_seconds`|label: protocol|
|**Alert-Engine**|`alert_evaluations_total`, `alert_trigger_total`|label: result=ok/fired|
|**DB**|`sqlx_query_time_seconds`|label: query_hash|

_â˜‘ TODO MON-2_ â€”â€” åœ¨å„ crate å¼•å…¥ `#[instrument]` + `metrics::increment_counter! / histogram!`ã€‚

---

#### 6-Fâ€‚Grafana Dashboards

1. **overview.json** â€”â€” ç³»ç»Ÿæ¦‚è§ˆ

    - API QPS / P95 / Error Rate

    - Alert è§¦å‘æ•°

    - Influx write & query QPS

2. **driver.json** â€”â€” é©±åŠ¨åŠ è½½ä¸çƒ­é‡è½½è€—æ—¶

3. **alert.json** â€”â€” æ¯å°æ—¶æŠ¥è­¦ç»Ÿè®¡ + Top N è®¾å¤‡


æ”¾ç½®äº `monitor/grafana_dashboards/`ã€‚Grafana å¯åŠ¨æ—¶è‡ªåŠ¨å¯¼å…¥ã€‚

_â˜‘ TODO MON-3_ â€”â€” Claude Code éœ€æäº¤ `overview.json` åˆç‰ˆæ¨¡æ¿ï¼ˆå¯å¯¼å…¥å³æ˜¾ï¼‰ã€‚

---

#### 6-Gâ€‚å¸¸è§æ‰‹å·¥æ“ä½œæŒ‡å—ï¼ˆå†™å…¥ `docs/monitoring.md`ï¼‰

|ç›®æ ‡|å‘½ä»¤|
|---|---|
|æŸ¥çœ‹ API æŒ‡æ ‡|`curl [http://localhost:8081/metrics](http://localhost:8081/metrics)|
|Grafana é»˜è®¤è´¦æˆ·|`admin / admin`ï¼›é¦–æ¬¡ç™»å½•å¼ºåˆ¶ä¿®æ”¹|
|Loki æŸ¥è¯¢ç¤ºä¾‹|`{container="web-gw-api"}|
|æ¸…ç†ç›‘æ§æ ˆ|`docker compose -f docker/compose.monitor.yml down -v`|

_â˜‘ TODO MON-4_ â€”â€” åœ¨æ–‡æ¡£æ–°å¢ç« èŠ‚å¹¶å¡«å……ä¸Šè¿°è¡¨æ ¼ã€‚

---

#### 6-Hâ€‚å˜æ›´é€šå‘Šæ¨¡æ¿

è‹¥ Claude Code è°ƒæ•´æˆ–æ–°å¢æŒ‡æ ‡è·¯å¾„ã€ç«¯å£ã€dashboardï¼Œéœ€é™„ï¼š

```
ğŸ“£ Monitoring-Update
æ–°å¢æŒ‡æ ‡: drivers_loaded_total{protocol}
Grafana é¢æ¿: driver.json v0.2
æ‰‹åŠ¨åˆ·æ–°: docker compose -f docker/compose.monitor.yml up -d prometheus grafana
```

---

#### 6-Iâ€‚ç»¼åˆ TODO åˆ—è¡¨ï¼ˆæ®µè½ 6 ä¸“å±ï¼‰

|ç¼–å·|å†…å®¹|
|---|---|
|MON-1|åœ¨ `web-gw-api`, `alert-engine` æš´éœ² `/metrics` listener|
|MON-2|æ’å…¥ `metrics` å®åˆ° API ä¸­é—´ä»¶ã€é©±åŠ¨é‡è½½ã€æŠ¥è­¦è¯„ä¼°é€»è¾‘|
|MON-3|æäº¤ Grafana `overview.json` åˆç‰ˆ|
|MON-4|æ›´æ–° `docs/monitoring.md` æ‰‹å†Œ|
|_æ‰‹åŠ¨æ“ä½œ_|ç”¨æˆ·è‡ªè¡Œ `docker compose -f docker/compose.monitor.yml up`|

---
### **æ®µè½ 7ï¼šç«¯åˆ°ç«¯è°ƒè¯•æ‰‹å†Œï¼ˆæ¥å£æ’é”™ä¸æ€§èƒ½å‰–æï¼‰**

> æœ¬æ®µæä¾›ä¸€å¥— **â€œä»æµè§ˆå™¨ç‚¹å‡»åˆ°é©±åŠ¨è¿”å›â€** çš„å®Œæ•´è°ƒè¯•æµç¨‹ä¸é—®é¢˜å®šä½æŒ‡å—ï¼Œé¿å…å‡ºç°æ¥å£ä¸é€šã€æ•°æ®é”™ä½æˆ–æ€§èƒ½ç“¶é¢ˆæ—¶è€—è´¹å¤§é‡äººå·¥æ’æŸ¥ã€‚è¦†ç›– **HTTP / WebSocket / Frame-Bus / é©±åŠ¨ / æ•°æ®åº“ / æŒ‡æ ‡ / æ—¥å¿—** å…­å¤§é“¾è·¯ã€‚æ‰€æœ‰å·¥ç¨‹å¸ˆä¸è‡ªåŠ¨åŒ–ä»£ç†ï¼ˆClaude Codeï¼‰åœ¨å¼€å‘æˆ–éªŒæ”¶è¿‡ç¨‹ä¸­åº”ä¸¥æ ¼æŒ‰ç…§æœ¬æ‰‹å†Œæ‰§è¡Œæ’é”™æ­¥éª¤ã€‚

---

#### 7-Aâ€‚å‡†å¤‡å·¥ä½œ

|æ­¥éª¤|å‘½ä»¤|è¯´æ˜|
|---|---|---|
|â‘  å¯åŠ¨åŸºç¡€æ ˆ|`make run-dev`|Postgres / Influx / NATS å®¹å™¨å°±ç»ª|
|â‘¡ å¯åŠ¨åç«¯|`cargo run -p web-gw-api`|åœ¨ç¬¬äºŒç»ˆç«¯ï¼›è§‚å¯Ÿ log `Server running @ 0.0.0.0:8080`|
|â‘¢ å¯åŠ¨å‰ç«¯|`npm --prefix web-ui run dev`|æ‰“å¼€ [http://localhost:5173](http://localhost:5173/)|
|â‘£ å¯åŠ¨ç›‘æ§|`docker compose -f docker/compose.monitor.yml up -d`|Grafana ç«¯å£ `3000`ï¼ŒPrometheus `9090`|
|â‘¤ æµè§ˆå™¨æ’ä»¶|å®‰è£… **REST Client** æˆ– **Thunder Client**ï¼Œç”¨äºå¿«é€Ÿé‡æ”¾ API||

---

#### 7-Bâ€‚æ¥å£æ’é”™åˆ†å±‚æµç¨‹

> **å‡ºç° 4xx/5xxã€WebSocket æœªè¿é€šæˆ–å‰ç«¯ç©ºç™½æ—¶ï¼Œä¾æ¬¡æ‰§è¡Œä¸‹åˆ—æ­¥éª¤**ï¼š

1. **æµè§ˆå™¨ DevTools**

    - Network â†’ æ‰¾åˆ°å¤±è´¥è¯·æ±‚

    - åˆ¤æ–­ï¼š

        - æ— è¯·æ±‚å‘å‡º â†’ æ£€æŸ¥å‰ç«¯ `env` API URL æˆ–è·¯ç”±è·¯å¾„

        - çŠ¶æ€ç  4xx â†’ åç«¯å‚æ•°æ ¡éªŒä¸é€šè¿‡ï¼›æŸ¥çœ‹ Response `detail`

        - çŠ¶æ€ç  5xx â†’ ç»§ç»­ä¸‹ä¸€æ­¥

2. **åç«¯æ—¥å¿—ï¼ˆLoki æˆ– stdoutï¼‰**

    - æŸ¥è¯¢ `{container="web-gw-api"} |= "error" |= "X-Trace-Id=<id>"`

    - è‹¥æœªæ‰¾åˆ° `Trace-Id`ï¼Œåˆ™è¯´æ˜è¯·æ±‚æœªè¾¾åˆ°åç«¯ï¼›å›åˆ°â‘ 

3. **Prometheus æŒ‡æ ‡**

    - æ‰“å¼€ [http://localhost:9090/graph](http://localhost:9090/graph) æ‰§è¡Œ

        ```
        http_response_time_seconds_count{path="/api/v1/devices"}
        ```

    - è‹¥è®¡æ•°ä¸º 0ï¼Œè¯´æ˜ Handler æœªæ³¨å†Œæˆ–è·¯ç”±å†²çªã€‚

4. **sqlx æŸ¥è¯¢æ—¶é—´è¿‡é•¿**

    - æŸ¥è¯¢

        ```
        sqlx_query_time_seconds_bucket{le="0.5"}
        ```

    - è‹¥é«˜åˆ†ä½ >0.5 ç§’ï¼Œæ£€æŸ¥ç´¢å¼•æˆ– SQLã€‚

5. **Frame-Bus âœ é©±åŠ¨**

    - å‘é€æ§åˆ¶å‘½ä»¤åæ— åé¦ˆ â†’ è¿è¡Œ

        ```
        frame_bus_lag{device_id="<uuid>"}
        ```

    - Lag >1 åˆ™ç¯å½¢ç¼“å†²æº¢å‡ºï¼›éœ€æ‰©ç¯æˆ–å‡å°‘æ¨é€é¢‘ç‡ã€‚

6. **Influx æ•°æ®ç¼ºå¤±**

    - ä½¿ç”¨ Influx UI æˆ– `influx query` æ£€æŸ¥å†™å…¥ï¼›è‹¥æ— ç‚¹ï¼Œæ’æŸ¥é©±åŠ¨ã€‚

7. **WebSocket å®æ—¶æµå¼‚å¸¸**

    - æµè§ˆå™¨ WS é¢æ¿ï¼šPing/Pong æ­£å¸¸ä½†æ— æ•°æ® â†’ æ£€æŸ¥ Step 5 ä¸ Influxã€‚

8. **å‰ç«¯ç±»å‹é”™è¯¯**

    - æ§åˆ¶å°æŠ¥ `zod` schema fail â†’ æ›´æ–°åç«¯ DTO æˆ–å‰ç«¯ OpenAPI ç±»å‹ã€‚


---

#### 7-Câ€‚æ€§èƒ½å‰–æï¼ˆAPI P95 > 300 ms æ—¶ï¼‰

1. **curl Benchmark**

    ```bash
    curl -w "total:%{time_total}\n" -H "X-Trace-Id:debug" \
      http://localhost:8080/api/v1/history/query?... -o /dev/null
    ```

    - è‹¥ `time_total` > 0.3 sï¼Œç»§ç»­ä¸‹ä¸€æ­¥ã€‚

2. **pprof** (dev feature)

    - å¯åŠ¨ API `cargo run -p web-gw-api --features dev-prof`

    - æµè§ˆ [http://localhost:6060/pprof](http://localhost:6060/pprof) ä¸‹è½½ç«ç„°å›¾ã€‚

3. **çƒ­ç‚¹åˆ†ç±»**

    - SQL >60 % â†’ æ–°ç´¢å¼•æˆ–åˆ†é¡µï¼›Influx èšåˆ â†’ down-sampleã€‚

    - JSON åºåˆ—åŒ– >20 % â†’ æ‰“å¼€ `serde_json::to_writer` + `rustc lto`ã€‚

    - é”äº‰ç”¨ â†’ ç²’åº¦åŒ– Mutex æˆ–æ”¹ `dashmap`.


---

#### 7-Dâ€‚å‰ç«¯å®æ—¶æµç¼ºå£è°ƒè¯•

|ç—‡çŠ¶|æ’æŸ¥ç‚¹|ä¿®å¤å»ºè®®|
|---|---|---|
|æ›²çº¿æ–­ç‚¹|WS æ–­â†’é‡è¿æˆåŠŸå `series` ä»ç©º|`useTelemetry` åº”åœ¨ `onclose` 5 s åè‡ªåŠ¨é‡è¿|
|å¤šè®¾å¤‡æ··æµ|è¿”å› `device_id` ä¸åŒ¹é…|åç«¯ `Filter::by_device` å®ç°æ˜¯å¦é”™è¯¯|
|ç‚¹ä½é¡ºåºé”™ä¹±|ECharts X è½´ä¸ºæ—¶é—´ä½†æ•°æ®æœªæ’åº|åœ¨ Hook ä¸­ `array.sort((a,b)=>a.ts-b.ts)`|

---

#### 7-Eâ€‚é©±åŠ¨çƒ­é‡è½½å›å½’éªŒè¯

1. ä¸Šä¼ æ–° `.so` â†’ æ¥å£è¿”å› `{"action":"loaded"}`ã€‚

2. Prometheus `drivers_loaded_total{protocol="ModbusTcp"}` +1ã€‚

3. Device `attach` å 30 s å†…ï¼ŒGrafana Driver é¢æ¿ â€œReload Durationâ€ æ›²çº¿æ›´æ–°ã€‚

4. å†å²æŸ¥è¯¢æ¥å£ä»è¿”å›è¿ç»­æ•°æ®ï¼›å¦åˆ™å¤æŸ¥é©±åŠ¨æŒ‡é’ˆå®‰å…¨ã€‚


---

#### 7-Fâ€‚å¸¸ç”¨ CLI æ‘˜è¦ï¼ˆå†™å…¥ `docs/debug_cheatsheet.md`ï¼‰

|åœºæ™¯|å‘½ä»¤|
|---|---|
|Postgres shell|`docker exec -it pg psql -U postgres iot`|
|Influx shell|`docker exec -it influxdb influx`|
|Frame-Bus dump|`cargo run -p frame-bus -- dump --device <id>`|
|Tail 20 æ¡é”™è¯¯æ—¥å¿—|`docker logs --tail 20 web-gw-api|
|æ‰‹åŠ¨æ¨æ•°æ®åˆ° Influx|`curl -XPOST $INFLUX/write -d 'tag_data,device_id=... f_value=1 0'`|

_â˜‘ TODO DEBUG-1_ â€” Claude Code éœ€ç”Ÿæˆ `docs/debug_cheatsheet.md` å¡«å……ä¸Šè¡¨ã€‚

---

#### 7-Gâ€‚å®Œæˆæ¸…å•ï¼ˆæ®µè½ 7 ä¸“å±ï¼‰

|ç¼–å·|åŠ¨ä½œ|
|---|---|
|DEBUG-1|åˆ›å»º/æ›´æ–° `docs/debug_cheatsheet.md`|
|â€“|è‹¥æ–°å¢æ’æŸ¥æ­¥éª¤æˆ–å‘½ä»¤ï¼Œè¯·åŒæ­¥åˆ°æ­¤æ‰‹å†Œ|
