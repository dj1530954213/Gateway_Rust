# 系统架构 - C4模型 L1/L2

## 概述

Gateway_Rust是一个高性能工业物联网边缘网关系统，采用事件驱动微服务架构，以Frame Bus为核心的消息总线实现解耦和高吞吐量处理。

## C4 Level 1 - 系统上下文

系统在工业物联网生态中的定位：

```mermaid
C4Context
    title 工业物联网边缘网关 - 系统上下文
    
    Person(operator, "操作员", "监控设备状态")
    Person(engineer, "工程师", "配置和维护系统")
    
    System(gateway, "Edge Gateway", "工业边缘网关系统\n数据采集与处理")
    
    System_Ext(plc, "PLC设备", "工业控制器\nModbus TCP/S7协议")
    System_Ext(sensors, "传感器", "各类工业传感器\n数据采集")
    System_Ext(cloud, "云平台", "MQTT/HTTP\n数据上传和分析")
    System_Ext(scada, "SCADA系统", "工厂监控系统")
    
    Rel(operator, gateway, "Web界面监控")
    Rel(engineer, gateway, "配置管理")
    Rel(gateway, plc, "Modbus TCP")
    Rel(gateway, sensors, "协议采集")
    Rel(gateway, cloud, "MQTT5")
    Rel(gateway, scada, "OPC-UA")
```

## C4 Level 2 - 容器架构

```mermaid
C4Container
    title Edge Gateway - 容器架构
    
    Person(user, "用户")
    
    Container_Boundary(gateway, "Edge Gateway") {
        Container(web_ui, "Web UI", "Vue 3 + TypeScript", "管理界面")
        Container(web_api, "Web API", "Actix-Web + Rust", "REST API + WebSocket")
        Container(frame_bus, "Frame Bus", "Rust + RocksDB", "消息总线\n数据路由中心")
        Container(driver_mgr, "Driver Manager", "Rust", "驱动管理器")
        Container(protocol_bridge, "Protocol Bridge", "Rust", "协议转换桥接")
        Container(mqtt_connector, "MQTT Connector", "Rust", "数据上传连接器")
    }
    
    ContainerDb(postgres, "PostgreSQL", "关系数据库\n配置和用户数据")
    ContainerDb(influx, "InfluxDB", "时序数据库\n测量数据存储")
    ContainerDb(rocksdb, "RocksDB", "WAL存储\nFrame Bus持久化")
    
    System_Ext(devices, "工业设备")
    System_Ext(cloud_platform, "云平台")
    
    Rel(user, web_ui, "HTTPS", "50020")
    Rel(web_ui, web_api, "HTTP/WS", "50013")
    Rel(web_api, frame_bus, "消息订阅")
    Rel(web_api, postgres, "SQL查询")
    Rel(web_api, influx, "时序查询")
    
    Rel(driver_mgr, frame_bus, "数据发布")
    Rel(frame_bus, rocksdb, "WAL持久化")
    Rel(frame_bus, protocol_bridge, "数据桥接")
    Rel(protocol_bridge, mqtt_connector, "转发")
    
    Rel(driver_mgr, devices, "协议通信")
    Rel(mqtt_connector, cloud_platform, "MQTT5")
```

## C4 Level 3 - 核心组件详细设计

### Frame Bus 核心组件

```mermaid
C4Component
    title Frame Bus - 核心组件
    
    Component(ring, "Ring Buffer", "lock-free环形缓冲区", "高速数据传输")
    Component(wal, "WAL Manager", "Write-Ahead Log", "数据持久化")
    Component(filter, "Filter Engine", "过滤器", "数据路由")
    Component(metrics, "Metrics Collector", "性能监控", "指标收集")
    Component(batch, "Batch Publisher", "批量发布器", "批处理优化")
    
    ComponentDb(rocksdb_wal, "RocksDB WAL", "持久化存储")
    
    Rel(ring, wal, "持久化请求")
    Rel(wal, rocksdb_wal, "批量写入")
    Rel(ring, filter, "数据过滤")
    Rel(ring, metrics, "性能监控")
    Rel(batch, ring, "批量写入")
```

### Driver Manager 核心组件

```mermaid
C4Component
    title Driver Manager - 核心组件
    
    Component(registry, "Driver Registry", "驱动注册表", "静态驱动管理")
    Component(loader, "Dynamic Loader", "动态加载器", "热插拔支持")
    Component(supervisor, "Driver Supervisor", "监控管理器", "生命周期管理")
    Component(sdk, "Driver SDK", "驱动SDK", "驱动开发接口")
    
    Component_Ext(modbus_driver, "Modbus Driver")
    Component_Ext(s7_driver, "S7 Driver")
    Component_Ext(custom_driver, "Custom Driver")
    
    Rel(registry, modbus_driver, "静态注册")
    Rel(loader, s7_driver, "动态加载")
    Rel(loader, custom_driver, "插件加载")
    Rel(supervisor, registry, "生命周期管理")
    Rel(supervisor, loader, "热重载控制")
```

## 核心设计原则

### 1. 事件驱动架构
- **中央消息总线**: Frame Bus作为核心数据枢纽，实现组件解耦
- **异步处理**: 基于Tokio的高性能异步处理
- **持久化保证**: WAL机制确保数据不丢失

### 2. 高可扩展性
- **插件化**: 驱动系统支持热插拔
- **协议无关**: 统一的驱动接口
- **水平扩展**: 支持分布式部署

### 3. 高性能设计
- **Zero-copy**: 数据传输避免不必要复制
- **Lock-free**: 环形缓冲区无锁设计
- **批量处理**: 提高吞吐量的批处理机制
- **指标收集**: 实时性能监控和调优

### 4. 可靠性保证
- **持久化存储**: 驱动持久化和数据完整性保证
- **错误隔离**: 组件间错误隔离机制
- **数据完整性**: 端到端数据完整性检查

## 性能指标

### 核心性能突破
- **Frame Bus延迟**: <1ms (从原来500ms优化500倍)
- **数据吞吐量**: 1000+数据点/秒
- **并发连接**: 100+设备同时连接
- **数据库连接池**: 获取延迟<10ms
- **内存使用**: 稳定在100MB以内

### 系统容量
- **设备支持数量**: 1000+
- **标签点支持数量**: 10000+
- **历史数据保留**: 6个月
- **实时数据延迟**: 100ms

## 技术栈选型

### 后端技术栈
- **核心语言**: Rust 2021 Edition
- **异步运行时**: Tokio
- **Web框架**: Actix-Web 4.4
- **数据库**: PostgreSQL + InfluxDB + RocksDB
- **协议支持**: Modbus TCP, S7, OPC-UA, MQTT5

### 前端技术栈
- **框架**: Vue 3 + Composition API
- **语言**: TypeScript
- **UI组件**: Element Plus
- **状态管理**: Pinia
- **构建工具**: Vite

### 运维监控
- **容器化**: Docker + Docker Compose
- **监控**: Prometheus + Grafana
- **日志**: structured logging + Loki
- **API文档**: OpenAPI 3.0 + Swagger UI

## 安全架构

### 认证授权
- **JWT Token**: 无状态身份认证
- **RBAC**: 基于角色的访问控制
- **CORS**: 跨域资源共享控制

### 数据安全
- **传输加密**: HTTPS/TLS 1.3
- **数据脱敏**: 敏感数据混淆处理
- **SQL注入防护**: 参数化查询

### 系统安全
- **容器隔离**: Docker安全配置
- **网络隔离**: 安全网络策略
- **漏洞扫描**: 定期安全检查

---

**文档版本**: v1.0
**最后更新**: 2025-01-17
**文档作者**: Edge Gateway Team