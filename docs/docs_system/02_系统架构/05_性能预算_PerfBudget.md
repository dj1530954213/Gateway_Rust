# 性能预算 (Performance Budget)

## 概述

性能预算定义了Gateway_Rust工业网关系统各项关键性能指标的目标值，用作性能监控和持续优化的基准线。确保系统在生产环境中保持高性能、低延迟的稳定运行。

## 核心性能指标

### 关键性能指标

| 性能指标 | 目标值 | 最低值 | 单位 | 监控频率 |
|---------|--------|--------|------|----------|
| **响应延迟** | <30秒 | <10秒 | 响应 | 实时监控1秒 |
| **内存使用率** | <200MB | <100MB | 响应 | RSS内存监控 |
| **CPU使用率** | <30% | <15% | 响应 | 系统负载监控 |
| **系统可用性** | 99.9% | 99.95% | 响应 | 健康检查监控 |
| **恢复时间** | <60秒 | <10秒 | 响应 | 故障恢复评估 |

### 重大性能突破成果

**Frame Bus性能突破** (2025-01-13)：
- **延迟优化**: 500ms → <1ms (**500倍提升**)
- **吞吐量**: 100条/秒 → 1000+条/秒 (**10倍提升**)
- **内存优化**: 200MB → 100MB (**50%减少**)

## 分组件性能指标

### 1. Frame Bus 消息总线

**关键指标**：
| 指标 | P50 | P95 | P99 | P99.9 | 阈值 |
|------|-----|-----|-----|-------|------|
| **消息延迟** | 0.2ms | 0.6ms | 0.8ms | 1.5ms | <5ms |
| **吞吐量** | 800/s | 1200/s | 1500/s | 2000/s | >500/s |
| **缓冲使用率** | 5% | 15% | 25% | 40% | <80% |

**性能监控**：
```rust
// 关键指标监控
struct FrameBusMetrics {
    pub latency_p99: Histogram,           // 99%分位延迟
    pub throughput: Counter,              // 消息吞吐量
    pub buffer_usage: Gauge,              // 缓冲使用率
    pub backpressure_events: Counter,     // 背压发生次数
    pub wal_write_latency: Histogram,     // WAL写入延迟
}
```

**性能优化策略**：
- **批处理优化**: 高达2000条/批次，1ms内完成
- **Lock-free设计**: 避免锁竞争，降低延迟影响
- **背压控制**: 80%阈值启动背压防护
- **内存池**: 预分配池减少GC影响

### 2. 驱动管理器

**性能指标**：
| 操作 | 目标延迟 | 最低性能 | 单位 |
|------|----------|----------|------|
| **驱动加载** | <5秒 | <2秒 | 响应 |
| **连接建立** | <3秒 | <1秒 | 响应 |
| **热重载** | <10秒 | <5秒 | 响应 |
| **错误恢复** | <30秒 | <10秒 | 响应 |

**并发性能**：
- **同时连接数**: 1000+ 工业设备连接
- **并发操作**: 100+ 并发数据读取操作
- **内存占用**: 每个驱动 <1MB 内存开销

### 3. Web API 服务

**HTTP性能指标**：
| 接口类型 | P95延迟 | P99延迟 | QPS目标 | 最低QPS |
|---------|---------|---------|---------|---------|
| **设备查询** | <100ms | <200ms | 100/s | 150/s |
| **历史数据** | <500ms | <1s | 50/s | 80/s |
| **实时数据** | <50ms | <100ms | 200/s | 300/s |
| **配置管理** | <200ms | <400ms | 20/s | 50/s |

**WebSocket性能**：
- **连接数**: 同时500个连接
- **消息延迟**: <10ms (Frame Bus → WebSocket)
- **吞吐量**: 1000+ 消息/秒每连接

### 4. 数据存储层

**PostgreSQL性能**：
| 操作类型 | P95延迟 | P99延迟 | TPS目标 | 连接池 |
|---------|---------|---------|---------|---------|
| **简单查询** | <10ms | <20ms | 1000/s | 20-100 |
| **复杂查询** | <100ms | <200ms | 100/s | 20-100 |
| **数据写入** | <50ms | <100ms | 500/s | 20-100 |
| **批量写入** | <200ms | <500ms | 50/s | 20-100 |

**InfluxDB性能**：
- **写入延迟**: P99 < 50ms
- **查询延迟**: P95 < 200ms
- **数据保留**: 6个月自动循环
- **批量写入**: 1000条/批次

**RocksDB WAL性能**：
- **写入延迟**: P99 < 5ms
- **恢复时间**: <10秒 (重启WAL重放)
- **存储压缩**: 压缩比 > 3:1
- **日志保持**: 滚动24小时数据

## 网络性能指标

### 1. 南向通信 (工业连接)

**Modbus TCP性能**：
| 指标 | 目标值 | 理想值 | 单位 |
|------|--------|--------|------|
| **连接建立** | <1秒 | <500ms | 响应 |
| **查询延迟** | <100ms | <50ms | 响应 |
| **并发连接** | 100设备 | 150设备 | 响应 |
| **错误率** | <1% | <0.1% | 响应 |

**网络优化**：
- **连接复用**: 每个设备复用连接
- **批量查询**: 单次请求多个寄存器
- **连接池**: 5秒连接超时，3次重试机制
- **异常处理**: 断线自动3次重连

### 2. 北向通信 (云端连接)

**MQTT性能**：
- **发布延迟**: P99 < 100ms
- **连接可靠性**: >99.9%在线率
- **消息大小**: 平均1KB，最大10KB
- **QoS保证**: QoS1保证消息传达

## 资源使用预算

### 1. CPU资源分配

| 组件 | CPU占用 | 理想使用 | 单位 |
|------|---------|----------|------|
| **Frame Bus** | 30% | 20% | 响应 |
| **驱动管理器** | 25% | 15% | 响应 |
| **Web API** | 20% | 10% | 响应 |
| **数据库** | 15% | 8% | 响应 |
| **其他** | 10% | 5% | 响应 |

### 2. 内存资源分配

```
总体内存预算: 200MB
├── Frame Bus: 50MB (环形缓冲区 + WAL缓存)
├── 驱动组件: 40MB (驱动实例 + 工业连接)
├── Web API: 30MB (HTTP服务 + WebSocket连接)
├── 数据库连接: 40MB (连接池 + 查询缓存)
├── 其他开销: 20MB (Rust运行时 + OS缓存)
└── 备用缓冲: 20MB (应急处理)
```

### 3. 存储预算

**磁盘使用预算**：
- **WAL存储**: 1GB (24小时数据)
- **配置文件**: 500MB (驱动配置)
- **配置日志**: 100MB (历史配置)
- **系统缓存**: 1GB (OS和应用缓存)

## 性能监控策略

### 1. 实时监控指标

**Prometheus指标收集**：
```rust
// 关键性能指标
struct PerformanceMetrics {
    // 延迟指标
    pub frame_bus_latency: HistogramVec,
    pub api_response_time: HistogramVec,
    pub database_query_time: HistogramVec,
    
    // 吞吐量指标
    pub messages_per_second: CounterVec,
    pub requests_per_second: CounterVec,
    pub data_points_per_second: CounterVec,
    
    // 资源指标
    pub memory_usage: GaugeVec,
    pub cpu_usage: GaugeVec,
    pub disk_usage: GaugeVec,
}
```

### 2. 告警阈值

**关键告警规则**：
| 指标 | 警告阈值 | 严重阈值 | 处理策略 |
|------|----------|----------|----------|
| **Frame Bus延迟** | P99 > 2ms | P99 > 5ms | 容量缩放 |
| **内存使用率** | >80% | >90% | 内存清理 |
| **CPU使用率** | >70% | >85% | 负载均衡 |
| **错误率** | >1% | >5% | 主动修复 |
| **磁盘使用** | >80% | >90% | 数据清理 |

### 3. 性能基准测试

**基准测试场景**：
```bash
# Frame Bus基准测试
测试场景: 1000工业设备 → 10条记录/设备 → 1秒钟持续
数据负载: 10000 数据点/秒
持续时间: 24小时
期望结果: P99延迟 < 5ms, 错误率 < 0.1%

# API基准测试  
测试场景: 100并发用户 → 多种API调用
目标QPS: 500 请求/秒
持续时间: 1小时
期望结果: P95延迟 < 200ms, 成功率 > 99%
```

## 性能优化策略

### 1. 优化策略

**主动配置**：
- **批处理优化**: 高达批处理大小的批处理数据优化
- **连接池化**: 高达并发连接数管理优化连接性能
- **缓存策略**: 分层数据缓存，减少数据库访问

### 2. 性能降级策略

**分级降级**：
```
Level 1 (负载70-80%): 
  - 启用批处理优化
  - 连接复用

Level 2 (负载80-90%):
  - 限制背压控制
  - 调整缓冲区

Level 3 (负载90%+):
  - 关闭非关键服务
  - 最大性能模式
```

### 3. 扩容计划

**横向扩容**：
- **Frame Bus**: 支持分布式部署，分片处理
- **Web API**: 无状态设计，支持负载均衡
- **数据库**: 读写分离，分片存储

**纵向扩容**：
- **CPU密集**: Frame Bus, 驱动管理器
- **内存密集**: 数据缓存, 连接池
- **IO密集**: 数据库操作, 文件存储

## 性能测试基线

### 当前性能基线（2025-01-17）

**测试环境**：
- **硬件**: 4核CPU, 8GB内存, SSD存储
- **负载**: 500工业设备, 5000数据点, 24小时测试

**测试结果**：
| 指标 | 测试结果 | 目标值 | 结论 |
|------|----------|--------|----------|
| **Frame Bus P99延迟** | 0.8ms | <5ms | ✅ 超标准 |
| **数据吞吐量** | 1200条/秒 | 500条/秒 | ✅ 超标准 |
| **内存峰值使用** | 95MB | <200MB | ✅ 超标准 |
| **CPU平均使用** | 12% | <30% | ✅ 超标准 |
| **API响应P95** | 45ms | <100ms | ✅ 超标准 |
| **系统可用性** | 99.98% | 99.9% | ✅ 超标准 |

## 后续优化计划

### 短期优化 (1-3个月)
- [ ] Frame Bus缓冲区优化
- [ ] 数据库查询优化批处理数据
- [ ] WebSocket连接池优化
- [ ] 内存分配管理调优

### 中期优化 (3-6个月)
- [ ] 分布式Frame Bus架构
- [ ] 智能缓存策略实施
- [ ] 协议解析性能优化
- [ ] 负载均衡实现

### 长期优化 (6-12个月)
- [ ] GPU加速数据处理
- [ ] 容器化性能测试基准
- [ ] 主动性能调优
- [ ] 端到端单元测试

---

**文档版本**: v1.0  
**最后更新**: 2025-01-17  
**性能基线**: 2025-01-13 优化完成  
**审核期限**: 2025-04-17