# SRS - 功能需求规格书

## 文档信息
- **文档版本**: 1.0
- **创建日期**: 2025-01-17
- **最后更新**: 2025-01-17  
- **负责人**: Gateway_Rust 系统团队
- **状态**: 完整规范

## 功能需求概述

本文档定义 Gateway_Rust 系统的所有功能性需求，基于实际代码实现提供准确的功能规格说明。

## 核心功能需求

### FR-001: 设备管理

**需求描述**: 系统必须支持工业设备的全生命周期管理

**详细子需求**:
- **FR-001-01**: 支持 ModbusTCP、OPC-UA、MQTT 协议设备管理
- **FR-001-02**: 提供设备CRUD操作接口 (`POST/GET/PUT/DELETE /api/v1/devices`)
- **FR-001-03**: 支持设备启用/禁用状态管理
- **FR-001-04**: 支持设备配置JSON格式存储和验证
- **FR-001-05**: 确保设备名称唯一性约束

**验证标准**:
```http
# 创建设备
POST /api/v1/devices
{
  "name": "PLC-001",
  "protocol": "ModbusTcp", 
  "endpoint": "tcp://192.168.1.100:502",
  "enabled": true
}
# 响应: 201 Created, 返回设备ID
```

**实现状态**: ✓ 已实现 (`core/web-gw-api/src/routes/devices.rs`)

### FR-002: 数据点管理

**需求描述**: 系统必须支持设备数据点配置和管理

**详细子需求**:
- **FR-002-01**: 支持 Float、Int、Bool、String 数据类型
- **FR-002-02**: 支持Modbus地址映射 (如40001标准地址)
- **FR-002-03**: 支持数据变换(scaling)和偏移(offset)变换
- **FR-002-04**: 提供批量操作接口
- **FR-002-05**: 支持数据点启用/禁用状态

**验证标准**:
```http
# 创建数据点
POST /api/v1/tags
{
  "device_id": "uuid",
  "name": "temperature_sensor_1", 
  "address": "40001",
  "data_type": "Float",
  "scaling": 0.1,
  "unit": "°C"
}
# 响应: 201 Created, 返回数据点配置
```

**实现状态**: ✓ 已实现 (`core/web-gw-api/src/routes/tags.rs`)

### FR-003: 实时数据传输

**需求描述**: 系统必须提供实时数据采集和传输能力

**详细子需求**:
- **FR-003-01**: 支持WebSocket实时数据推送
- **FR-003-02**: 支持选择设备/数据点选择性订阅
- **FR-003-03**: 支持数据采样频率控制 (灵活配置)
- **FR-003-04**: 支持最多1000并发WebSocket连接
- **FR-003-05**: 实现数据背压控制和缓解机制

**验证标准**:
```javascript
// WebSocket订阅
const ws = new WebSocket('ws://localhost:50013/ws/telemetry');
ws.send(JSON.stringify({
  "type": "Subscribe",
  "data": {
    "device_ids": ["device-uuid"],
    "sample_interval_ms": 1000
  }
}));
// 响应: 每秒遥测数据推送
```

**实现状态**: ✓ 已实现 (`core/web-gw-api/src/routes/websocket.rs`)

### FR-004: 驱动管理

**需求描述**: 系统必须支持协议驱动加载和生命周期管理

**详细子需求**:
- **FR-004-01**: 支持静态驱动编译时集成
- **FR-004-02**: 支持动态驱动运行时加载 (.so/.dll文件)
- **FR-004-03**: 提供驱动生命周期管理接口
- **FR-004-04**: 支持驱动配置参数管理
- **FR-004-05**: 实现驱动隔离性和错误隔离

**验证标准**:
```http
# 上传动态驱动
POST /api/v1/drivers/upload
Content-Type: multipart/form-data
files: [custom_driver.so]

# 响应: 驱动注册成功并可用
GET /api/v1/drivers
# 响应: 列表中包含上传驱动
```

**实现状态**: ⚠ 部分实现 (`core/driver-manager/`, 静态驱动完整，动态驱动框架存在)

### FR-005: 历史数据查询

**需求描述**: 系统必须提供历史数据存储和查询能力

**详细子需求**:
- **FR-005-01**: 支持时间范围历史数据查询 (ISO8601格式)
- **FR-005-02**: 支持数据聚合查询 (mean/min/max/sum/count)
- **FR-005-03**: 支持时间窗口聚合 (1s/1m/1h)
- **FR-005-04**: 提供CSV格式数据导出
- **FR-005-05**: 支持分页查询机制 (最多10000条/页)

**验证标准**:
```http
# 历史数据查询
GET /api/v1/history/data?device_id=uuid&start_time=2025-01-01T00:00:00Z&end_time=2025-01-01T23:59:59Z&limit=1000

# 聚合查询
GET /api/v1/history/aggregated?device_id=uuid&window=1h&function=mean

# 响应: 时间序列历史数据
```

**实现状态**: ✓ 已实现 (`core/web-gw-api/src/routes/history.rs`)

### FR-006: 告警管理

**需求描述**: 系统必须提供智能告警规则配置和通知

**详细子需求**:
- **FR-006-01**: 支持多种比较运算 (GT/LT/GTE/LTE/EQ/NE)
- **FR-006-02**: 支持多级告警级别 (INFO/WARN/CRIT)
- **FR-006-03**: 支持告警评估频率配置
- **FR-006-04**: 保存告警历史记录和查询
- **FR-006-05**: 提供WebSocket实时告警通知

**验证标准**:
```http
# 创建告警规则
POST /api/v1/alerts/rules
{
  "name": "温度超标告警",
  "device_id": "device-uuid",
  "tag_id": "tag-uuid", 
  "op": "GT",
  "threshold": 50.0,
  "level": "WARN"
}

# 响应: 当温度超过50°C时触发告警并WebSocket通知
```

**实现状态**: ✓ 已实现 (`core/web-gw-api/src/routes/alerts.rs`)

## 性能需求

### FR-007: 系统性能要求

**需求描述**: 系统必须满足严格性能标准

**详细子需求**:
- **FR-007-01**: API响应时间 < 100ms (P95)
- **FR-007-02**: WebSocket推送延迟 < 50ms
- **FR-007-03**: 支持1000+数据点/秒处理
- **FR-007-04**: 支持1000+并发WebSocket连接
- **FR-007-05**: Frame Bus传输延迟 < 1ms

**验证标准**:
- 性能测试验证通过压测标准
- Prometheus监控指标收集验证
- 端到端测试验证要求

**实现状态**: ✓ 已实现 (截至2025-01-13性能优化完成实际测试结果)

### FR-008: 可扩展性要求

**需求描述**: 系统必须支持垂直和水平扩展

**详细子需求**:
- **FR-008-01**: 支持通过配置增加负载容量
- **FR-008-02**: 支持数据库连接池动态调整 (5-100连接)
- **FR-008-03**: 支持配置参数热重载
- **FR-008-04**: 支持集群水平扩展部署
- **FR-008-05**: 支持容器化和编排扩展

**验证标准**:
- 压测扩展性配置验证
- 数据库连接池运行时动态调整
- 多个配置参数更新验证

**实现状态**: ⚠ 部分实现 (框架支持，待完善动态配置)

## 安全需求

### FR-009: 基础安全要求

**需求描述**: 系统必须提供基础安全防护机制

**详细子需求**:
- **FR-009-01**: 支持JWT Token身份验证
- **FR-009-02**: 严格CORS跨域配置
- **FR-009-03**: 提供SQL注入防护 (SQLx编译时检查)
- **FR-009-04**: 输入验证和参数安全检查
- **FR-009-05**: 提供结构化错误信息管理防泄露

**验证标准**:
```http
# 身份验证
GET /api/v1/devices
Authorization: Bearer <jwt-token>

# CORS预检请求
OPTIONS /api/v1/devices
Origin: http://localhost:50020
# 响应: 允许CORS响应头
```

**实现状态**: ⚠ 部分实现 (基础安全机制存在，JWT验证框架待完善)

## 监控需求

### FR-010: 监控观测要求

**需求描述**: 系统必须提供完整监控和观测能力

**详细子需求**:
- **FR-010-01**: 提供健康检查端点 (`/health`)
- **FR-010-02**: 集成Prometheus指标收集 (`/metrics`)
- **FR-010-03**: 提供数据库连接池状态监控
- **FR-010-04**: 监控WebSocket连接数和状态统计
- **FR-010-05**: 提供结构化日志输出 (JSON格式)

**验证标准**:
```http
# 健康检查
GET /health
# 响应: {"status": "healthy", "services": {...}}

# 监控指标
GET /metrics
# 响应: Prometheus格式指标数据
```

**实现状态**: ⚠ 部分实现 (指标收集完整，健康检查端点需完善)

### FR-011: 配置管理要求

**需求描述**: 系统必须支持灵活配置管理

**详细子需求**:
- **FR-011-01**: 支持YAML格式层级配置
- **FR-011-02**: 支持环境变量敏感配置
- **FR-011-03**: 提供配置验证和错误提示
- **FR-011-04**: 支持配置热重载 (部分参数)
- **FR-011-05**: 统一配置版本管理和变更记录

**验证标准**:
```yaml
# 配置示例
database:
  max_connections: ${DB_MAX_CONNECTIONS:50}
  url: ${DATABASE_URL}

frame_bus:
  wal_flush_ms: 1  # 热重载
```

**实现状态**: ✓ 已实现 (`config/` 目录层级配置)

## 接口需求

### FR-012: API接口要求

**需求描述**: 系统必须提供标准化的API接口

**详细子需求**:
- **FR-012-01**: 遵循RESTful设计原则
- **FR-012-02**: 提供OpenAPI 3.0文档规范
- **FR-012-03**: 统一标准化格式错误处理
- **FR-012-04**: 支持API版本管理 (`/api/v1/`)
- **FR-012-05**: 提供交互式API文档界面 (Swagger UI)

**验证标准**:
```http
# API文档访问
GET /swagger-ui/
# 响应: 完整交互式API文档

# 标准化响应
{
  "success": true,
  "data": {...},
  "meta": {
    "pagination": {...},
    "performance": {...}
  }
}
```

**实现状态**: ✓ 已实现 (`core/web-gw-api/src/openapi.rs`)

## 外部集成需求

### FR-013: 第三方集成要求

**需求描述**: 系统必须支持与外部系统集成

**详细子需求**:
- **FR-013-01**: 支持PostgreSQL数据持久化
- **FR-013-02**: 支持InfluxDB时序数据存储 (未来)
- **FR-013-03**: 支持MQTT Broker连接和发布
- **FR-013-04**: 支持Prometheus监控数据集成
- **FR-013-05**: 支持跨域Web客户端(CORS集成)

**验证标准**:
- 数据库连接测试，支持连接池管理
- MQTT消息发布到远程Broker
- Prometheus能够采集监控指标

**实现状态**: ✓ 已实现，部分功能 (PostgreSQL完整，InfluxDB待实现)

## 功能需求优先级

| 需求ID | 需求名称 | 优先级 | 实现状态 | 验证状态 | 备注 |
|--------|----------|--------|----------|----------|------|
| FR-001 | 设备管理 | P0 | ✓ 已实现 | ✓ 已验证 | 核心功能完整 |
| FR-002 | 数据点管理 | P0 | ✓ 已实现 | ✓ 已验证 | 支持多种数据类型 |
| FR-003 | 实时数据传输 | P0 | ✓ 已实现 | ✓ 已验证 | WebSocket实时推送 |
| FR-004 | 驱动管理 | P1 | ⚠ 部分实现 | ⚠ 部分验证 | 静态驱动完整 |
| FR-005 | 历史数据查询 | P1 | ✓ 已实现 | ✓ 已验证 | 时序数据完整 |
| FR-006 | 告警管理 | P1 | ✓ 已实现 | ✓ 已验证 | 规则引擎可用 |
| FR-007 | 系统性能 | P0 | ✓ 已实现 | ✓ 已验证 | 性能优化完成 |
| FR-008 | 可扩展性 | P1 | ⚠ 部分实现 | ⚠ 部分验证 | 框架支持扩展 |
| FR-009 | 基础安全 | P1 | ⚠ 部分实现 | ⚠ 部分验证 | 基础安全机制 |
| FR-010 | 监控观测 | P1 | ⚠ 部分实现 | ⚠ 部分验证 | 健康检查需完善 |
| FR-011 | 配置管理 | P2 | ✓ 已实现 | ✓ 已验证 | 层级配置完整 |
| FR-012 | API接口 | P1 | ✓ 已实现 | ✓ 已验证 | OpenAPI文档完整 |
| FR-013 | 第三方集成 | P1 | ⚠ 部分实现 | ⚠ 部分验证 | 主要集成完成 |

## 需求实现状态统计

- **已完成**: 8/13 (61.5%)
- **部分实现**: 5/13 (38.5%)
- **未实现**: 0/13 (0%)

**主要结论**: 核心8项功能需求已完成，安全和高级监控功能待进一步完善。

---

**文档版本**: v1.0  
**创建日期**: 2025-01-17  
**审查人**: Gateway_Rust 系统和功能团队  
**用途**: Gateway_Rust 系统团队