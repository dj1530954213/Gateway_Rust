# 总体架构与原则

## 分层视图

- 数据面（Data Plane）：`drivers/*`, `core/driver-manager/`, `core/dynamic-driver/`, `core/frame-bus/`, `connectors/mqtt5/`
- 控制面（Control Plane / API）：`core/web-gw-api/`（Actix 目标），`core/rest-api/`（Warp 迁移期）
- 管理面（Management / Web UI）：`web-ui/`
- 存储（Storage）：Postgres（`infra/pg-repo/` + `schema/migrations/`），InfluxDB（历史数据）
- 消息互联（Messaging）：EMQX（MQTT）、NATS
- 可观测性（Observability）：`core/metrics-server/` + Prometheus + Grafana + tracing 日志

## 关键原则

- 单一事实源（Single Source of Truth）：统一 API 于 Actix，消除 Warp/Actix 双实现分化
- 接口优先（API First）：OpenAPI 契约驱动前后端/集成对齐
- 渐进迁移（Strangler Pattern）：保留 Warp 作为只读备用，直至 Actix 验收通过
- 可观测与可运维：指标/日志/追踪三合一，内建健康检查与自诊断
- 可扩展：动态驱动 + 消息总线，支持分布式/边缘部署
- 安全：CORS 白名单、认证（API Key/Bearer）、最小权限（Permissions）

## 端口与组件（目标态）

- 8080 Actix 主后端；8180 Warp 仅迁移期保留
- 9090 指标统一出口（metrics-server）；9091 Actix Exporter（可被 9090 抓取）
- 8090 Web UI

## 代码边界

- API 层不直接耦合驱动实现，通过服务层/仓储接口解耦
- DTO <-> Domain 转换集中管理，保证外部契约稳定
