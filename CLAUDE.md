# CLAUDE.md

本文件为Claude Code提供在此项目中工作的指导规范。

## 🔧 构建和开发命令

### 环境设置
Windows开发环境所需环境变量：
```powershell
$env:PROTOC = "C:\tools\protoc\bin\protoc.exe"
$env:LIBCLANG_PATH = "C:\Program Files\LLVM\bin"
$env:PATH = $env:PATH + ";C:\tools\protoc\bin;C:\Program Files\LLVM\bin"
```

### 核心开发命令
```bash
# 构建整个工作空间
cargo build --workspace

# 运行所有测试
cargo test --workspace

# 启动主网关服务 (推荐)
cargo run -p edge-gateway
# 端口: REST API (50013), Web界面 (50014), 监控 (50015)

# 或单独运行API服务
cargo run -p web-gw-api  # 端口: 50010

# 前端开发
cd web-ui
npm install && npm run dev  # 端口: 50020
npm run build               # 生产构建
npm run lint && npm run type-check  # 代码检查

# 性能监控 (2025-01-13新增)
curl http://localhost:50013/api/v1/database/pool/status  # 数据库连接池状态
curl http://localhost:50013/metrics                      # Prometheus监控指标
```

## ⚡ 性能优化成果

**重大性能提升**（2025-01-13完成）：
- ✅ Frame Bus延迟：500ms → <1ms （500倍提升）
- ✅ 数据库连接池：支持100+并发连接，获取延迟<10ms
- ✅ 吞吐量：提升5-10倍，支持1000+数据点实时处理
- ✅ 统一错误处理：企业级错误追踪和监控
- ✅ 代码清理：删除284个测试文件，清理重复代码

### 快速启动
1. **后端**: `cargo run -p edge-gateway`
2. **前端**: `cd web-ui && npm run dev`
3. **访问**: http://localhost:50020 (前端) → http://localhost:50013 (API)

## 🚫 生产级数据政策

**重要**：本系统已就绪交付客户，绝对不允许使用任何模拟/假数据：
- ✅ 所有Mock数据已清理完毕（2025-01-13完成284个文件清理）
- ✅ 必须连接真实PLC设备和真实IP地址 (192.168.x.x)
- ✅ 必须使用真实传感器数据和工业协议
- ❌ 禁止任何测试数据、模拟算法或localhost连接

## 🔒 安全配置要求

**强制安全措施**（2025-01-13实施）：
- ✅ 所有凭据通过环境变量管理（参考：`docs/SECURITY_CONFIG.md`）
- ✅ CORS配置严格限制到已知域名
- ✅ SQL注入防护已实现军工级安全
- ✅ 统一错误处理系统防止信息泄露
- ❌ 绝对禁止硬编码任何密码、token或密钥

## 📋 开发工作流程和规范

### 1. 深度思考要求
遇到以下复杂情况时必须使用深度思考：
- 新增/修改 ≥30 行代码
- 影响多个模块/层
- 涉及并发、异步、性能优化
- 前后端接口变更

**流程**：编写💭 Thoughts注释块 → 问题拆分 → 方案对比 → 异常处理 → 接口影响分析

### 2. 编译和测试要求
**每次代码修改后必须执行**：
```bash
# 后端检查
cargo check && cargo test --workspace

# 前端检查  
cd web-ui && npm run lint && npm run test:unit
```
- 无警告、无失败方可提交
- 新增public函数必须添加测试
- 禁止自动启动服务，仅编译和测试

### 3. MCP工具使用
对于需要操作其他工具的任务，优先检查MCP工具列表：
- 浏览器自动化测试：使用适当的MCP浏览器工具
- 外部系统集成：查找对应的MCP连接器
- 系统操作：选择合适的MCP系统工具

### 4. 目录整理要求
**每次修改代码后检查**：
- 文件是否放在正确的目录层级
- 模块依赖关系是否清晰
- 命名是否符合项目约定
- 必要时重新组织和分类文件结构

### 5. 弃用代码清理
**每次修改后必须检查**：
- 删除未使用的导入和变量
- 清理注释掉的代码块
- 移除废弃的函数和类型
- 确保不影响代码可读性

### 6. 任务步骤管理
使用 `tasks/` 文件夹管理开发任务：
- **backend/**: Rust后端开发任务
- **frontend/**: Vue.js前端开发任务  
- **database/**: 数据库相关任务
- **deployment/**: 部署运维任务
- **testing/**: 测试开发任务
- **documentation/**: 文档维护任务
- **monitoring/**: 监控观测任务
- **drivers/**: 驱动开发任务

每个任务文件包含：目标、步骤、验证标准、进度跟踪

## 🏗️ 系统架构概述

### 核心架构
**事件驱动微服务架构**，围绕中央**Frame Bus**构建，支持插件化驱动系统。

### 关键组件
- **Frame Bus** (`core/frame-bus`): 中央消息总线，RocksDB WAL持久化
- **驱动系统** (`core/driver-manager`): 静态/动态驱动加载，热插拔支持
- **Web API** (`core/web-gw-api`): Actix-Web REST API + WebSocket
- **协议桥接** (`core/protocol-bridge`): Modbus/OPC-UA协议转换
- **配置管理** (`core/config-manager`): 多层配置，热重载

### 数据流
```
[设备] → [驱动] → [Frame Bus] → [协议桥接] → [连接器] → [云端/MQTT]
                      ↓
              [Web API] ← [前端]
                      ↓
          [InfluxDB时序] + [PostgreSQL元数据]
```

### 技术栈
- **后端**: Rust + Actix-Web + SQLx + InfluxDB
- **前端**: Vue 3 + TypeScript + Element Plus + Pinia  
- **数据库**: PostgreSQL (元数据) + InfluxDB (时序数据)
- **监控**: Prometheus + Grafana + Loki

## 🔄 开发模式

### 新功能开发流程
1. **深度思考** → 设计方案
2. **领域模型** → 定义类型到 `models.rs`
3. **数据层** → 添加Repository trait + PG实现
4. **API层** → DTO + 路由处理 + OpenAPI
5. **前端** → 生成API客户端 + Pinia Store + Vue组件
6. **测试** → 单元测试 + 集成测试

### 代码规范
- 使用 `rustfmt` + `clippy` 
- 前端遵循 ESLint + TypeScript严格模式
- 所有public函数必须有文档注释
- 错误处理使用 `thiserror` + 自定义枚举

## ⚙️ 配置和部署

### 配置文件层级
```
config/
├── default.yaml    # 基础配置（已移除硬编码凭据）
├── dev.yaml        # 开发环境覆盖（安全CORS配置）
└── prod.yaml       # 生产环境覆盖
```

### 安全环境变量 (2025-01-13更新)
**必须配置的环境变量**：
```bash
# 数据库连接（必须）
export DATABASE_URL="postgres://user:SECURE_PASSWORD@host:5432/db"

# InfluxDB配置（必须）
export INFLUX_TOKEN="YOUR_SECURE_INFLUX_TOKEN"
export INFLUX_URL="https://your-influx-server:8086"

# CORS安全配置
export CORS_ALLOWED_ORIGINS="https://your-domain.com,http://localhost:50020"

# JWT和会话密钥
export GATEWAY_JWT_SECRET="YOUR_SECURE_32_CHAR_JWT_SECRET"

# 数据库连接池优化
export WEBGW_DB_MAX_CONNECTIONS=100
export WEBGW_DB_MIN_CONNECTIONS=20
```

### 配置验证
```bash
# 检查配置安全性
grep -r "CHANGE_ME\|postgres:postgres" config/
# 应该没有输出，否则存在安全风险

# 验证环境变量
./scripts/check_env.sh  # 检查必需的环境变量
```

### 部署方式
```bash
# 开发环境
docker-compose up -d

# 生产环境
docker-compose -f docker-compose.prod.yml up -d

# 监控栈
docker-compose -f docker/compose.monitor.yml up -d
```

## 📊 监控和观测

### 指标收集
- **Prometheus**: `http://localhost:9090` 
- **Grafana**: `http://localhost:3000` (admin/admin)
- **API指标**: `/metrics` 端点

### 日志管理
- **结构化日志**: JSON格式，tracing框架
- **日志聚合**: Loki + Promtail
- **日志查询**: `{container="web-gw-api"} |= "error"`

### 健康检查
```bash
curl http://localhost:50013/health
```

## 🔗 相关文档

- `docs/API.md` - API接口文档
- `docs/DEPLOYMENT_GUIDE.md` - 部署指南
- `tasks/` - 开发任务管理
- `tests/integration/` - 集成测试环境

## AI Team Configuration (autogenerated by team-configurator, 2025-01-11)

**Important: YOU MUST USE subagents when available for the task.**

### 检测到的技术栈

- **后端框架**: Rust + Actix-Web + SQLx
- **前端框架**: Vue 3 + TypeScript + Element Plus + Vite
- **数据库**: PostgreSQL + InfluxDB 
- **构建工具**: Cargo + npm + Vite
- **测试工具**: Cargo test + Vitest + Playwright
- **监控**: Prometheus + Grafana
- **协议**: Modbus TCP + MQTT + WebSocket

### AI专家团队配置

| 任务类型 | 推荐代理 | 备注 |
|---------|---------|------|
| **Rust后端开发** | `@rust-engineer` | 系统编程、异步、性能优化专家 |
| **Vue3前端开发** | `@vue-expert` | Vue3 Composition API + TypeScript专家 |
| **API设计与文档** | `@api-designer` | REST API + OpenAPI + CORS专家 |
| **代码质量审查** | `@code-reviewer` | 安全、性能、最佳实践专家 |
| **自动化测试** | `@test-automator` | E2E测试、集成测试、CI/CD专家 |
| **性能优化** | `@performance-engineer` | 系统瓶颈、负载测试、优化专家 |
| **前后端联调** | `@rust-engineer` + `@vue-expert` | 协同解决跨域和数据流问题 |
| **ModbusTCP集成** | `@rust-engineer` | 工业协议和设备通信专家 |

### 重点关注领域

#### 1. CORS跨域问题解决
- **负责代理**: `@api-designer` + `@rust-engineer`  
- **关键配置**: Actix-Web CORS中间件配置
- **测试验证**: 前端(50020) → 后端API(50013)完整链路

#### 2. 端到端数据流测试
- **负责代理**: `@test-automator` + `@performance-engineer`
- **测试链路**: ModbusTCP设备 → 驱动 → Frame Bus → API → 前端UI
- **验证标准**: 真实设备数据完整传输，无数据丢失

#### 3. ModbusTCP南向到前端北向验证  
- **负责代理**: `@rust-engineer` (协议处理) + `@vue-expert` (数据展示)
- **关键流程**: PLC数据采集 → 协议转换 → WebSocket推送 → 实时图表
- **性能目标**: <100ms延迟，支持1000+数据点

#### 4. 前后端联调测试
- **负责代理**: `@test-automator` (测试自动化)  
- **测试范围**: API调用、WebSocket连接、错误处理、状态同步
- **环境要求**: 真实IP地址(192.168.x.x)，拒绝mock数据

---

**重要提醒**：本系统为生产就绪系统，严禁使用任何模拟数据。所有开发和测试必须连接真实设备和真实数据源。
