# CLAUDE.md

æœ¬æ–‡ä»¶ä¸ºClaude Codeæä¾›åœ¨æ­¤é¡¹ç›®ä¸­å·¥ä½œçš„æŒ‡å¯¼è§„èŒƒã€‚

## ğŸ”§ æ„å»ºå’Œå¼€å‘å‘½ä»¤

### ç¯å¢ƒè®¾ç½®
Windowså¼€å‘ç¯å¢ƒæ‰€éœ€ç¯å¢ƒå˜é‡ï¼š
```powershell
$env:PROTOC = "C:\tools\protoc\bin\protoc.exe"
$env:LIBCLANG_PATH = "C:\Program Files\LLVM\bin"
$env:PATH = $env:PATH + ";C:\tools\protoc\bin;C:\Program Files\LLVM\bin"
```

### æ ¸å¿ƒå¼€å‘å‘½ä»¤
```bash
# æ„å»ºæ•´ä¸ªå·¥ä½œç©ºé—´
cargo build --workspace

# è¿è¡Œæ‰€æœ‰æµ‹è¯•
cargo test --workspace

# å¯åŠ¨ä¸»ç½‘å…³æœåŠ¡ (æ¨è)
cargo run -p edge-gateway
# ç«¯å£: REST API (50013), Webç•Œé¢ (50014), ç›‘æ§ (50015)

# æˆ–å•ç‹¬è¿è¡ŒAPIæœåŠ¡
cargo run -p web-gw-api  # ç«¯å£: 50010

# å‰ç«¯å¼€å‘
cd web-ui
npm install && npm run dev  # ç«¯å£: 50020
npm run build               # ç”Ÿäº§æ„å»º
npm run lint && npm run type-check  # ä»£ç æ£€æŸ¥

# æ€§èƒ½ç›‘æ§ (2025-01-13æ–°å¢)
curl http://localhost:50013/api/v1/database/pool/status  # æ•°æ®åº“è¿æ¥æ± çŠ¶æ€
curl http://localhost:50013/metrics                      # Prometheusç›‘æ§æŒ‡æ ‡
```

## âš¡ æ€§èƒ½ä¼˜åŒ–æˆæœ

**é‡å¤§æ€§èƒ½æå‡**ï¼ˆ2025-01-13å®Œæˆï¼‰ï¼š
- âœ… Frame Buså»¶è¿Ÿï¼š500ms â†’ <1ms ï¼ˆ500å€æå‡ï¼‰
- âœ… æ•°æ®åº“è¿æ¥æ± ï¼šæ”¯æŒ100+å¹¶å‘è¿æ¥ï¼Œè·å–å»¶è¿Ÿ<10ms
- âœ… ååé‡ï¼šæå‡5-10å€ï¼Œæ”¯æŒ1000+æ•°æ®ç‚¹å®æ—¶å¤„ç†
- âœ… ç»Ÿä¸€é”™è¯¯å¤„ç†ï¼šä¼ä¸šçº§é”™è¯¯è¿½è¸ªå’Œç›‘æ§
- âœ… ä»£ç æ¸…ç†ï¼šåˆ é™¤284ä¸ªæµ‹è¯•æ–‡ä»¶ï¼Œæ¸…ç†é‡å¤ä»£ç 

### å¿«é€Ÿå¯åŠ¨
1. **åç«¯**: `cargo run -p edge-gateway`
2. **å‰ç«¯**: `cd web-ui && npm run dev`
3. **è®¿é—®**: http://localhost:50020 (å‰ç«¯) â†’ http://localhost:50013 (API)

## ğŸš« ç”Ÿäº§çº§æ•°æ®æ”¿ç­–

**é‡è¦**ï¼šæœ¬ç³»ç»Ÿå·²å°±ç»ªäº¤ä»˜å®¢æˆ·ï¼Œç»å¯¹ä¸å…è®¸ä½¿ç”¨ä»»ä½•æ¨¡æ‹Ÿ/å‡æ•°æ®ï¼š
- âœ… æ‰€æœ‰Mockæ•°æ®å·²æ¸…ç†å®Œæ¯•ï¼ˆ2025-01-13å®Œæˆ284ä¸ªæ–‡ä»¶æ¸…ç†ï¼‰
- âœ… å¿…é¡»è¿æ¥çœŸå®PLCè®¾å¤‡å’ŒçœŸå®IPåœ°å€ (192.168.x.x)
- âœ… å¿…é¡»ä½¿ç”¨çœŸå®ä¼ æ„Ÿå™¨æ•°æ®å’Œå·¥ä¸šåè®®
- âŒ ç¦æ­¢ä»»ä½•æµ‹è¯•æ•°æ®ã€æ¨¡æ‹Ÿç®—æ³•æˆ–localhostè¿æ¥

## ğŸ”’ å®‰å…¨é…ç½®è¦æ±‚

**å¼ºåˆ¶å®‰å…¨æªæ–½**ï¼ˆ2025-01-13å®æ–½ï¼‰ï¼š
- âœ… æ‰€æœ‰å‡­æ®é€šè¿‡ç¯å¢ƒå˜é‡ç®¡ç†ï¼ˆå‚è€ƒï¼š`docs/SECURITY_CONFIG.md`ï¼‰
- âœ… CORSé…ç½®ä¸¥æ ¼é™åˆ¶åˆ°å·²çŸ¥åŸŸå
- âœ… SQLæ³¨å…¥é˜²æŠ¤å·²å®ç°å†›å·¥çº§å®‰å…¨
- âœ… ç»Ÿä¸€é”™è¯¯å¤„ç†ç³»ç»Ÿé˜²æ­¢ä¿¡æ¯æ³„éœ²
- âŒ ç»å¯¹ç¦æ­¢ç¡¬ç¼–ç ä»»ä½•å¯†ç ã€tokenæˆ–å¯†é’¥

## ğŸ“‹ å¼€å‘å·¥ä½œæµç¨‹å’Œè§„èŒƒ

### 1. æ·±åº¦æ€è€ƒè¦æ±‚
é‡åˆ°ä»¥ä¸‹å¤æ‚æƒ…å†µæ—¶å¿…é¡»ä½¿ç”¨æ·±åº¦æ€è€ƒï¼š
- æ–°å¢/ä¿®æ”¹ â‰¥30 è¡Œä»£ç 
- å½±å“å¤šä¸ªæ¨¡å—/å±‚
- æ¶‰åŠå¹¶å‘ã€å¼‚æ­¥ã€æ€§èƒ½ä¼˜åŒ–
- å‰åç«¯æ¥å£å˜æ›´

**æµç¨‹**ï¼šç¼–å†™ğŸ’­ Thoughtsæ³¨é‡Šå— â†’ é—®é¢˜æ‹†åˆ† â†’ æ–¹æ¡ˆå¯¹æ¯” â†’ å¼‚å¸¸å¤„ç† â†’ æ¥å£å½±å“åˆ†æ

### 2. ç¼–è¯‘å’Œæµ‹è¯•è¦æ±‚
**æ¯æ¬¡ä»£ç ä¿®æ”¹åå¿…é¡»æ‰§è¡Œ**ï¼š
```bash
# åç«¯æ£€æŸ¥
cargo check && cargo test --workspace

# å‰ç«¯æ£€æŸ¥  
cd web-ui && npm run lint && npm run test:unit
```
- æ— è­¦å‘Šã€æ— å¤±è´¥æ–¹å¯æäº¤
- æ–°å¢publicå‡½æ•°å¿…é¡»æ·»åŠ æµ‹è¯•
- ç¦æ­¢è‡ªåŠ¨å¯åŠ¨æœåŠ¡ï¼Œä»…ç¼–è¯‘å’Œæµ‹è¯•

### 3. MCPå·¥å…·ä½¿ç”¨
å¯¹äºéœ€è¦æ“ä½œå…¶ä»–å·¥å…·çš„ä»»åŠ¡ï¼Œä¼˜å…ˆæ£€æŸ¥MCPå·¥å…·åˆ—è¡¨ï¼š
- æµè§ˆå™¨è‡ªåŠ¨åŒ–æµ‹è¯•ï¼šä½¿ç”¨é€‚å½“çš„MCPæµè§ˆå™¨å·¥å…·
- å¤–éƒ¨ç³»ç»Ÿé›†æˆï¼šæŸ¥æ‰¾å¯¹åº”çš„MCPè¿æ¥å™¨
- ç³»ç»Ÿæ“ä½œï¼šé€‰æ‹©åˆé€‚çš„MCPç³»ç»Ÿå·¥å…·

### 4. ç›®å½•æ•´ç†è¦æ±‚
**æ¯æ¬¡ä¿®æ”¹ä»£ç åæ£€æŸ¥**ï¼š
- æ–‡ä»¶æ˜¯å¦æ”¾åœ¨æ­£ç¡®çš„ç›®å½•å±‚çº§
- æ¨¡å—ä¾èµ–å…³ç³»æ˜¯å¦æ¸…æ™°
- å‘½åæ˜¯å¦ç¬¦åˆé¡¹ç›®çº¦å®š
- å¿…è¦æ—¶é‡æ–°ç»„ç»‡å’Œåˆ†ç±»æ–‡ä»¶ç»“æ„

### 5. å¼ƒç”¨ä»£ç æ¸…ç†
**æ¯æ¬¡ä¿®æ”¹åå¿…é¡»æ£€æŸ¥**ï¼š
- åˆ é™¤æœªä½¿ç”¨çš„å¯¼å…¥å’Œå˜é‡
- æ¸…ç†æ³¨é‡Šæ‰çš„ä»£ç å—
- ç§»é™¤åºŸå¼ƒçš„å‡½æ•°å’Œç±»å‹
- ç¡®ä¿ä¸å½±å“ä»£ç å¯è¯»æ€§

### 6. ä»»åŠ¡æ­¥éª¤ç®¡ç†
ä½¿ç”¨ `tasks/` æ–‡ä»¶å¤¹ç®¡ç†å¼€å‘ä»»åŠ¡ï¼š
- **backend/**: Ruståç«¯å¼€å‘ä»»åŠ¡
- **frontend/**: Vue.jså‰ç«¯å¼€å‘ä»»åŠ¡  
- **database/**: æ•°æ®åº“ç›¸å…³ä»»åŠ¡
- **deployment/**: éƒ¨ç½²è¿ç»´ä»»åŠ¡
- **testing/**: æµ‹è¯•å¼€å‘ä»»åŠ¡
- **documentation/**: æ–‡æ¡£ç»´æŠ¤ä»»åŠ¡
- **monitoring/**: ç›‘æ§è§‚æµ‹ä»»åŠ¡
- **drivers/**: é©±åŠ¨å¼€å‘ä»»åŠ¡

æ¯ä¸ªä»»åŠ¡æ–‡ä»¶åŒ…å«ï¼šç›®æ ‡ã€æ­¥éª¤ã€éªŒè¯æ ‡å‡†ã€è¿›åº¦è·Ÿè¸ª

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„æ¦‚è¿°

### æ ¸å¿ƒæ¶æ„
**äº‹ä»¶é©±åŠ¨å¾®æœåŠ¡æ¶æ„**ï¼Œå›´ç»•ä¸­å¤®**Frame Bus**æ„å»ºï¼Œæ”¯æŒæ’ä»¶åŒ–é©±åŠ¨ç³»ç»Ÿã€‚

### å…³é”®ç»„ä»¶
- **Frame Bus** (`core/frame-bus`): ä¸­å¤®æ¶ˆæ¯æ€»çº¿ï¼ŒRocksDB WALæŒä¹…åŒ–
- **é©±åŠ¨ç³»ç»Ÿ** (`core/driver-manager`): é™æ€/åŠ¨æ€é©±åŠ¨åŠ è½½ï¼Œçƒ­æ’æ‹”æ”¯æŒ
- **Web API** (`core/web-gw-api`): Actix-Web REST API + WebSocket
- **åè®®æ¡¥æ¥** (`core/protocol-bridge`): Modbus/OPC-UAåè®®è½¬æ¢
- **é…ç½®ç®¡ç†** (`core/config-manager`): å¤šå±‚é…ç½®ï¼Œçƒ­é‡è½½

### æ•°æ®æµ
```
[è®¾å¤‡] â†’ [é©±åŠ¨] â†’ [Frame Bus] â†’ [åè®®æ¡¥æ¥] â†’ [è¿æ¥å™¨] â†’ [äº‘ç«¯/MQTT]
                      â†“
              [Web API] â† [å‰ç«¯]
                      â†“
          [InfluxDBæ—¶åº] + [PostgreSQLå…ƒæ•°æ®]
```

### æŠ€æœ¯æ ˆ
- **åç«¯**: Rust + Actix-Web + SQLx + InfluxDB
- **å‰ç«¯**: Vue 3 + TypeScript + Element Plus + Pinia  
- **æ•°æ®åº“**: PostgreSQL (å…ƒæ•°æ®) + InfluxDB (æ—¶åºæ•°æ®)
- **ç›‘æ§**: Prometheus + Grafana + Loki

## ğŸ”„ å¼€å‘æ¨¡å¼

### æ–°åŠŸèƒ½å¼€å‘æµç¨‹
1. **æ·±åº¦æ€è€ƒ** â†’ è®¾è®¡æ–¹æ¡ˆ
2. **é¢†åŸŸæ¨¡å‹** â†’ å®šä¹‰ç±»å‹åˆ° `models.rs`
3. **æ•°æ®å±‚** â†’ æ·»åŠ Repository trait + PGå®ç°
4. **APIå±‚** â†’ DTO + è·¯ç”±å¤„ç† + OpenAPI
5. **å‰ç«¯** â†’ ç”ŸæˆAPIå®¢æˆ·ç«¯ + Pinia Store + Vueç»„ä»¶
6. **æµ‹è¯•** â†’ å•å…ƒæµ‹è¯• + é›†æˆæµ‹è¯•

### ä»£ç è§„èŒƒ
- ä½¿ç”¨ `rustfmt` + `clippy` 
- å‰ç«¯éµå¾ª ESLint + TypeScriptä¸¥æ ¼æ¨¡å¼
- æ‰€æœ‰publicå‡½æ•°å¿…é¡»æœ‰æ–‡æ¡£æ³¨é‡Š
- é”™è¯¯å¤„ç†ä½¿ç”¨ `thiserror` + è‡ªå®šä¹‰æšä¸¾

## âš™ï¸ é…ç½®å’Œéƒ¨ç½²

### é…ç½®æ–‡ä»¶å±‚çº§
```
config/
â”œâ”€â”€ default.yaml    # åŸºç¡€é…ç½®ï¼ˆå·²ç§»é™¤ç¡¬ç¼–ç å‡­æ®ï¼‰
â”œâ”€â”€ dev.yaml        # å¼€å‘ç¯å¢ƒè¦†ç›–ï¼ˆå®‰å…¨CORSé…ç½®ï¼‰
â””â”€â”€ prod.yaml       # ç”Ÿäº§ç¯å¢ƒè¦†ç›–
```

### å®‰å…¨ç¯å¢ƒå˜é‡ (2025-01-13æ›´æ–°)
**å¿…é¡»é…ç½®çš„ç¯å¢ƒå˜é‡**ï¼š
```bash
# æ•°æ®åº“è¿æ¥ï¼ˆå¿…é¡»ï¼‰
export DATABASE_URL="postgres://user:SECURE_PASSWORD@host:5432/db"

# InfluxDBé…ç½®ï¼ˆå¿…é¡»ï¼‰
export INFLUX_TOKEN="YOUR_SECURE_INFLUX_TOKEN"
export INFLUX_URL="https://your-influx-server:8086"

# CORSå®‰å…¨é…ç½®
export CORS_ALLOWED_ORIGINS="https://your-domain.com,http://localhost:50020"

# JWTå’Œä¼šè¯å¯†é’¥
export GATEWAY_JWT_SECRET="YOUR_SECURE_32_CHAR_JWT_SECRET"

# æ•°æ®åº“è¿æ¥æ± ä¼˜åŒ–
export WEBGW_DB_MAX_CONNECTIONS=100
export WEBGW_DB_MIN_CONNECTIONS=20
```

### é…ç½®éªŒè¯
```bash
# æ£€æŸ¥é…ç½®å®‰å…¨æ€§
grep -r "CHANGE_ME\|postgres:postgres" config/
# åº”è¯¥æ²¡æœ‰è¾“å‡ºï¼Œå¦åˆ™å­˜åœ¨å®‰å…¨é£é™©

# éªŒè¯ç¯å¢ƒå˜é‡
./scripts/check_env.sh  # æ£€æŸ¥å¿…éœ€çš„ç¯å¢ƒå˜é‡
```

### éƒ¨ç½²æ–¹å¼
```bash
# å¼€å‘ç¯å¢ƒ
docker-compose up -d

# ç”Ÿäº§ç¯å¢ƒ
docker-compose -f docker-compose.prod.yml up -d

# ç›‘æ§æ ˆ
docker-compose -f docker/compose.monitor.yml up -d
```

## ğŸ“Š ç›‘æ§å’Œè§‚æµ‹

### æŒ‡æ ‡æ”¶é›†
- **Prometheus**: `http://localhost:9090` 
- **Grafana**: `http://localhost:3000` (admin/admin)
- **APIæŒ‡æ ‡**: `/metrics` ç«¯ç‚¹

### æ—¥å¿—ç®¡ç†
- **ç»“æ„åŒ–æ—¥å¿—**: JSONæ ¼å¼ï¼Œtracingæ¡†æ¶
- **æ—¥å¿—èšåˆ**: Loki + Promtail
- **æ—¥å¿—æŸ¥è¯¢**: `{container="web-gw-api"} |= "error"`

### å¥åº·æ£€æŸ¥
```bash
curl http://localhost:50013/health
```

## ğŸ”— ç›¸å…³æ–‡æ¡£

- `docs/API.md` - APIæ¥å£æ–‡æ¡£
- `docs/DEPLOYMENT_GUIDE.md` - éƒ¨ç½²æŒ‡å—
- `tasks/` - å¼€å‘ä»»åŠ¡ç®¡ç†
- `tests/integration/` - é›†æˆæµ‹è¯•ç¯å¢ƒ

## AI Team Configuration (autogenerated by team-configurator, 2025-01-11)

**Important: YOU MUST USE subagents when available for the task.**

### æ£€æµ‹åˆ°çš„æŠ€æœ¯æ ˆ

- **åç«¯æ¡†æ¶**: Rust + Actix-Web + SQLx
- **å‰ç«¯æ¡†æ¶**: Vue 3 + TypeScript + Element Plus + Vite
- **æ•°æ®åº“**: PostgreSQL + InfluxDB 
- **æ„å»ºå·¥å…·**: Cargo + npm + Vite
- **æµ‹è¯•å·¥å…·**: Cargo test + Vitest + Playwright
- **ç›‘æ§**: Prometheus + Grafana
- **åè®®**: Modbus TCP + MQTT + WebSocket

### AIä¸“å®¶å›¢é˜Ÿé…ç½®

| ä»»åŠ¡ç±»å‹ | æ¨èä»£ç† | å¤‡æ³¨ |
|---------|---------|------|
| **Ruståç«¯å¼€å‘** | `@rust-engineer` | ç³»ç»Ÿç¼–ç¨‹ã€å¼‚æ­¥ã€æ€§èƒ½ä¼˜åŒ–ä¸“å®¶ |
| **Vue3å‰ç«¯å¼€å‘** | `@vue-expert` | Vue3 Composition API + TypeScriptä¸“å®¶ |
| **APIè®¾è®¡ä¸æ–‡æ¡£** | `@api-designer` | REST API + OpenAPI + CORSä¸“å®¶ |
| **ä»£ç è´¨é‡å®¡æŸ¥** | `@code-reviewer` | å®‰å…¨ã€æ€§èƒ½ã€æœ€ä½³å®è·µä¸“å®¶ |
| **è‡ªåŠ¨åŒ–æµ‹è¯•** | `@test-automator` | E2Eæµ‹è¯•ã€é›†æˆæµ‹è¯•ã€CI/CDä¸“å®¶ |
| **æ€§èƒ½ä¼˜åŒ–** | `@performance-engineer` | ç³»ç»Ÿç“¶é¢ˆã€è´Ÿè½½æµ‹è¯•ã€ä¼˜åŒ–ä¸“å®¶ |
| **å‰åç«¯è”è°ƒ** | `@rust-engineer` + `@vue-expert` | ååŒè§£å†³è·¨åŸŸå’Œæ•°æ®æµé—®é¢˜ |
| **ModbusTCPé›†æˆ** | `@rust-engineer` | å·¥ä¸šåè®®å’Œè®¾å¤‡é€šä¿¡ä¸“å®¶ |

### é‡ç‚¹å…³æ³¨é¢†åŸŸ

#### 1. CORSè·¨åŸŸé—®é¢˜è§£å†³
- **è´Ÿè´£ä»£ç†**: `@api-designer` + `@rust-engineer`  
- **å…³é”®é…ç½®**: Actix-Web CORSä¸­é—´ä»¶é…ç½®
- **æµ‹è¯•éªŒè¯**: å‰ç«¯(50020) â†’ åç«¯API(50013)å®Œæ•´é“¾è·¯

#### 2. ç«¯åˆ°ç«¯æ•°æ®æµæµ‹è¯•
- **è´Ÿè´£ä»£ç†**: `@test-automator` + `@performance-engineer`
- **æµ‹è¯•é“¾è·¯**: ModbusTCPè®¾å¤‡ â†’ é©±åŠ¨ â†’ Frame Bus â†’ API â†’ å‰ç«¯UI
- **éªŒè¯æ ‡å‡†**: çœŸå®è®¾å¤‡æ•°æ®å®Œæ•´ä¼ è¾“ï¼Œæ— æ•°æ®ä¸¢å¤±

#### 3. ModbusTCPå—å‘åˆ°å‰ç«¯åŒ—å‘éªŒè¯  
- **è´Ÿè´£ä»£ç†**: `@rust-engineer` (åè®®å¤„ç†) + `@vue-expert` (æ•°æ®å±•ç¤º)
- **å…³é”®æµç¨‹**: PLCæ•°æ®é‡‡é›† â†’ åè®®è½¬æ¢ â†’ WebSocketæ¨é€ â†’ å®æ—¶å›¾è¡¨
- **æ€§èƒ½ç›®æ ‡**: <100mså»¶è¿Ÿï¼Œæ”¯æŒ1000+æ•°æ®ç‚¹

#### 4. å‰åç«¯è”è°ƒæµ‹è¯•
- **è´Ÿè´£ä»£ç†**: `@test-automator` (æµ‹è¯•è‡ªåŠ¨åŒ–)  
- **æµ‹è¯•èŒƒå›´**: APIè°ƒç”¨ã€WebSocketè¿æ¥ã€é”™è¯¯å¤„ç†ã€çŠ¶æ€åŒæ­¥
- **ç¯å¢ƒè¦æ±‚**: çœŸå®IPåœ°å€(192.168.x.x)ï¼Œæ‹’ç»mockæ•°æ®

---

**é‡è¦æé†’**ï¼šæœ¬ç³»ç»Ÿä¸ºç”Ÿäº§å°±ç»ªç³»ç»Ÿï¼Œä¸¥ç¦ä½¿ç”¨ä»»ä½•æ¨¡æ‹Ÿæ•°æ®ã€‚æ‰€æœ‰å¼€å‘å’Œæµ‹è¯•å¿…é¡»è¿æ¥çœŸå®è®¾å¤‡å’ŒçœŸå®æ•°æ®æºã€‚
