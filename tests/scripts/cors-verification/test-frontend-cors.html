<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>前端CORS测试</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-result { 
            margin: 10px 0; 
            padding: 10px; 
            border-radius: 5px; 
        }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .loading { background-color: #d1ecf1; color: #0c5460; }
        button { 
            background-color: #007bff; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 5px; 
            cursor: pointer; 
            margin: 5px; 
        }
        button:hover { background-color: #0056b3; }
        #results { margin-top: 20px; }
    </style>
</head>
<body>
    <h1>🧪 前端CORS测试页面</h1>
    <p>测试前端axios请求是否能正常访问后端API（解决CORS问题）</p>
    
    <div>
        <button onclick="testAllAPIs()">运行所有测试</button>
        <button onclick="clearResults()">清空结果</button>
    </div>
    
    <div id="results"></div>
    
    <script>
        const API_BASE_URL = 'http://localhost:50010';
        
        function addResult(testName, status, message, data = null) {
            const resultsDiv = document.getElementById('results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${status}`;
            
            let content = `<strong>${testName}</strong>: ${message}`;
            if (data) {
                content += `<br><small>数据: ${JSON.stringify(data).substring(0, 200)}...</small>`;
            }
            
            resultDiv.innerHTML = content;
            resultsDiv.appendChild(resultDiv);
        }
        
        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }
        
        async function testAPI(testName, url, method = 'GET') {
            addResult(testName, 'loading', '测试中...');
            
            try {
                const response = await axios({
                    method: method,
                    url: url,
                    timeout: 5000,
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                
                // 移除loading状态的结果
                const loadingResult = document.querySelector('.test-result.loading:last-child');
                if (loadingResult) loadingResult.remove();
                
                addResult(testName, 'success', `✅ 成功 (状态码: ${response.status})`, response.data);
                return true;
                
            } catch (error) {
                // 移除loading状态的结果
                const loadingResult = document.querySelector('.test-result.loading:last-child');
                if (loadingResult) loadingResult.remove();
                
                if (error.response) {
                    addResult(testName, 'error', `❌ HTTP错误: ${error.response.status} ${error.response.statusText}`);
                } else if (error.code === 'ECONNREFUSED') {
                    addResult(testName, 'error', '❌ 连接被拒绝，API服务未启动');
                } else if (error.message.includes('CORS')) {
                    addResult(testName, 'error', `❌ CORS错误: ${error.message}`);
                } else {
                    addResult(testName, 'error', `❌ 网络错误: ${error.message}`);
                }
                return false;
            }
        }
        
        async function testAllAPIs() {
            clearResults();
            addResult('开始测试', 'loading', '正在执行所有API测试...');
            
            const tests = [
                { name: '健康检查API', url: `${API_BASE_URL}/health` },
                { name: '存活探针API', url: `${API_BASE_URL}/health/live` },
                { name: '就绪探针API', url: `${API_BASE_URL}/health/ready` },
                { name: '系统信息API', url: `${API_BASE_URL}/system/info` },
                { name: '系统指标API', url: `${API_BASE_URL}/system/metrics` },
                { name: '系统健康API', url: `${API_BASE_URL}/system/health` },
                { name: '组件状态API', url: `${API_BASE_URL}/system/components/status` }
            ];
            
            let passedTests = 0;
            
            for (const test of tests) {
                const success = await testAPI(test.name, test.url);
                if (success) passedTests++;
                
                // 添加小延迟让用户看到进度
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            // 移除"开始测试"的loading消息
            const startTestResult = document.querySelector('.test-result.loading');
            if (startTestResult) startTestResult.remove();
            
            // 添加总结
            const summaryStatus = passedTests === tests.length ? 'success' : 'error';
            const summaryMessage = `📊 测试完成: ${passedTests}/${tests.length} 通过`;
            addResult('测试总结', summaryStatus, summaryMessage);
            
            if (passedTests === tests.length) {
                addResult('🎉 结论', 'success', 'CORS问题已彻底解决！前端可以正常访问所有后端API。');
            } else {
                addResult('⚠️ 结论', 'error', '部分API仍有问题，需要进一步检查。');
            }
        }
        
        // 页面加载后自动运行测试
        window.onload = function() {
            setTimeout(testAllAPIs, 1000);
        };
    </script>
</body>
</html>