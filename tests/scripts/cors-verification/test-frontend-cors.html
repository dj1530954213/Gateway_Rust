<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‰ç«¯CORSæµ‹è¯•</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-result { 
            margin: 10px 0; 
            padding: 10px; 
            border-radius: 5px; 
        }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .loading { background-color: #d1ecf1; color: #0c5460; }
        button { 
            background-color: #007bff; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 5px; 
            cursor: pointer; 
            margin: 5px; 
        }
        button:hover { background-color: #0056b3; }
        #results { margin-top: 20px; }
    </style>
</head>
<body>
    <h1>ğŸ§ª å‰ç«¯CORSæµ‹è¯•é¡µé¢</h1>
    <p>æµ‹è¯•å‰ç«¯axiosè¯·æ±‚æ˜¯å¦èƒ½æ­£å¸¸è®¿é—®åç«¯APIï¼ˆè§£å†³CORSé—®é¢˜ï¼‰</p>
    
    <div>
        <button onclick="testAllAPIs()">è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
        <button onclick="clearResults()">æ¸…ç©ºç»“æœ</button>
    </div>
    
    <div id="results"></div>
    
    <script>
        const API_BASE_URL = 'http://localhost:50010';
        
        function addResult(testName, status, message, data = null) {
            const resultsDiv = document.getElementById('results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${status}`;
            
            let content = `<strong>${testName}</strong>: ${message}`;
            if (data) {
                content += `<br><small>æ•°æ®: ${JSON.stringify(data).substring(0, 200)}...</small>`;
            }
            
            resultDiv.innerHTML = content;
            resultsDiv.appendChild(resultDiv);
        }
        
        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }
        
        async function testAPI(testName, url, method = 'GET') {
            addResult(testName, 'loading', 'æµ‹è¯•ä¸­...');
            
            try {
                const response = await axios({
                    method: method,
                    url: url,
                    timeout: 5000,
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                
                // ç§»é™¤loadingçŠ¶æ€çš„ç»“æœ
                const loadingResult = document.querySelector('.test-result.loading:last-child');
                if (loadingResult) loadingResult.remove();
                
                addResult(testName, 'success', `âœ… æˆåŠŸ (çŠ¶æ€ç : ${response.status})`, response.data);
                return true;
                
            } catch (error) {
                // ç§»é™¤loadingçŠ¶æ€çš„ç»“æœ
                const loadingResult = document.querySelector('.test-result.loading:last-child');
                if (loadingResult) loadingResult.remove();
                
                if (error.response) {
                    addResult(testName, 'error', `âŒ HTTPé”™è¯¯: ${error.response.status} ${error.response.statusText}`);
                } else if (error.code === 'ECONNREFUSED') {
                    addResult(testName, 'error', 'âŒ è¿æ¥è¢«æ‹’ç»ï¼ŒAPIæœåŠ¡æœªå¯åŠ¨');
                } else if (error.message.includes('CORS')) {
                    addResult(testName, 'error', `âŒ CORSé”™è¯¯: ${error.message}`);
                } else {
                    addResult(testName, 'error', `âŒ ç½‘ç»œé”™è¯¯: ${error.message}`);
                }
                return false;
            }
        }
        
        async function testAllAPIs() {
            clearResults();
            addResult('å¼€å§‹æµ‹è¯•', 'loading', 'æ­£åœ¨æ‰§è¡Œæ‰€æœ‰APIæµ‹è¯•...');
            
            const tests = [
                { name: 'å¥åº·æ£€æŸ¥API', url: `${API_BASE_URL}/health` },
                { name: 'å­˜æ´»æ¢é’ˆAPI', url: `${API_BASE_URL}/health/live` },
                { name: 'å°±ç»ªæ¢é’ˆAPI', url: `${API_BASE_URL}/health/ready` },
                { name: 'ç³»ç»Ÿä¿¡æ¯API', url: `${API_BASE_URL}/system/info` },
                { name: 'ç³»ç»ŸæŒ‡æ ‡API', url: `${API_BASE_URL}/system/metrics` },
                { name: 'ç³»ç»Ÿå¥åº·API', url: `${API_BASE_URL}/system/health` },
                { name: 'ç»„ä»¶çŠ¶æ€API', url: `${API_BASE_URL}/system/components/status` }
            ];
            
            let passedTests = 0;
            
            for (const test of tests) {
                const success = await testAPI(test.name, test.url);
                if (success) passedTests++;
                
                // æ·»åŠ å°å»¶è¿Ÿè®©ç”¨æˆ·çœ‹åˆ°è¿›åº¦
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            // ç§»é™¤"å¼€å§‹æµ‹è¯•"çš„loadingæ¶ˆæ¯
            const startTestResult = document.querySelector('.test-result.loading');
            if (startTestResult) startTestResult.remove();
            
            // æ·»åŠ æ€»ç»“
            const summaryStatus = passedTests === tests.length ? 'success' : 'error';
            const summaryMessage = `ğŸ“Š æµ‹è¯•å®Œæˆ: ${passedTests}/${tests.length} é€šè¿‡`;
            addResult('æµ‹è¯•æ€»ç»“', summaryStatus, summaryMessage);
            
            if (passedTests === tests.length) {
                addResult('ğŸ‰ ç»“è®º', 'success', 'CORSé—®é¢˜å·²å½»åº•è§£å†³ï¼å‰ç«¯å¯ä»¥æ­£å¸¸è®¿é—®æ‰€æœ‰åç«¯APIã€‚');
            } else {
                addResult('âš ï¸ ç»“è®º', 'error', 'éƒ¨åˆ†APIä»æœ‰é—®é¢˜ï¼Œéœ€è¦è¿›ä¸€æ­¥æ£€æŸ¥ã€‚');
            }
        }
        
        // é¡µé¢åŠ è½½åè‡ªåŠ¨è¿è¡Œæµ‹è¯•
        window.onload = function() {
            setTimeout(testAllAPIs, 1000);
        };
    </script>
</body>
</html>