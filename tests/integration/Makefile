# é›†æˆæµ‹è¯•ç¯å¢ƒç®¡ç† Makefile

.PHONY: help setup teardown test status logs check-deps

# é»˜è®¤ç›®æ ‡
help:
	@echo "é›†æˆæµ‹è¯•ç¯å¢ƒç®¡ç†"
	@echo ""
	@echo "å¯ç”¨å‘½ä»¤:"
	@echo "  setup      - å¯åŠ¨æµ‹è¯•ç¯å¢ƒ"
	@echo "  teardown   - åœæ­¢å¹¶æ¸…ç†æµ‹è¯•ç¯å¢ƒ"
	@echo "  status     - æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
	@echo "  logs       - æŸ¥çœ‹æœåŠ¡æ—¥å¿—"
	@echo "  test       - è¿è¡Œé›†æˆæµ‹è¯•"
	@echo "  check-deps - æ£€æŸ¥ä¾èµ–"

# æ£€æŸ¥ä¾èµ–
check-deps:
	@echo "æ£€æŸ¥ä¾èµ–..."
	@which docker >/dev/null 2>&1 || (echo "é”™è¯¯: Docker æœªå®‰è£…" && exit 1)
	@which docker-compose >/dev/null 2>&1 || (echo "é”™è¯¯: docker-compose æœªå®‰è£…" && exit 1)
	@docker info >/dev/null 2>&1 || (echo "é”™è¯¯: Docker æœåŠ¡æœªè¿è¡Œ" && exit 1)
	@echo "âœ… ä¾èµ–æ£€æŸ¥é€šè¿‡"

# å¯åŠ¨æµ‹è¯•ç¯å¢ƒ
setup: check-deps
	@echo "ğŸš€ å¯åŠ¨é›†æˆæµ‹è¯•ç¯å¢ƒ..."
	docker-compose up -d
	@echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
	@sleep 10
	@echo "âœ… æµ‹è¯•ç¯å¢ƒå¯åŠ¨å®Œæˆ"
	@make status

# åœæ­¢æµ‹è¯•ç¯å¢ƒ
teardown:
	@echo "ğŸ§¹ åœæ­¢é›†æˆæµ‹è¯•ç¯å¢ƒ..."
	docker-compose down -v
	@echo "âœ… æµ‹è¯•ç¯å¢ƒå·²æ¸…ç†"

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
status:
	@echo "ğŸ“Š æœåŠ¡çŠ¶æ€:"
	@docker-compose ps

# æŸ¥çœ‹æ—¥å¿—
logs:
	@echo "ğŸ“ æœåŠ¡æ—¥å¿—:"
	docker-compose logs --tail=50

# æŸ¥çœ‹ç‰¹å®šæœåŠ¡æ—¥å¿—
logs-mqtt:
	docker-compose logs -f mqtt-broker

# ğŸš« Mock PLCæ—¥å¿—å‘½ä»¤å·²ç§»é™¤
# logs-plcå‘½ä»¤å·²åˆ é™¤ï¼Œå› ä¸ºæœ¬ç³»ç»Ÿä¸ºç”Ÿäº§çº§äº§å“ï¼Œä¸ä½¿ç”¨æ¨¡æ‹ŸPLC
# å¦‚éœ€æŸ¥çœ‹çœŸå®è®¾å¤‡æ—¥å¿—ï¼Œè¯·è¿æ¥çœŸå®PLCçš„æ—¥å¿—æ¥å£

logs-influx:
	docker-compose logs -f influxdb

# è¿è¡Œé›†æˆæµ‹è¯•
test: setup
	@echo "ğŸ§ª è¿è¡Œé›†æˆæµ‹è¯•..."
	cd ../.. && cargo test --test integration_tests -- --test-threads=1
	@echo "âœ… é›†æˆæµ‹è¯•å®Œæˆ"

# é‡å¯æµ‹è¯•ç¯å¢ƒ
restart: teardown setup

# å¥åº·æ£€æŸ¥
health:
	@echo "ğŸ¥ å¥åº·æ£€æŸ¥:"
	@echo "MQTT Broker:"
	@docker exec gateway-test-mqtt mosquitto_pub -h localhost -t test -m "test" >/dev/null 2>&1 && echo "  âœ… MQTT OK" || echo "  âŒ MQTT Failed"
	@echo "InfluxDB:"
	@curl -s http://localhost:8086/ping >/dev/null 2>&1 && echo "  âœ… InfluxDB OK" || echo "  âŒ InfluxDB Failed"
	@echo "ğŸš« Mock PLCå¥åº·æ£€æŸ¥å·²ç§»é™¤:"
	@echo "  æœ¬ç³»ç»Ÿä¸ºç”Ÿäº§çº§äº§å“ï¼Œå¿…é¡»è¿æ¥çœŸå®PLCè®¾å¤‡"
	@echo "  è¯·æ£€æŸ¥çœŸå®è®¾å¤‡çš„ç½‘ç»œè¿æ¥å’ŒModbusé€šä¿¡çŠ¶æ€"

# æ¸…ç† Docker èµ„æº
clean: teardown
	@echo "ğŸ—‘ï¸  æ¸…ç† Docker èµ„æº..."
	docker system prune -f
	docker volume prune -f