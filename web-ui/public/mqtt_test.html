<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MQTT 监听测试</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; margin: 16px; }
    .row { margin: 8px 0; }
    #log { border: 1px solid #ddd; padding: 8px; height: 360px; overflow: auto; background: #fafafa; }
    .ok { color: #2ecc71; }
    .err { color: #e74c3c; }
    label { display: inline-block; min-width: 140px; }
    input { padding: 4px 6px; width: 320px; }
    button { padding: 6px 12px; margin-left: 8px; }
    .muted { color: #888; font-size: 12px; }
  </style>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
</head>
<body>
  <h2>MQTT 监听测试（EMQX）</h2>
  <div class="row">
    <label>WebSocket 地址</label>
    <input id="wsUrl" value="ws://localhost:50006/mqtt" />
    <span class="muted">默认映射 docker: 50006 -> 8083</span>
  </div>
  <div class="row">
    <label>订阅主题</label>
    <input id="topic" value="gateway/data/#" />
  </div>
  <div class="row">
    <button onclick="connectAndSub()">连接并订阅</button>
    <button onclick="clearLog()">清空日志</button>
  </div>
  <div class="row">
    <div id="status" class="muted">未连接</div>
  </div>
  <div id="log"></div>

  <script>
    let client = null;
    function log(line, cls) {
      const el = document.getElementById('log');
      const div = document.createElement('div');
      div.className = cls || '';
      const ts = new Date().toLocaleTimeString();
      div.textContent = `[${ts}] ${line}`;
      el.appendChild(div);
      el.scrollTop = el.scrollHeight;
    }
    function setStatus(text, cls) {
      const s = document.getElementById('status');
      s.textContent = text;
      s.className = cls || 'muted';
    }
    function clearLog() {
      document.getElementById('log').innerHTML = '';
    }
    function connectAndSub() {
      const url = document.getElementById('wsUrl').value.trim();
      const topic = document.getElementById('topic').value.trim() || 'gateway/data/#';
      if (client) { try { client.end(true); } catch(e){} client = null; }
      log(`Connecting to ${url} ...`);
      try {
        client = mqtt.connect(url);
      } catch (e) {
        log(`连接创建失败: ${e}`, 'err');
        return;
      }
      client.on('connect', () => {
        setStatus('已连接', 'ok');
        log('Connected', 'ok');
        client.subscribe(topic, { qos: 0 }, (err) => {
          if (err) { log(`订阅失败: ${err}`, 'err'); }
          else { log(`已订阅: ${topic}`, 'ok'); }
        });
      });
      client.on('message', (t, payload) => {
        try {
          const txt = new TextDecoder().decode(payload);
          log(`消息 [${t}] ${txt}`);
        } catch (e) {
          log(`消息 [${t}] (binary ${payload?.length} bytes)`);
        }
      });
      client.on('reconnect', () => setStatus('重连中 ...'));
      client.on('close', () => setStatus('已断开'));
      client.on('error', (e) => { setStatus('错误', 'err'); log(`错误: ${e}`, 'err'); });
    }
  </script>
</body>
</html>
