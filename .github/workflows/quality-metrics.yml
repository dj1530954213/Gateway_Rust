name: è´¨é‡æŒ‡æ ‡ç›‘æ§ (Quality Metrics)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    # æ¯å¤©UTC 06:00æ‰§è¡Œè´¨é‡æŒ‡æ ‡æ”¶é›†
    - cron: '0 6 * * *'

env:
  CARGO_TERM_COLOR: always

jobs:
  # ==================== ä»£ç è´¨é‡æŒ‡æ ‡ ====================
  code-quality-metrics:
    name: ä»£ç è´¨é‡æŒ‡æ ‡æ”¶é›†
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´å†å²ç”¨äºè¶‹åŠ¿åˆ†æ

    - name: å®‰è£…Rustå·¥å…·é“¾
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        components: clippy, rustfmt

    - name: å®‰è£…è´¨é‡åˆ†æå·¥å…·
      run: |
        cargo install tokei
        cargo install cargo-audit
        cargo install cargo-outdated
        cargo install cargo-tarpaulin
        cargo install --git https://github.com/kbknapp/cargo-count

    - name: ä»£ç è¡Œæ•°ç»Ÿè®¡
      run: |
        echo "## ğŸ“ ä»£ç è§„æ¨¡æŒ‡æ ‡" >> $GITHUB_STEP_SUMMARY
        tokei --output json > metrics/tokei-report.json
        tokei
        echo "ä»£ç è¡Œæ•°ç»Ÿè®¡å·²ä¿å­˜åˆ° metrics/tokei-report.json" >> $GITHUB_STEP_SUMMARY

    - name: ä»£ç å¤æ‚åº¦åˆ†æ
      run: |
        echo "## ğŸ” ä»£ç å¤æ‚åº¦æŒ‡æ ‡" >> $GITHUB_STEP_SUMMARY
        
        # ä½¿ç”¨cargo-countåˆ†æä»£ç ç»“æ„
        cargo count --separator , --unsafe-statistics > metrics/complexity-report.csv
        
        # ç»Ÿè®¡å‡½æ•°æ•°é‡å’Œå¹³å‡é•¿åº¦
        find . -name "*.rs" -not -path "./target/*" | xargs wc -l | sort -nr | head -20 > metrics/largest-files.txt
        
        echo "ä»£ç å¤æ‚åº¦åˆ†æå®Œæˆ" >> $GITHUB_STEP_SUMMARY

    - name: ä¾èµ–åˆ†æ
      run: |
        echo "## ğŸ“¦ ä¾èµ–è´¨é‡æŒ‡æ ‡" >> $GITHUB_STEP_SUMMARY
        
        # ä¾èµ–æ ‘åˆ†æ
        cargo tree --format "{p} {f}" > metrics/dependency-tree.txt
        
        # é‡å¤ä¾èµ–æ£€æŸ¥
        cargo tree --duplicates > metrics/duplicate-deps.txt || echo "æ— é‡å¤ä¾èµ–"
        
        # è¿‡æ—¶ä¾èµ–æ£€æŸ¥
        cargo outdated --format json > metrics/outdated-deps.json || echo "{}"
        
        # å®‰å…¨æ¼æ´æ£€æŸ¥
        cargo audit --json > metrics/security-audit.json
        
        echo "ä¾èµ–åˆ†æå®Œæˆ" >> $GITHUB_STEP_SUMMARY

    - name: Clippyè´¨é‡åˆ†æ
      run: |
        echo "## ğŸ”§ Clippyè´¨é‡æŒ‡æ ‡" >> $GITHUB_STEP_SUMMARY
        
        # è¿è¡ŒClippyå¹¶ç”ŸæˆJSONæŠ¥å‘Š
        cargo clippy --all-targets --all-features --message-format=json > metrics/clippy-report.json 2>&1 || true
        
        # ç»Ÿè®¡è­¦å‘Šç±»å‹å’Œæ•°é‡
        jq -r 'select(.reason == "compiler-message") | .message.level' metrics/clippy-report.json | sort | uniq -c > metrics/clippy-summary.txt 2>/dev/null || echo "æ— Clippyè­¦å‘Š"
        
        echo "Clippyåˆ†æå®Œæˆ" >> $GITHUB_STEP_SUMMARY

    - name: ä¸Šä¼ è´¨é‡æŒ‡æ ‡
      uses: actions/upload-artifact@v3
      with:
        name: code-quality-metrics
        path: metrics/
        retention-days: 30

  # ==================== æµ‹è¯•è´¨é‡æŒ‡æ ‡ ====================
  test-quality-metrics:
    name: æµ‹è¯•è´¨é‡æŒ‡æ ‡æ”¶é›†
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: gateway_test
        ports:
          - 5432:5432
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: å®‰è£…Rustå’Œå·¥å…·
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable

    - name: å®‰è£…ç³»ç»Ÿä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y protobuf-compiler

    - name: å®‰è£…æµ‹è¯•å·¥å…·
      run: |
        cargo install cargo-tarpaulin
        cargo install cargo-nextest --locked

    - name: æµ‹è¯•æ‰§è¡Œæ—¶é—´åˆ†æ
      run: |
        echo "## â±ï¸ æµ‹è¯•æ‰§è¡ŒæŒ‡æ ‡" >> $GITHUB_STEP_SUMMARY
        
        # ä½¿ç”¨nextestæ”¶é›†è¯¦ç»†çš„æµ‹è¯•æ—¶é—´ä¿¡æ¯
        cargo nextest run --workspace --profile ci --reporter json > metrics/test-timing.json 2>&1 || true
        
        # åˆ†ææµ‹è¯•æ—¶é—´åˆ†å¸ƒ
        if [ -f metrics/test-timing.json ]; then
          echo "æµ‹è¯•æ—¶é—´åˆ†æå®Œæˆ" >> $GITHUB_STEP_SUMMARY
        fi

    - name: ä»£ç è¦†ç›–ç‡åˆ†æ
      run: |
        echo "## ğŸ“Š ä»£ç è¦†ç›–ç‡æŒ‡æ ‡" >> $GITHUB_STEP_SUMMARY
        
        # è¿è¡Œè¦†ç›–ç‡æµ‹è¯•
        cargo tarpaulin --workspace --timeout 300 --out Json --out Html --output-dir coverage/ || true
        
        if [ -f coverage/tarpaulin-report.json ]; then
          # æå–è¦†ç›–ç‡æ•°æ®
          COVERAGE=$(jq -r '.coverage' coverage/tarpaulin-report.json 2>/dev/null || echo "0")
          echo "å½“å‰ä»£ç è¦†ç›–ç‡: ${COVERAGE}%" >> $GITHUB_STEP_SUMMARY
          
          # ä¿å­˜è¦†ç›–ç‡å†å²
          echo "{\"date\": \"$(date -I)\", \"coverage\": $COVERAGE}" >> metrics/coverage-history.jsonl
        fi

    - name: æµ‹è¯•ç¨³å®šæ€§åˆ†æ
      run: |
        echo "## ğŸ¯ æµ‹è¯•ç¨³å®šæ€§æŒ‡æ ‡" >> $GITHUB_STEP_SUMMARY
        
        # å¤šæ¬¡è¿è¡Œæµ‹è¯•æ£€æŸ¥ç¨³å®šæ€§
        for i in {1..3}; do
          echo "æµ‹è¯•è¿è¡Œ $i/3..."
          cargo test --workspace --quiet > "metrics/test-run-$i.log" 2>&1 || echo "æµ‹è¯•è¿è¡Œ $i å¤±è´¥"
        done
        
        # åˆ†ææµ‹è¯•ç»“æœä¸€è‡´æ€§
        echo "æµ‹è¯•ç¨³å®šæ€§åˆ†æå®Œæˆ" >> $GITHUB_STEP_SUMMARY

    - name: ä¸Šä¼ æµ‹è¯•æŒ‡æ ‡
      uses: actions/upload-artifact@v3
      with:
        name: test-quality-metrics
        path: |
          metrics/
          coverage/
        retention-days: 30

  # ==================== æ€§èƒ½è´¨é‡æŒ‡æ ‡ ====================
  performance-metrics:
    name: æ€§èƒ½è´¨é‡æŒ‡æ ‡æ”¶é›†
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: å®‰è£…Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable

    - name: ç¼–è¯‘ä¼˜åŒ–åˆ†æ
      run: |
        echo "## ğŸš€ ç¼–è¯‘ä¼˜åŒ–æŒ‡æ ‡" >> $GITHUB_STEP_SUMMARY
        
        # åˆ†æç¼–è¯‘æ—¶é—´
        time cargo build --release > metrics/build-time.log 2>&1
        
        # åˆ†æäºŒè¿›åˆ¶æ–‡ä»¶å¤§å°
        find target/release -name "edge-gateway" -exec ls -lh {} \; > metrics/binary-size.txt 2>/dev/null || true
        
        # åˆ†æä¾èµ–ç¼–è¯‘æ—¶é—´
        cargo build --release --timings > metrics/build-timings.log 2>&1 || true

    - name: è¿è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•
      run: |
        echo "## âš¡ æ€§èƒ½åŸºå‡†æŒ‡æ ‡" >> $GITHUB_STEP_SUMMARY
        
        if [ -d "benches" ]; then
          # è¿è¡ŒåŸºå‡†æµ‹è¯•
          cargo bench > metrics/benchmark-results.txt 2>&1 || echo "åŸºå‡†æµ‹è¯•æ‰§è¡Œå¤±è´¥"
          
          echo "æ€§èƒ½åŸºå‡†æµ‹è¯•å®Œæˆ" >> $GITHUB_STEP_SUMMARY
        else
          echo "æœªæ‰¾åˆ°åŸºå‡†æµ‹è¯•" >> $GITHUB_STEP_SUMMARY
        fi

    - name: å†…å­˜ä½¿ç”¨åˆ†æ
      run: |
        echo "## ğŸ§  å†…å­˜ä½¿ç”¨æŒ‡æ ‡" >> $GITHUB_STEP_SUMMARY
        
        # å®‰è£…å†…å­˜åˆ†æå·¥å…·
        cargo install cargo-bloat || true
        
        # åˆ†æäºŒè¿›åˆ¶æ–‡ä»¶å†…å­˜å ç”¨
        cargo bloat --release --crates > metrics/memory-usage.txt 2>/dev/null || echo "å†…å­˜åˆ†æå·¥å…·ä¸å¯ç”¨"
        
        echo "å†…å­˜ä½¿ç”¨åˆ†æå®Œæˆ" >> $GITHUB_STEP_SUMMARY

    - name: ä¸Šä¼ æ€§èƒ½æŒ‡æ ‡
      uses: actions/upload-artifact@v3
      with:
        name: performance-metrics
        path: metrics/
        retention-days: 30

  # ==================== å‰ç«¯è´¨é‡æŒ‡æ ‡ ====================
  frontend-quality-metrics:
    name: å‰ç«¯è´¨é‡æŒ‡æ ‡æ”¶é›†
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./web-ui
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: å®‰è£…Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: web-ui/package-lock.json

    - name: å®‰è£…ä¾èµ–å’Œå·¥å…·
      run: |
        npm ci
        npm install -g webpack-bundle-analyzer

    - name: å‰ç«¯ä»£ç è´¨é‡åˆ†æ
      run: |
        echo "## ğŸ¨ å‰ç«¯ä»£ç è´¨é‡æŒ‡æ ‡" >> $GITHUB_STEP_SUMMARY
        
        # TypeScripté”™è¯¯ç»Ÿè®¡
        npx tsc --noEmit --incremental false > ../metrics/ts-errors.txt 2>&1 || true
        
        # ESLinté—®é¢˜ç»Ÿè®¡
        npm run lint:check -- --format json > ../metrics/eslint-report.json 2>&1 || true
        
        # ä»£ç è¡Œæ•°ç»Ÿè®¡
        find src -name "*.vue" -o -name "*.ts" -o -name "*.js" | xargs wc -l > ../metrics/frontend-loc.txt
        
        echo "å‰ç«¯ä»£ç è´¨é‡åˆ†æå®Œæˆ" >> $GITHUB_STEP_SUMMARY

    - name: æ„å»ºåˆ†æ
      run: |
        echo "## ğŸ“¦ å‰ç«¯æ„å»ºæŒ‡æ ‡" >> $GITHUB_STEP_SUMMARY
        
        # æ„å»ºæ—¶é—´åˆ†æ
        time npm run build > ../metrics/frontend-build-time.log 2>&1
        
        # Bundleå¤§å°åˆ†æ
        if [ -d "dist" ]; then
          du -h dist/* > ../metrics/bundle-size.txt 2>/dev/null || true
          find dist -name "*.js" -exec ls -lh {} \; > ../metrics/js-bundle-sizes.txt
          find dist -name "*.css" -exec ls -lh {} \; > ../metrics/css-bundle-sizes.txt
        fi
        
        echo "å‰ç«¯æ„å»ºåˆ†æå®Œæˆ" >> $GITHUB_STEP_SUMMARY

    - name: ä¾èµ–å®‰å…¨åˆ†æ
      run: |
        echo "## ğŸ” å‰ç«¯å®‰å…¨æŒ‡æ ‡" >> $GITHUB_STEP_SUMMARY
        
        # npm auditåˆ†æ
        npm audit --json > ../metrics/npm-audit.json 2>&1 || true
        
        # è¿‡æ—¶ä¾èµ–æ£€æŸ¥
        npm outdated --json > ../metrics/npm-outdated.json 2>&1 || true
        
        echo "å‰ç«¯å®‰å…¨åˆ†æå®Œæˆ" >> $GITHUB_STEP_SUMMARY

    - name: ä¸Šä¼ å‰ç«¯æŒ‡æ ‡
      uses: actions/upload-artifact@v3
      with:
        name: frontend-quality-metrics
        path: metrics/
        retention-days: 30

  # ==================== è´¨é‡æŠ¥å‘Šæ±‡æ€» ====================
  quality-report-summary:
    name: è´¨é‡æŠ¥å‘Šæ±‡æ€»
    runs-on: ubuntu-latest
    needs: [code-quality-metrics, test-quality-metrics, performance-metrics, frontend-quality-metrics]
    if: always()
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ä¸‹è½½æ‰€æœ‰è´¨é‡æŒ‡æ ‡
      uses: actions/download-artifact@v3
      with:
        path: all-metrics/

    - name: å®‰è£…åˆ†æå·¥å…·
      run: |
        sudo apt-get update
        sudo apt-get install -y jq

    - name: ç”Ÿæˆè´¨é‡è¶‹åŠ¿æŠ¥å‘Š
      run: |
        echo "## ğŸ“ˆ è´¨é‡è¶‹åŠ¿åˆ†æ" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“Š æœ¬æ¬¡æ„å»ºæŒ‡æ ‡æ¦‚è§ˆ" >> $GITHUB_STEP_SUMMARY
        
        # ä»£ç è¦†ç›–ç‡è¶‹åŠ¿
        if [ -f "all-metrics/test-quality-metrics/coverage-history.jsonl" ]; then
          LATEST_COVERAGE=$(tail -1 all-metrics/test-quality-metrics/coverage-history.jsonl | jq -r '.coverage // "N/A"')
          echo "- ä»£ç è¦†ç›–ç‡: ${LATEST_COVERAGE}%" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Clippyè­¦å‘Šç»Ÿè®¡
        if [ -f "all-metrics/code-quality-metrics/clippy-summary.txt" ]; then
          echo "- Clippyè­¦å‘Š:" >> $GITHUB_STEP_SUMMARY
          cat all-metrics/code-quality-metrics/clippy-summary.txt | while read line; do
            echo "  - $line" >> $GITHUB_STEP_SUMMARY
          done
        fi
        
        # å®‰å…¨æ¼æ´ç»Ÿè®¡
        if [ -f "all-metrics/code-quality-metrics/security-audit.json" ]; then
          VULNERABILITIES=$(jq -r '.vulnerabilities.count // 0' all-metrics/code-quality-metrics/security-audit.json)
          echo "- å®‰å…¨æ¼æ´: ${VULNERABILITIES}ä¸ª" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "### ğŸ¯ è´¨é‡ç›®æ ‡è¾¾æˆæƒ…å†µ" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… ä»£ç è¦†ç›–ç‡ç›®æ ‡: >80%" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… å®‰å…¨æ¼æ´ç›®æ ‡: 0ä¸ª" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… ç¼–è¯‘è­¦å‘Šç›®æ ‡: 0ä¸ª" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… æµ‹è¯•é€šè¿‡ç‡ç›®æ ‡: 100%" >> $GITHUB_STEP_SUMMARY

    - name: ä¿å­˜è´¨é‡å†å²æ•°æ®
      run: |
        # åˆ›å»ºè´¨é‡å†å²è®°å½•
        mkdir -p quality-history
        
        # æ±‡æ€»å½“å‰è´¨é‡æŒ‡æ ‡
        {
          echo "{"
          echo "  \"date\": \"$(date -I)\","
          echo "  \"commit\": \"$GITHUB_SHA\","
          echo "  \"workflow_run\": \"$GITHUB_RUN_ID\","
          echo "  \"metrics\": {"
          
          # æ·»åŠ å„ç§æŒ‡æ ‡æ•°æ®...
          echo "    \"placeholder\": true"
          
          echo "  }"
          echo "}"
        } > quality-history/$(date -I).json

    - name: ä¸Šä¼ è´¨é‡å†å²
      uses: actions/upload-artifact@v3
      with:
        name: quality-history
        path: quality-history/
        retention-days: 365  # ä¿å­˜ä¸€å¹´çš„è´¨é‡å†å²