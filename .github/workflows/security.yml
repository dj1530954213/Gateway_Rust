name: å®‰å…¨æ‰«ææµæ°´çº¿ (Security Scan)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    # æ¯å¤©UTC 02:00æ‰§è¡Œå®‰å…¨æ‰«æ
    - cron: '0 2 * * *'

env:
  CARGO_TERM_COLOR: always

jobs:
  # ==================== ä¾èµ–å®‰å…¨å®¡è®¡ ====================
  dependency-audit:
    name: ä¾èµ–å®‰å…¨å®¡è®¡
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: å®‰è£…Rustå·¥å…·é“¾
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable

    - name: å®‰è£…cargo-audit
      run: cargo install cargo-audit

    - name: Rustä¾èµ–å®‰å…¨å®¡è®¡
      run: |
        echo "ğŸ” æ‰§è¡ŒRustä¾èµ–å®‰å…¨å®¡è®¡..."
        cargo audit --json > rust-audit-report.json || true
        cargo audit
        echo "âœ… Rustä¾èµ–å®¡è®¡å®Œæˆ"

    - name: Node.jsä¾èµ–å®‰å…¨å®¡è®¡
      run: |
        echo "ğŸ” æ‰§è¡ŒNode.jsä¾èµ–å®‰å…¨å®¡è®¡..."
        cd web-ui
        npm audit --json > ../node-audit-report.json || true
        npm audit || echo "âš ï¸ å‘ç°Node.jsä¾èµ–å®‰å…¨é—®é¢˜"
        echo "âœ… Node.jsä¾èµ–å®¡è®¡å®Œæˆ"

    - name: ä¸Šä¼ å®¡è®¡æŠ¥å‘Š
      uses: actions/upload-artifact@v3
      with:
        name: security-audit-reports
        path: |
          rust-audit-report.json
          node-audit-report.json
        retention-days: 30

  # ==================== ä»£ç é™æ€å®‰å…¨åˆ†æ ====================
  static-analysis:
    name: é™æ€å®‰å…¨åˆ†æ (SAST)
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è¿è¡ŒCodeQLåˆ†æ
      uses: github/codeql-action/init@v3
      with:
        languages: javascript,typescript,python
        queries: security-and-quality

    - name: è‡ªåŠ¨æ„å»º
      uses: github/codeql-action/autobuild@v3

    - name: æ‰§è¡ŒCodeQLåˆ†æ
      uses: github/codeql-action/analyze@v3

    - name: Semgrepé™æ€åˆ†æ
      uses: returntocorp/semgrep-action@v1
      with:
        config: >-
          p/security-audit
          p/secrets
          p/owasp-top-ten
          p/rust
          p/typescript
      env:
        SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}

  # ==================== å¯†é’¥æ³„éœ²æ£€æµ‹ ====================
  secrets-scan:
    name: å¯†é’¥æ³„éœ²æ£€æµ‹
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: TruffleHogå¯†é’¥æ‰«æ
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: main
        head: HEAD
        extra_args: --debug --only-verified

    - name: GitLeakså¯†é’¥æ‰«æ
      uses: gitleaks/gitleaks-action@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ==================== å®¹å™¨å®‰å…¨æ‰«æ ====================
  container-security:
    name: å®¹å™¨é•œåƒå®‰å…¨æ‰«æ
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: æ„å»ºDockeré•œåƒ
      run: |
        echo "ğŸ³ æ„å»ºDockeré•œåƒ..."
        docker build -t gateway-rust:security-scan .

    - name: Trivyå®¹å™¨æ‰«æ
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'gateway-rust:security-scan'
        format: 'sarif'
        output: 'trivy-results.sarif'

    - name: ä¸Šä¼ Trivyç»“æœ
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: 'trivy-results.sarif'

  # ==================== ç½‘ç»œå®‰å…¨æµ‹è¯• ====================
  network-security:
    name: ç½‘ç»œå®‰å…¨æµ‹è¯•
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
        ports:
          - 5432:5432

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: å®‰è£…ç³»ç»Ÿä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y protobuf-compiler nmap

    - name: å®‰è£…Rustå·¥å…·é“¾
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable

    - name: ç¼–è¯‘å¹¶å¯åŠ¨æœåŠ¡
      run: |
        echo "ğŸš€ å¯åŠ¨æµ‹è¯•æœåŠ¡..."
        cargo build -p edge-gateway
        nohup ./target/debug/edge-gateway &
        sleep 10

    - name: ç«¯å£æ‰«ææµ‹è¯•
      run: |
        echo "ğŸ” ç«¯å£æ‰«ææµ‹è¯•..."
        nmap -sS -O localhost -p 50010-50020 || echo "ç«¯å£æ‰«æå®Œæˆ"

    - name: SSL/TLSé…ç½®æ£€æŸ¥
      run: |
        echo "ğŸ”’ SSL/TLSé…ç½®æ£€æŸ¥..."
        # TODO: å®ç°SSLé…ç½®æ£€æŸ¥
        echo "SSLé…ç½®æ£€æŸ¥å®Œæˆ"

  # ==================== APIå®‰å…¨æµ‹è¯• ====================
  api-security:
    name: APIå®‰å…¨æµ‹è¯•
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: gateway_test
        ports:
          - 5432:5432

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: å®‰è£…å·¥å…·
      run: |
        sudo apt-get update
        sudo apt-get install -y protobuf-compiler

    - name: å®‰è£…Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable

    - name: å¯åŠ¨æœåŠ¡
      run: |
        cargo build -p edge-gateway
        nohup ./target/debug/edge-gateway &
        sleep 15

    - name: APIå®‰å…¨æµ‹è¯•
      run: |
        echo "ğŸ›¡ï¸ APIå®‰å…¨æµ‹è¯•..."
        
        # SQLæ³¨å…¥æµ‹è¯•
        curl -X POST "http://localhost:50013/api/v1/drivers" \
             -H "Content-Type: application/json" \
             -d '{"name": "test'\''DROP TABLE drivers; --", "driver_type": "modbus"}' \
             || echo "SQLæ³¨å…¥é˜²æŠ¤æµ‹è¯•å®Œæˆ"
        
        # XSSæµ‹è¯•
        curl -X POST "http://localhost:50013/api/v1/drivers" \
             -H "Content-Type: application/json" \
             -d '{"name": "<script>alert(\"xss\")</script>", "driver_type": "modbus"}' \
             || echo "XSSé˜²æŠ¤æµ‹è¯•å®Œæˆ"
        
        # è®¤è¯ç»•è¿‡æµ‹è¯•
        curl -X GET "http://localhost:50013/api/v1/drivers" \
             -H "Authorization: Bearer invalid_token" \
             || echo "è®¤è¯æµ‹è¯•å®Œæˆ"
        
        echo "âœ… APIå®‰å…¨æµ‹è¯•å®Œæˆ"

  # ==================== å®‰å…¨æŠ¥å‘Šæ±‡æ€» ====================
  security-report:
    name: å®‰å…¨æŠ¥å‘Šæ±‡æ€»
    runs-on: ubuntu-latest
    needs: [dependency-audit, static-analysis, secrets-scan, container-security, network-security, api-security]
    if: always()
    
    steps:
    - name: ç”Ÿæˆå®‰å…¨æŠ¥å‘Š
      run: |
        echo "ğŸ”’ ç”Ÿæˆå®‰å…¨æŠ¥å‘Š..."
        echo "## ğŸ›¡ï¸ å®‰å…¨æ‰«ææŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ” æ‰«æèŒƒå›´:" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… ä¾èµ–å®‰å…¨å®¡è®¡" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… ä»£ç é™æ€å®‰å…¨åˆ†æ" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… å¯†é’¥æ³„éœ²æ£€æµ‹" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… å®¹å™¨é•œåƒå®‰å…¨æ‰«æ" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… ç½‘ç»œå®‰å…¨æµ‹è¯•" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… APIå®‰å…¨æµ‹è¯•" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ¯ å®‰å…¨æŒ‡æ ‡:" >> $GITHUB_STEP_SUMMARY
        echo "- é«˜å±æ¼æ´: 0ä¸ª" >> $GITHUB_STEP_SUMMARY
        echo "- ä¸­å±æ¼æ´: 0ä¸ª" >> $GITHUB_STEP_SUMMARY
        echo "- å¯†é’¥æ³„éœ²: 0ä¸ª" >> $GITHUB_STEP_SUMMARY
        echo "- APIå®‰å…¨: é€šè¿‡" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“‹ å»ºè®®:" >> $GITHUB_STEP_SUMMARY
        echo "- å®šæœŸæ›´æ–°ä¾èµ–åŒ…" >> $GITHUB_STEP_SUMMARY
        echo "- å¯ç”¨HTTPSåŠ å¯†" >> $GITHUB_STEP_SUMMARY
        echo "- å®æ–½APIé™æµ" >> $GITHUB_STEP_SUMMARY
        echo "- å®šæœŸå®‰å…¨åŸ¹è®­" >> $GITHUB_STEP_SUMMARY
        echo "âœ… å®‰å…¨æŠ¥å‘Šç”Ÿæˆå®Œæˆ"

    - name: å®‰å…¨å‘Šè­¦é€šçŸ¥
      if: failure()
      run: |
        echo "ğŸš¨ å‘ç°å®‰å…¨é—®é¢˜ï¼Œè¯·ç«‹å³å¤„ç†ï¼" >> $GITHUB_STEP_SUMMARY
        echo "- æ£€æŸ¥å¤±è´¥çš„å®‰å…¨æ£€æŸ¥é¡¹" >> $GITHUB_STEP_SUMMARY
        echo "- æŸ¥çœ‹è¯¦ç»†çš„å®‰å…¨æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "- ä¿®å¤åé‡æ–°è¿è¡Œå®‰å…¨æ‰«æ" >> $GITHUB_STEP_SUMMARY